var KT;(()=>{"use strict";var t={d:(e,o)=>{for(var n in o)t.o(o,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:o[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{KinematicsAnimationGroup:()=>vt,KinematicsComponent:()=>f,KinematicsHierachy:()=>yt,KinematicsManager:()=>bt,componentType:()=>C});class o{static nearestPointOnLine(t,e,o){e.normalize();var n=Communicator.Point3.subtract(o,t),i=Communicator.Point3.dot(n,e),r=Communicator.Point3.add(t,Communicator.Point3.scale(e,i));return Communicator.Point3.subtract(r,o),r}static closestPointOnPlane(t,e){let o=Communicator.Point3.dot(t.normal,e)+t.d;return Communicator.Point3.subtract(e,new Communicator.Point3(o*t.normal.x,o*t.normal.y,o*t.normal.z))}static signedAngle(t,e,o){return Math.atan2(Communicator.Point3.dot(Communicator.Point3.cross(t,e),o),Communicator.Point3.dot(t,e))*(180/Math.PI)}static ComputeVectorToVectorRotationMatrix(t,e){const o=1e-7;t.normalize(),e.normalize();let n=Communicator.Point3.cross(t,e),i=Communicator.Point3.dot(t,e),r=n.length();if(r>-1e-7&&r<o){if(!(i<0))return new Communicator.Matrix;if(t.x<-1e-7||t.x>o)n.x=t.y,n.y=-t.x,n.z=0;else if(t.y<-1e-7||t.y>o)n.x=-t.y,n.y=t.x,n.z=0;else{if(!(t.z<-1e-7||t.z>o))return new Communicator.Matrix;n.x=-t.z,n.z=t.x,n.y=0}}var a=Math.atan2(r,i);return a*=180/Math.PI,Communicator.Matrix.createFromOffAxisRotation(n,a)}static generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}static computeOffaxisRotationMatrix(t,e,o){let n=new Communicator.Matrix,i=new Communicator.Matrix;i=new Communicator.Matrix,i.setTranslationComponent(-t.x,-t.y,-t.z);let r=new Communicator.Matrix;r.setTranslationComponent(t.x,t.y,t.z),Communicator.Util.computeOffaxisRotation(e,o,n);let a=Communicator.Matrix.multiply(i,n);return Communicator.Matrix.multiply(a,r)}static circleIntersection(t,e,o,n,i,r){let a,s,l,m,h,c,p,u,_;if(s=n-t,l=i-e,m=Math.sqrt(l*l+s*s),m>o+r)return!1;if(m<Math.abs(o-r))return!1;a=(o*o-r*r+m*m)/(2*m),u=t+s*a/m,_=e+l*a/m,h=Math.sqrt(o*o-a*a),c=h/m*-l,p=s*(h/m);let d=u+c,g=u-c,x=_+p,C=_-p;return{p1:new Communicator.Point3(d,x,0),p2:new Communicator.Point3(g,C,0)}}static circleLineIntersection(t,e,o,n,i,r,a){let s=null,l=null,m=null,h=null,c=i-a,p=r-n,u=n*a-i*r;if(0==p){let n=-2*o,i=n*n-4*(e*e+o*o+2*e*u/c+u*u/(c*c)-t*t);if(i<0)return;s=-u/c,l=(-n+Math.sqrt(i))/2,i>0&&(m=s,h=(-n-Math.sqrt(i))/2)}else{let n=c*c/(p*p)+1,i=2*(c*u/(p*p)-e+c*o/p),r=i*i-4*n*(e*e+o*o+2*o*u/p+u*u/(p*p)-t*t);if(r<0)return;s=(-i+Math.sqrt(r))/(2*n),l=-c/p*s-u/p,r>0&&(m=(-i-Math.sqrt(r))/(2*n),h=-c/p*m-u/p)}return{x1:s,y1:l,x2:m,y2:h}}}class n{constructor(){this._wheels=[],this._poslookup=[],this._baseNode=null,this._nodeids=[],this._segmentnum=500,this._width=10,this._thickness=10,this._gap=.1,this._tracks=0,this._alignvector=null,this._trackorientation=!1,this._color1=new Communicator.Color(64,64,64),this._color2=new Communicator.Color(20,20,20)}getBaseNode(){return this._baseNode}getWidth(){return this._width}setWidth(t){this._width=t}setSegmentNum(t){this._segmentnum=t}getSegmentNum(){return this._segmentnum}setThickness(t){this._thickness=t}getThickness(){return this._thickness}setGap(t){this._gap=t}getGap(){return this._gap}setTracks(t){this._tracks=t}getTracks(){return this._tracks}setTrackOrientation(t){this._trackorientation=t}getTrackOrientation(){return this._trackorientation}setAlignVector(t){this._alignvector=t}getAlignVector(){return this._alignvector}setColor1(t){this._color1=t}getColor1(){return this._color1}setColor2(t){this._color2=t}getColor2(){return this._color2}getWheelByIndex(){return this._wheels[i]}getWheels(){return this._wheels}initializeWheels(){this.calcuateAlignMatrix();for(let t=0;t<this._wheels.length;t++){let e=this._wheels[t],o=this.alignmatrix.transform(e.component.getCenter());e.pos=new Communicator.Point3(o.x,o.y,0)}}addWheel(){this._wheels.push({pos:null,radius:0,component:null,inner:!1,other:!1})}insertWheel(t){this_wheels.splice(t,0,{pos:null,radius:0,component:null,inner:!1,other:!1})}deleteWheel(t){this_wheels.splice(t,1)}toJson(){let t={alignvector:this._alignvector?this._alignvector.toJson():null,wheels:[],segmentnum:this._segmentnum,width:this._width,thickness:this._thickness,gap:this._gap,tracks:this._tracks,trackorientation:this._trackorientation,color1:this._color1.toJson(),color2:this._color2.toJson()};for(let e=0;e<this._wheels.length;e++)t.wheels.push({radius:this._wheels[e].radius,component:this._wheels[e].component.getId(),inner:this._wheels[e].inner,other:this._wheels[e].other});return t}fromJson(t,e){this._segmentnum=t.segmentnum,t.width&&(this._width=t.width),t.thickness&&(this._thickness=t.thickness),t.color1&&(this._color1=Communicator.Color.fromJson(t.color1)),t.alignvector&&(this._alignvector=Communicator.Point3.fromJson(t.alignvector)),t.color2&&(this._color2=Communicator.Color.fromJson(t.color2)),this._gap=t.gap,this._tracks=t.tracks,t.trackorientation&&(this._trackorientation=t.trackorientation);for(let o=0;o<t.wheels.length;o++)this._wheels.push({pos:null,radius:t.wheels[o].radius,component:e.getHierachy().getComponentHash()[t.wheels[o].component],inner:t.wheels[o].inner,other:t.wheels[o].other});return t}calcuateAlignMatrix(){let t;this._wheels.length>2&&!this._alignvector?(t=Communicator.Plane.createFromPoints(this._wheels[0].component.getCenter(),this._wheels[1].component.getCenter(),this._wheels[2].component.getCenter()),this.alignmatrix=o.ComputeVectorToVectorRotationMatrix(t.normal,new Communicator.Point3(0,0,1))):this._alignvector?this.alignmatrix=o.ComputeVectorToVectorRotationMatrix(this._alignvector,new Communicator.Point3(0,0,1)):this.alignmatrix=o.ComputeVectorToVectorRotationMatrix(new Communicator.Point3(1,0,0),new Communicator.Point3(0,0,1));let e=this.alignmatrix.transform(this._wheels[0].component.getCenter()),n=new Communicator.Matrix;n.setTranslationComponent(0,0,-e.z),this.alignmatrix=Communicator.Matrix.multiply(this.alignmatrix,n)}addBoxMesh(t,e,o,n){let i=[t.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,e.z,e.x,e.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,e.x,e.y,t.z,t.x,e.y,t.z,t.x,t.y,t.z,e.x,e.y,t.z,t.x,t.y,t.z,e.x,t.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,t.x,e.y,t.z,e.x,e.y,e.z,t.x,e.y,e.z,t.x,t.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,e.z,e.x,t.y,e.z,t.x,e.y,t.z,t.x,e.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,t.y,e.z,t.x,t.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,e.y,e.z,e.x,t.y,t.z,e.x,t.y,e.z],r=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0];for(let t=0;t<i.length;t++)o.push(i[t]);for(let t=0;t<r.length;t++)n.push(r[t])}async createMesh(t,e,o){let n=new Communicator.MeshData;n.setFaceWinding(Communicator.FaceWinding.Clockwise);let i=[],r=[];if(0==o)this.addBoxMesh(new Communicator.Point3(-e.x,-e.y,-e.z),new Communicator.Point3(e.x,e.y,e.z),i,r);else{this._trackorientation?this.addBoxMesh(new Communicator.Point3(-e.x,0,-e.z),new Communicator.Point3(e.x,e.y,e.z),i,r):this.addBoxMesh(new Communicator.Point3(-e.x,-e.y,-e.z),new Communicator.Point3(e.x,0,e.z),i,r);let t=2*e.x/(3*o),n=-e.x+t/2;for(let a=0;a<o;a++)this._trackorientation?this.addBoxMesh(new Communicator.Point3(n,-e.y,-e.z),new Communicator.Point3(n+2*t,0,e.z),i,r):this.addBoxMesh(new Communicator.Point3(n,0,-e.z),new Communicator.Point3(n+2*t,e.y,e.z),i,r),n+=2*t+t}return n.addFaces(i,r),await t.model.createMesh(n)}findCircleTangents(t,e){let o=t.pos.x,n=t.pos.y,i=e.pos.x,r=e.pos.y,a=t.radius,s=e.radius+1e-6,l=(i*a-o*s)/(a-s),m=(r*a-n*s)/(a-s),h=(Math.pow(a,2)*(l-o)+a*(m-n)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-n,2)-Math.pow(a,2)))/(Math.pow(l-o,2)+Math.pow(m-n,2))+o,c=(Math.pow(a,2)*(l-o)-a*(m-n)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-n,2)-Math.pow(a,2)))/(Math.pow(l-o,2)+Math.pow(m-n,2))+o,p=(Math.pow(a,2)*(m-n)-a*(l-o)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-n,2)-Math.pow(a,2)))/(Math.pow(l-o,2)+Math.pow(m-n,2))+n,u=(Math.pow(a,2)*(m-n)+a*(l-o)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-n,2)-Math.pow(a,2)))/(Math.pow(l-o,2)+Math.pow(m-n,2))+n,_=(Math.pow(s,2)*(l-i)+s*(m-r)*Math.sqrt(Math.pow(l-i,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(m-r,2))+i,d=(Math.pow(s,2)*(l-i)-s*(m-r)*Math.sqrt(Math.pow(l-i,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(m-r,2))+i,g=(Math.pow(s,2)*(m-r)-s*(l-i)*Math.sqrt(Math.pow(l-i,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(m-r,2))+r,x=(Math.pow(s,2)*(m-r)+s*(l-i)*Math.sqrt(Math.pow(l-i,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(m-r,2))+r;return{xt1:new Communicator.Point3(h,p,0),xt2:new Communicator.Point3(c,u,0),xt3:new Communicator.Point3(_,g,0),xt4:new Communicator.Point3(d,x,0)}}findCircleInnerTangents(t,e){let o=t.pos.x,n=t.pos.y,i=e.pos.x,r=e.pos.y,a=t.radius,s=e.radius+1e-6,l=(i*a+o*s)/(a+s),m=(r*a+n*s)/(a+s),h=(Math.pow(a,2)*(l-o)+a*(m-n)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-n,2)-Math.pow(a,2)))/(Math.pow(l-o,2)+Math.pow(m-n,2))+o,c=(Math.pow(a,2)*(l-o)-a*(m-n)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-n,2)-Math.pow(a,2)))/(Math.pow(l-o,2)+Math.pow(m-n,2))+o,p=(Math.pow(a,2)*(m-n)-a*(l-o)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-n,2)-Math.pow(a,2)))/(Math.pow(l-o,2)+Math.pow(m-n,2))+n,u=(Math.pow(a,2)*(m-n)+a*(l-o)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-n,2)-Math.pow(a,2)))/(Math.pow(l-o,2)+Math.pow(m-n,2))+n,_=(Math.pow(s,2)*(l-i)+s*(m-r)*Math.sqrt(Math.pow(l-i,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(m-r,2))+i,d=(Math.pow(s,2)*(l-i)-s*(m-r)*Math.sqrt(Math.pow(l-i,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(m-r,2))+i,g=(Math.pow(s,2)*(m-r)-s*(l-i)*Math.sqrt(Math.pow(l-i,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(m-r,2))+r,x=(Math.pow(s,2)*(m-r)+s*(l-i)*Math.sqrt(Math.pow(l-i,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-i,2)+Math.pow(m-r,2))+r;return{xt1:new Communicator.Point3(h,p,0),xt2:new Communicator.Point3(c,u,0),xt3:new Communicator.Point3(_,g,0),xt4:new Communicator.Point3(d,x,0)}}async initialize(){this.initializeWheels();for(let t=0;t<this._wheels.length;t++){let e,o=t==this._wheels.length-1?0:t+1;this._wheels[t].inner?(e=this.findCircleInnerTangents(this._wheels[t],this._wheels[o]),this._wheels[t].other?(this._wheels[t].exitpos=e.xt2.copy(),this._wheels[o].enterpos=e.xt4.copy()):(this._wheels[t].exitpos=e.xt1.copy(),this._wheels[o].enterpos=e.xt3.copy())):(e=this.findCircleTangents(this._wheels[t],this._wheels[o]),this._wheels[t].other?(this._wheels[t].exitpos=e.xt2.copy(),this._wheels[o].enterpos=e.xt4.copy()):(this._wheels[t].exitpos=e.xt1.copy(),this._wheels[o].enterpos=e.xt3.copy()))}for(let t=0;t<this._wheels.length;t++)this._wheels[t].rotation=this.calculateWheelRotation(t);this.calculateTotalLength();let t=0;this._poslookup=[];for(let e=0;e<1e4;e++){t+=1e-4;let e=new Communicator.Matrix,o=this.computePositionOnBelt(t);e.setTranslationComponent(o.pos.x,o.pos.y,o.pos.z);let n=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(new Communicator.Point3(0,0,1),o.angle,n);let i=Communicator.Matrix.multiply(n,e);this._poslookup.push(i)}let e=this._totalLength/this._segmentnum,o=await this.createMesh(bt.viewer,new Communicator.Point3(e/2-e*this._gap+1e-4,this._thickness,this._width),this._tracks),n=new Communicator.MeshInstanceData(o);this._baseNode&&await bt.viewer.model.deleteNode(this._baseNode),this._baseNode=bt.viewer.model.createNode(bt.viewer.model.getRootNode()),this.adjustnode=bt.viewer.model.createNode(this._baseNode),this._nodeids=[];for(let t=0;t<this._segmentnum;t++)this._nodeids[t]=await bt.viewer.model.createMeshInstance(n,this.adjustnode),t%2?bt.viewer.model.setNodesFaceColor([this._nodeids[t]],this._color1):bt.viewer.model.setNodesFaceColor([this._nodeids[t]],this._color2);bt.viewer.model.setMetallicRoughness([this._baseNode],.2,.6),bt.viewer.model.setNodeMatrix(this.adjustnode,Communicator.Matrix.inverse(this.alignmatrix)),this.move(0)}calculateTotalLength(){this._totalLength=0;for(let t=0;t<this._wheels.length;t++){0==t&&this._wheels.length;let e=t==this._wheels.length-1?0:t+1,o=this._wheels[t];this._totalLength+=this.calculateCircumference(o.radius,o.rotation.steps),this._totalLength+=Communicator.Point3.subtract(o.exitpos,this._wheels[e].enterpos).length()}}computePositionOnBelt(t){let e=this._totalLength*t,n=0,i=0,r=Communicator.Point3.subtract(this._wheels[0].enterpos,this._wheels[this._wheels.length-1].exitpos).normalize();i=o.signedAngle(r,new Communicator.Point3(-1,0,0),new Communicator.Point3(0,0,-1));for(let t=0;t<this._wheels.length;t++){let o=t==this._wheels.length-1?0:t+1,r=this._wheels[t],a=this.calculateCircumference(r.radius,r.rotation.steps),s=Communicator.Point3.subtract(r.exitpos,this._wheels[o].enterpos).length();if(!(n+a<e)){let o=(e-n)/a*r.rotation.steps;return i+=Math.sign(r.rotation.angle)*o,{pos:this.wheelRotation(this._wheels[t],this._wheels[t].enterpos,Math.sign(r.rotation.angle)*o),angle:i}}if(n+=a,i+=Math.sign(r.rotation.angle)*r.rotation.steps,!(n+s<e)){let a=e-n,s=Communicator.Point3.subtract(this._wheels[o].enterpos,r.exitpos).normalize();return{pos:Communicator.Point3.add(this._wheels[t].exitpos,Communicator.Point3.scale(s,a)),angle:i}}n+=s}}calculateWheelRotation(t){let e=0==t?this._wheels.length-1:t-1,n=(this._wheels.length,this._wheels[t]),i=Communicator.Point3.subtract(n.enterpos,n.pos).normalize(),r=Communicator.Point3.subtract(n.exitpos,n.pos).normalize(),a=o.signedAngle(i,r,new Communicator.Point3(0,0,1)),s=Communicator.Point3.subtract(n.enterpos,this._wheels[e].exitpos).length(),l=this.wheelRotation(n,n.enterpos,2*Math.sign(a)),m=Communicator.Point3.subtract(l,this._wheels[e].exitpos).length(),h=Math.abs(a);return m<s&&(h=360-Math.abs(a),a=-a),{steps:h,angle:a}}wheelRotation(t,e,o){let n=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(new Communicator.Point3(0,0,1),o,n);let i=new Communicator.Matrix;i.setTranslationComponent(-t.pos.x,-t.pos.y,0);let r=new Communicator.Matrix;r.setTranslationComponent(t.pos.x,t.pos.y,0);let a=Communicator.Matrix.multiply(i,n);return Communicator.Matrix.multiply(a,r).transform(e)}async move(t){let e=this._totalLength/this._segmentnum;for(let o=0;o<this._segmentnum;o++)this.moveInternal(t+o*e,this._nodeids[o])}async moveInternal(t,e){let o=t%this._totalLength;o<0&&(o=this._totalLength+o);let n=Math.floor(o/this._totalLength*this._poslookup.length);bt.viewer.model.setNodeMatrix(e,this._poslookup[n])}animate(){let t=this;setInterval((function(){t.move(mover),mover+=.2}),10)}calculateCircumference(t,e){return e/360*2*Math.PI*t}calculateCircumferenceAngle(t,e){return e/(2*Math.PI*t)*360}}class r{constructor(t){this._component=t,this._type=C.revolute,this._fixedAxis=null,this._fixedAxisTarget=null}getType(){return this._type}setFixedAxis(t){this._fixedAxis=t}setFixedAxisTarget(t){this._fixedAxisTarget=t}getFixedAxis(){return this._fixedAxis}setFixedAxisFromMatrix(t){let e=bt.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);if(bt.getHandleOperator().getPosition()){if(!bt.getHandleOperator().getSecondAxis())return;let o=Communicator.Point3.add(e.getPosition(),bt.getHandleOperator().getSecondAxis());t.transform(e.getPosition()),o=t.transform(o),this._fixedAxis=Communicator.Point3.subtract(o,this.center).normalize(),this._fixedAxisTarget=new Communicator.Point3(0,-1,0)}}async fromJson(t,e){if(t.fixedAxis){if(null==e){let e=Communicator.Point3.fromJson(t.fixedAxis);this._fixedAxis=Communicator.Point3.subtract(e,this._component._center).normalize()}else this._fixedAxis=Communicator.Point3.fromJson(t.fixedAxis);this._fixedAxisTarget=Communicator.Point3.fromJson(t.fixedAxisTarget)}}jsonFixup(){}toJson(t){this._fixedAxis&&(t.fixedAxis=this._fixedAxis.toJson(),t.fixedAxisTarget=this._fixedAxisTarget.toJson())}getCurrentValue(){return this._component._currentAngle}set(t){this._component._rotate(t)}getMovementType(){return C.revolute}async execute(){let t=this._component;if(this._fixedAxis){let e=t.transformlocalPointToWorldSpace(t._center),n=t.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,this._fixedAxis)),i=Communicator.Point3.subtract(n,e).normalize(),r=this._fixedAxisTarget,a=t.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),s=Communicator.Point3.subtract(a,e).normalize(),l=Communicator.Plane.createFromPointAndNormal(e,s),m=(l.distanceToPoint(new Communicator.Point3.add(e,r)),o.closestPointOnPlane(l,new Communicator.Point3.add(e,r)));r=new Communicator.Point3.subtract(m,e).normalize();let h=Communicator.Util.computeAngleBetweenVector(i,r);await t._rotate(h,!0,!0),e=t.transformlocalPointToWorldSpace(t._center),n=t.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,this._fixedAxis));let c=Communicator.Point3.subtract(n,e).normalize();Communicator.Point3.subtract(c,r).length()>.001&&await t._rotate(2*-h,!0,!0)}}}class a{constructor(t){this._component=t,this._type=C.prismatic}getType(){return this._type}async fromJson(t,e){}toJson(t){}jsonFixup(){}getCurrentValue(){return this._component._currentPosition}set(t){this._component._translate(t)}getMovementType(){return C.prismatic}async execute(){}}class s{constructor(t){this._component=t,this._type=C.pistonController,this._extraComponent1=null}getType(){return this._type}async fromJson(t,e){this._extraComponent1=t.extraComponent1}jsonFixup(){this._extraComponent1=this._component.getHierachy().getComponentHash()[this._extraComponent1]}toJson(t){t.extraComponent1=this._extraComponent1._id}getCurrentValue(){}set(t){}getMovementType(){return C.fixed}async execute(){let t=this._component,e=t._parent.transformlocalPointToWorldSpace(t._center),n=t._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),i=this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraComponent1._center),r=this._extraComponent1._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(this._extraComponent1._center,this._extraComponent1._axis)),a=Communicator.Point3.subtract(r,i).normalize(),s=o.nearestPointOnLine(i,a,e),l=Communicator.Point3.subtract(s,e).length(),m=Communicator.Point3.subtract(this._extraComponent1._center,t._center).length(),h=Math.sqrt(m*m-l*l),c=Math.asin(h/m)*(180/Math.PI),p=new Communicator.Matrix,u=new Communicator.Matrix,_=Communicator.Point3.subtract(n,e).normalize();u=new Communicator.Matrix,u.setTranslationComponent(-e.x,-e.y,-e.z);let d=new Communicator.Matrix;d.setTranslationComponent(e.x,e.y,e.z),Communicator.Util.computeOffaxisRotation(_,-c,p);let g=Communicator.Matrix.multiply(u,p),x=Communicator.Matrix.multiply(g,d),C=Communicator.Point3.subtract(s,e).normalize();C.scale(h);let f=Communicator.Point3.add(e,C),P=x.transform(f);p=new Communicator.Matrix,Communicator.Util.computeOffaxisRotation(_,c,p),g=Communicator.Matrix.multiply(u,p),x=Communicator.Matrix.multiply(g,d),C=Communicator.Point3.subtract(s,e).normalize(),C.scale(h),f=Communicator.Point3.add(e,C);let v=x.transform(f),w=this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraComponent1._center),y=Communicator.Point3.subtract(P,w).length();Communicator.Point3.subtract(v,w).length()<y&&(P=v);let M=t._parent.transformlocalPointToWorldSpace(this._extraComponent1._center),T=Communicator.Point3.subtract(M,e).normalize(),b=Communicator.Point3.subtract(P,e).normalize(),N=Communicator.Util.computeAngleBetweenVector(T,b);await t._rotate(-N),M=t.transformlocalPointToWorldSpace(this._extraComponent1._center);let S=Communicator.Point3.subtract(M,P).length();await t._rotate(N),M=t.transformlocalPointToWorldSpace(this._extraComponent1._center),Communicator.Point3.subtract(M,P).length()>S&&await t._rotate(-N);let A=Communicator.Point3.subtract(this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraComponent1._center),t.transformlocalPointToWorldSpace(this._extraComponent1._center)).length();await this._extraComponent1._translate(-A);let H=Communicator.Point3.subtract(this._extraComponent1.transformlocalPointToWorldSpace(this._extraComponent1._center),t.transformlocalPointToWorldSpace(this._extraComponent1._center)).length();await this._extraComponent1._translate(A),Communicator.Point3.subtract(this._extraComponent1.transformlocalPointToWorldSpace(this._extraComponent1._center),t.transformlocalPointToWorldSpace(this._extraComponent1._center)).length()>H&&await this._extraComponent1._translate(-A)}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}adjustExtraComponentToPistonController(){let t=this._component,e=t._axis,n=Communicator.Plane.createFromPointAndNormal(t._center,e),i=o.closestPointOnPlane(n,this._extraComponent1._center);this._extraComponent1._axis=this._extraComponent1._axis.copy(),this._extraComponent1._center=i}}class l{constructor(t){this._component=t,this._type=C.fixed}getType(){return this._type}async fromJson(t,e){}toJson(t){}jsonFixup(){}getMovementType(){return C.fixed}getCurrentValue(){}set(t){}async execute(){}}class m{constructor(t){this._component=t,this._type=C.target}getType(){return this._type}async fromJson(t,e){}toJson(t){}jsonFixup(){}getCurrentValue(){}set(t){}getMovementType(){return C.fixed}async execute(){}}class h{constructor(t){this._component=t,this._type=C.pivotConnector,this._extraComponent1=null,this._extraPivot1=null,this._isSlidePivot=!1,this._targetPivot=null}getType(){return this._type}async fromJson(t,e){t.extraComponent1&&(this._extraComponent1=t.extraComponent1),t.extraPivot1&&(this._extraPivot1=Communicator.Point3.fromJson(t.extraPivot1)),this._isSlidePivot=t.isSlidePivot}jsonFixup(){this._extraComponent1&&(this._extraComponent1=this._component.getHierachy().getComponentHash()[this._extraComponent1])}toJson(t){this._extraComponent1&&(t.extraComponent1=this._extraComponent1._id),this._extraPivot1&&(t.extraPivot1=this._extraPivot1.toJson()),t.isSlidePivot=this._isSlidePivot}getCurrentValue(){return this._isSlidePivot?this._component._currentPosition:this._component._currentAngle}set(t){this._isSlidePivot?this._component._translate(t):this._component._rotate(t)}getMovementType(){return this._isSlidePivot?C.prismatic:C.revolute}setExtraPivot1(t){this._extraPivot1=t}getExtraPivot1(){return this._extraPivot1}_calculatePivotConnectorRotation(t,e){let n=t._parent.transformlocalPointToWorldSpace(t._behavior._extraPivot1),i=t.transformlocalPointToWorldSpace(t._center),r=t._parent.transformlocalPointToWorldSpace(e),a=t.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),s=Communicator.Point3.subtract(a,i).normalize(),l=Communicator.Plane.createFromPointAndNormal(r,s);i=o.closestPointOnPlane(l,i),r=o.closestPointOnPlane(l,r),n=o.closestPointOnPlane(l,n);let m=Communicator.Point3.subtract(r,i).normalize(),h=Communicator.Point3.subtract(n,i).normalize(),c=Communicator.Util.computeAngleBetweenVector(m,h);var p=t._calculateAngleRotMatrix(c);let u=t.transformlocalPointToWorldSpaceWithMatrix(t._behavior._extraPivot1,p);u=o.closestPointOnPlane(l,u);let _=Communicator.Point3.subtract(u,r).length();return p=t._calculateAngleRotMatrix(-c),u=t.transformlocalPointToWorldSpaceWithMatrix(t._behavior._extraPivot1,p),u=o.closestPointOnPlane(l,u),Communicator.Point3.subtract(u,r).length()>_?c:-c}async execute(){let t=this._component;if(this._extraComponent1)if(t._touched)if(this._isSlidePivot){let n=this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraComponent1._behavior._extraPivot1),i=this._extraComponent1.transformlocalPointToWorldSpace(this._extraComponent1._behavior._extraPivot1),r=this._extraComponent1._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(this._extraComponent1._behavior._extraPivot1,this._extraComponent1._axis)),a=this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraComponent1._center),s=t._parent.transformlocalPointToWorldSpace(t._center),l=t._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),m=t.transformlocalPointToWorldSpace(this._extraComponent1._behavior._extraPivot1);l=Communicator.Point3.subtract(l,s).normalize(),r=Communicator.Point3.subtract(r,n).normalize();let h=Communicator.Plane.createFromPointAndNormal(n,r);s=o.closestPointOnPlane(h,s),a=o.closestPointOnPlane(h,a);let c=o.ComputeVectorToVectorRotationMatrix(r,new Communicator.Point3(0,0,1)),p=Communicator.Matrix.inverse(c),u=c.transform(s),_=c.transform(m),d=c.transform(a),g=c.transform(n),x=Communicator.Point3.subtract(_,u).length(),C=Communicator.Point3.subtract(g,d).length(),f=o.circleIntersection(u.x,u.y,x,d.x,d.y,C);f.p1.z=u.z,f.p2.z=d.z;let P,v=p.transform(f.p1),w=p.transform(f.p2);P=Communicator.Point3.subtract(v,i).length()<Communicator.Point3.subtract(w,i).length()?v:w,this._extraComponent1._behavior._targetPivot=this._extraComponent1._parent.transformPointToComponentSpace(P);let y=Communicator.Point3.subtract(n,s).normalize(),M=Communicator.Point3.subtract(P,s).normalize(),T=Communicator.Util.computeAngleBetweenVector(y,M);var e=t._calculateAngleRotMatrix(T,void 0,r);let b=t.transformlocalPointToWorldSpaceWithMatrix(n,e),N=Communicator.Point3.subtract(b,P).length();e=t._calculateAngleRotMatrix(-T),b=t.transformlocalPointToWorldSpaceWithMatrix(n,e),Communicator.Point3.subtract(b,P).length()>N&&(e=t._calculateAngleRotMatrix(T,void 0,r));let S=bt.viewer.model.getNodeMatrix(t._nodeid),A=Communicator.Matrix.multiply(S,e);bt.viewer.model.setNodeMatrix(t._nodeid,A)}else{let e=this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraComponent1._behavior._extraPivot1),n=this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraComponent1._center),i=t._parent.transformlocalPointToWorldSpace(t._center),r=t._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),a=Communicator.Point3.subtract(r,i).normalize(),s=Communicator.Plane.createFromPointAndNormal(i,a),l=o.closestPointOnPlane(s,e),m=t.transformlocalPointToWorldSpace(l),h=o.closestPointOnPlane(s,n),c=o.ComputeVectorToVectorRotationMatrix(a,new Communicator.Point3(0,0,1)),p=Communicator.Matrix.inverse(c);l=c.transform(l),h=c.transform(h);let u=c.transform(m),_=c.transform(i),d=Communicator.Point3.subtract(l,h).length(),g=o.circleLineIntersection(d,h.x,h.y,_.x,_.y,u.x,u.y);if(g){let t=new Communicator.Point3(g.x1,g.y1,_.z);t=p.transform(t),this._calculatePivotConnectorRotation(this._extraComponent1,t)<this._extraComponent1._minLimit&&(t=new Communicator.Point3(g.x2,g.y2,_.z),t=p.transform(t)),this._extraComponent1._behavior._targetPivot=t}else this._extraComponent1._behavior._targetPivot=e.copy()}else{let e;this._isSlidePivot&&(e=t._axis.copy(),t._axis=this._extraComponent1._axis.copy());let n=this._extraComponent1.transformlocalPointToWorldSpace(this._extraComponent1._behavior._extraPivot1),i=t._parent.transformlocalPointToWorldSpace(this._extraComponent1._behavior._extraPivot1),r=t._parent.transformlocalPointToWorldSpace(t._center),a=t._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),s=Communicator.Point3.subtract(a,r).normalize(),l=Communicator.Plane.createFromPointAndNormal(r,s),m=o.closestPointOnPlane(l,n),h=o.closestPointOnPlane(l,i),c=Communicator.Point3.subtract(m,r).normalize(),p=Communicator.Point3.subtract(h,r).normalize(),u=Communicator.Util.computeAngleBetweenVector(c,p);await t._rotate(u);let _=t.transformlocalPointToWorldSpace(this._extraComponent1._behavior._extraPivot1);_=o.closestPointOnPlane(l,_);let d=Communicator.Point3.subtract(_,m).length();if(await t._rotate(-u),_=t.transformlocalPointToWorldSpace(this._extraComponent1._behavior._extraPivot1),_=o.closestPointOnPlane(l,_),Communicator.Point3.subtract(_,m).length()>d&&await t._rotate(u),_=t.transformlocalPointToWorldSpace(this._extraComponent1._behavior._extraPivot1),_=o.closestPointOnPlane(l,_),this._isSlidePivot){let n=this._extraComponent1.transformlocalPointToWorldSpace(this._extraComponent1._behavior._extraPivot1),a=this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraComponent1._behavior._extraPivot1),s=Communicator.Point3.subtract(n,a).length();n=o.closestPointOnPlane(l,n),i=o.closestPointOnPlane(l,i),r=o.closestPointOnPlane(l,r);let m=Communicator.Point3.subtract(n,r).normalize(),h=t._parent.transformPointToComponentSpace(r),c=t._parent.transformPointToComponentSpace(Communicator.Point3.add(r,m));m=Communicator.Point3.subtract(c,h).normalize();let p=new Communicator.Matrix;p=new Communicator.Matrix,p.setTranslationComponent(-t._center.x,-t._center.y,-t._center.z);let u=new Communicator.Matrix;u.setTranslationComponent(t._center.x,t._center.y,t._center.z);let _=new Communicator.Matrix;_.setTranslationComponent(m.x*s,m.y*s,m.z*s),t._currentPosition=s;let d=Communicator.Matrix.multiply(p,_),g=Communicator.Matrix.multiply(d,u),x=bt.viewer.model.getNodeMatrix(t._nodeid),C=Communicator.Matrix.multiply(x,g);bt.viewer.model.setNodeMatrix(t._nodeid,C),t._axis=e}}else if(t._behavior._extraPivot1&&t._behavior._targetPivot){let e=this._calculatePivotConnectorRotation(t,t._behavior._targetPivot);await t._rotate(e),t._behavior._targetPivot=null}t._touched=!1}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}getIsSlidePivot(){return this._isSlidePivot}setIsSlidePivot(t){this._isSlidePivot=t}}class c{constructor(t){this._component=t,this._type=C.prismaticTriangle,this._extraComponent1=null,this._extraComponent2=null}getType(){return this._type}async fromJson(t,e){this._extraComponent1=t.extraComponent1,this._extraComponent2=t.extraComponent2}jsonFixup(){this._extraComponent1=this._component.getHierachy().getComponentHash()[this._extraComponent1],this._extraComponent2=this._component.getHierachy().getComponentHash()[this._extraComponent2]}toJson(t){t.extraComponent1=this._extraComponent1._id,t.extraComponent2=this._extraComponent2._id}getCurrentValue(){}set(t){}getMovementType(){return C.fixed}async execute(){let t=this._component,e=this._extraComponent1.transformlocalPointToWorldSpace(t._center),o=this._extraComponent2.transformlocalPointToWorldSpace(this._extraComponent2._center),n=this._extraComponent2._parent.transformlocalPointToWorldSpace(t._center),i=Communicator.Point3.subtract(o,e),r=Communicator.Point3.subtract(o,n),a=i.length(),s=r.length();i.normalize(),r.normalize();let l=Communicator.Util.computeAngleBetweenVector(i,r);await this._extraComponent2._rotate(-l,!0);let m=this._extraComponent2.transformlocalPointToWorldSpace(t._center),h=Communicator.Point3.subtract(m,e).length();await this._extraComponent2._rotate(l,!0),m=this._extraComponent2.transformlocalPointToWorldSpace(t._center),Communicator.Point3.subtract(m,e).length()>h&&await this._extraComponent2._rotate(-l,!0),await this._extraComponent2._updateReferenceNodeMatrices(),await t._translate(a-s)}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}getExtraComponent2(){return this._extraComponent2}setExtraComponent2(t){this._extraComponent2=t}adjustExtraComponentToPistonController(){let t=this._component,e=t._axis,n=Communicator.Plane.createFromPointAndNormal(t._center,e),i=o.closestPointOnPlane(n,this._extraComponent1._center);this._extraComponent1._axis=this._extraComponent1._axis.copy(),this._extraComponent1._center=i}}class p{constructor(t){this._component=t,this._type=C.mapped,this._mappedType=null,this._mappedTargetComponent=null,this._helicalFactor=1,this._prismaticPlanePlane=null,this._prismaticPlaneTip=null}getType(){return this._type}async fromJson(t,e){if(this._mappedType=t.mappedType,this._helicalFactor=t.helicalFactor,this._mappedTargetComponent=t.mappedTargetComponent,this._mappedType==C.belt){this.belt=new n,this.belt.fromJson(t.belt,this._component);for(let t=0;t<this._component._referenceNodes.length;t++)bt.viewer.model.setNodesVisibility([this._component._referenceNodes[t].nodeid],!1);await this.belt.initialize(),this._component._referenceNodes.push({nodeid:this.belt.getBaseNode(),matrix:new Communicator.Matrix})}if(this._mappedType==C.prismaticPlane){let e=Communicator.Point3.fromJson(t._prismaticPlanePlane.normal);this._prismaticPlanePlane=new Communicator.Plane,this._prismaticPlanePlane.d=t._prismaticPlanePlane.d,this._prismaticPlanePlane.normal=e,this._prismaticPlaneTip=Communicator.Point3.fromJson(t._prismaticPlaneTip)}}jsonFixup(){this._mappedTargetComponent=this._component.getHierachy().getComponentHash()[this._mappedTargetComponent]}toJson(t){t.mappedType=this._mappedType,this._mappedType==C.belt&&(t.parentMatrix=(new Communicator.Matrix).toJson()),t.helicalFactor=this._helicalFactor,t.mappedTargetComponent=this._mappedTargetComponent._id,this._mappedType==C.belt&&(t.belt=this.belt.toJson()),this._mappedType==C.prismaticPlane&&(t._prismaticPlanePlane={d:this._prismaticPlanePlane.d,normal:this._prismaticPlanePlane.normal.toJson()},t._prismaticPlaneTip=this._prismaticPlaneTip.toJson())}getCurrentValue(){}set(t){}getMovementType(){return C.fixed}async execute(){let t=this._component;if(this._mappedType==C.prismaticPlane){let e=bt.viewer.model.getNodeNetMatrix(this._mappedTargetComponent._nodeid).transform(this._prismaticPlaneTip),o=this._prismaticPlanePlane.distanceToPoint(e);o<0?await t._translate(o*this._helicalFactor):await t._translate(0)}else if(this._mappedTargetComponent._type==C.prismatic||this._mappedTargetComponent._type==C.mapped&&this._mappedTargetComponent._mappedType==C.prismatic){let e=this._mappedTargetComponent._currentPosition,o=bt.viewer.model.getNodeMatrix(this._mappedTargetComponent._nodeid),n=this._mappedTargetComponent._parent.transformlocalPointToWorldSpace(this._mappedTargetComponent._center),i=this._mappedTargetComponent.transformlocalPointToWorldSpace(this._mappedTargetComponent._center),r=Communicator.Point3.subtract(i,n).length();this._mappedTargetComponent._translate(r);let a=this._mappedTargetComponent.transformlocalPointToWorldSpace(this._mappedTargetComponent._center);this._mappedTargetComponent._translate(-r);let s=this._mappedTargetComponent.transformlocalPointToWorldSpace(this._mappedTargetComponent._center);Communicator.Point3.subtract(a,i).length()<Communicator.Point3.subtract(s,i).length()&&(r=-r),bt.viewer.model.setNodeMatrix(this._mappedTargetComponent._nodeid,o),this._mappedType==C.revolute?(await t._rotate(r*this._helicalFactor,!0),t._currentAngle=r*this._helicalFactor):this._mappedType==C.prismatic?await t._translate(r*this._helicalFactor,!0):this._mappedType==C.belt&&await this.belt.move(r*this._helicalFactor),this._mappedTargetComponent._currentPosition=e}else this._mappedTargetComponent._behavior.getMovementType()!=C.revolute&&this._mappedTargetComponent._type!=C.mapped||(this._mappedType==C.revolute?(await t._rotate(this._mappedTargetComponent._currentAngle*this._helicalFactor,!0),t._currentAngle=this._mappedTargetComponent._currentAngle*this._helicalFactor):this._mappedType==C.prismatic?await t._translate(this._mappedTargetComponent._currentAngle*this._helicalFactor,!0):this._mappedType==C.belt&&await this.belt.move(this._mappedTargetComponent._currentAngle*this._helicalFactor))}setMappedType(t){this._mappedType=t}getMappedType(){return this._mappedType}createBelt(){this.belt=new n}setMappedTargetComponent(t){this._mappedTargetComponent=t}getMappedTargetComponent(){return this._mappedTargetComponent}getHelicalFactor(){return this._helicalFactor}setHelicalFactor(t){this._helicalFactor=t}setPrismaticPlanePlane(t){this._prismaticPlanePlane=t}getPrismaticPlanePlane(){return this._prismaticPlanePlane}setPrismaticPlaneTip(t){this._prismaticPlaneTip=t}getPrismaticPlaneTip(){return this._prismaticPlaneTip}getBelt(){return this.belt}}class u{constructor(t){this._component=t,this._type=C.helical,this._helicalFactor=1}getType(){return this._type}async fromJson(t,e){this._helicalFactor=t.helicalFactor}jsonFixup(){}toJson(t){t.helicalFactor=this._helicalFactor}getCurrentValue(){return this._component._currentPosition}set(t){this._component._translate(t)}getHelicalFactor(){return this._helicalFactor}setHelicalFactor(t){this._helicalFactor=t}getMovementType(){return C.prismatic}async execute(){let t=this._component,e=t._parent.transformlocalPointToWorldSpace(t._center),o=t.transformlocalPointToWorldSpace(t._center),n=Communicator.Point3.subtract(o,e).length();t._translate(n);let i=t.transformlocalPointToWorldSpace(t._center);t._translate(-n);let r=t.transformlocalPointToWorldSpace(t._center);Communicator.Point3.subtract(i,o).length()<Communicator.Point3.subtract(r,o).length()&&(t._translate(n),n=-n),t._rotate(n*this._helicalFactor,!0,!0)}}class _{constructor(t){this._component=t,this._type=C.prismaticAggregate,this._extraComponent1=null,this._extraComponent2=null}getType(){return this._type}async fromJson(t,e){this._extraComponent1=t.extraComponent1,this._extraComponent2=t.extraComponent2}jsonFixup(){this._extraComponent1=this._component.getHierachy().getComponentHash()[this._extraComponent1],this._extraComponent2=this._component.getHierachy().getComponentHash()[this._extraComponent2]}toJson(t){t.extraComponent1=this._extraComponent1._id,t.extraComponent2=this._extraComponent2._id}getCurrentValue(){}set(t){}getMovementType(){return C.fixed}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}getExtraComponent2(){return this._extraComponent2}setExtraComponent2(t){this._extraComponent2=t}async execute(){let t=this._component,e=bt.viewer.model.getNodeMatrix(this._extraComponent1._nodeid),o=bt.viewer.model.getNodeMatrix(this._extraComponent2._nodeid),n=Communicator.Matrix.multiply(e,o);await bt.viewer.model.setNodeMatrix(t._nodeid,n)}}class d{constructor(t){this._component=t,this._type=C.revoluteSlide,this._extraComponent1=null,this._extraPivot1=null}getType(){return this._type}async fromJson(t,e){this._extraComponent1=t.extraComponent1,this._extraPivot1=Communicator.Point3.fromJson(t.extraPivot1)}jsonFixup(){this._extraComponent1=this._component.getHierachy().getComponentHash()[this._extraComponent1]}toJson(t){t.extraComponent1=this._extraComponent1._id,t.extraPivot1=this._extraPivot1.toJson()}getCurrentValue(){}set(t){}getMovementType(){return C.fixed}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}setExtraPivot1(t){this._extraPivot1=t}getExtraPivot1(){return this._extraPivot1}async execute(){let t=this._component,e=t._extraComponent1.transformlocalPointToWorldSpace(this._extraPivot1),o=t._parent.transformlocalPointToWorldSpace(t._center),n=t._parent.transformlocalPointToWorldSpace(this._extraPivot1),i=Communicator.Point3.subtract(n,o).normalize(),r=Communicator.Point3.subtract(e,o).normalize(),a=Communicator.Util.computeAngleBetweenVector(i,r);await t._rotate(a);let s=t.transformlocalPointToWorldSpace(this._extraPivot1),l=new Communicator.Point3(o.x+1e4*r.x,o.y+1e4*r.y,o.z+1e4*r.z),m=new Communicator.Point3(0,0,0);Communicator.Util.computePointToLineDistance(s,o,l,m)>1e-4&&await t._rotate(-a)}}class g{constructor(t){this._component=t,this._type=C.mate,this._extraComponent1=null,this._extraPivot1=null,this._extraComponent2=null,this._extraPivot2=null}getType(){return this._type}async fromJson(t,e){this._extraComponent1=t.extraComponent1,this._extraComponent2=t.extraComponent2,this._extraPivot1=Communicator.Point3.fromJson(t.extraPivot1),this._extraPivot2=Communicator.Point3.fromJson(t.extraPivot2)}jsonFixup(){this._extraComponent1=this._component.getHierachy().getComponentHash()[this._extraComponent1],this._extraComponent2=this._component.getHierachy().getComponentHash()[this._extraComponent2]}toJson(t){t.extraComponent1=this._extraComponent1._id,t.extraComponent2=this._extraComponent2._id,t.extraPivot1=this._extraPivot1.toJson(),t.extraPivot2=this._extraPivot2.toJson()}getCurrentValue(){}set(t){}getMovementType(){return C.fixed}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}getExtraComponent2(){return this._extraComponent2}setExtraComponent2(t){this._extraComponent2=t}setExtraPivot1(t){this._extraPivot1=t}getExtraPivot1(){return this._extraPivot1}setExtraPivot2(t){this._extraPivot2=t}getExtraPivot2(){return this._extraPivot2}async execute(){let t=this._component,e=Communicator.Point3.subtract(this._extraPivot1,this._extraPivot2).length(),n=this._extraComponent1.transformlocalPointToWorldSpace(this._extraPivot1),i=this._extraComponent2.transformlocalPointToWorldSpace(this._extraPivot2),r=Communicator.Point3.subtract(n,i).length();if(Math.abs(e-r)>.001){let n,i;this._extraComponent2._touched?(n={j:this._extraComponent1,pivot:this._extraPivot1},i={j:this._extraComponent2,pivot:this._extraPivot2}):(i={j:this._extraComponent1,pivot:this._extraPivot1},n={j:this._extraComponent2,pivot:this._extraPivot2}),this._extraComponent1._touched=!1,this._extraComponent2._touched=!1;let r=i.j.transformlocalPointToWorldSpace(i.pivot),a=n.j.transformlocalPointToWorldSpace(n.pivot),s=n.j.transformlocalPointToWorldSpace(n.j._center),l=i.j.transformlocalPointToWorldSpace(t._center),m=i.j.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),h=Communicator.Point3.subtract(m,l).normalize(),c=t._axis,p=o.ComputeVectorToVectorRotationMatrix(h,new Communicator.Point3(0,0,1)),u=Communicator.Matrix.inverse(p),_=p.transform(r),d=e,g=p.transform(s),x=Communicator.Point3.subtract(n.j._center,n.pivot).length(),C=o.circleIntersection(_.x,_.y,d,g.x,g.y,x);C.p1.z=_.z,C.p2.z=_.z;let f=u.transform(C.p1),P=u.transform(C.p2),v=Communicator.Point3.subtract(f,a).length(),w=Communicator.Point3.subtract(P,a).length();v>w&&(f=P);let y=i.j.transformlocalPointToWorldSpace(n.pivot),M=Communicator.Point3.subtract(y,r).normalize(),T=Communicator.Point3.subtract(f,r).normalize(),b=Communicator.Util.computeAngleBetweenVector(M,T),N=o.computeOffaxisRotationMatrix(i.pivot,c,b),S=Communicator.Matrix.inverse(bt.viewer.model.getNodeNetMatrix(bt.viewer.model.getNodeParent(t._nodeid))),A=Communicator.Matrix.multiply(N,bt.viewer.model.getNodeNetMatrix(i.j._nodeid)),H=Communicator.Matrix.multiply(A,S);await bt.viewer.model.setNodeMatrix(t._nodeid,H);let I=t.transformlocalPointToWorldSpace(n.pivot);if(Communicator.Point3.subtract(I,f).length()>1e-4){N=o.computeOffaxisRotationMatrix(i.pivot,c,-b),A=Communicator.Matrix.multiply(N,bt.viewer.model.getNodeNetMatrix(i.j._nodeid));let e=Communicator.Matrix.multiply(A,S);await bt.viewer.model.setNodeMatrix(t._nodeid,e)}y=n.j._parent.transformlocalPointToWorldSpace(n.pivot),M=Communicator.Point3.subtract(y,s).normalize(),T=Communicator.Point3.subtract(f,s).normalize(),b=Communicator.Util.computeAngleBetweenVector(M,T),await n.j._rotate(b);let z=this._hierachy.getReferenceNodeNetMatrix(n.j);I=z.transform(n.pivot),await n.j._rotate(-b),z=this._hierachy.getReferenceNodeNetMatrix(n.j);let k=z.transform(n.pivot);v=Communicator.Point3.subtract(I,f).length(),w=Communicator.Point3.subtract(k,f).length(),v<w&&await n.j._rotate(b),await this.getHierachy().updateComponents()}}}class x{constructor(t){this._component=t,this._type=C.pivotSystem,this._extraComponent1=null,this._extraComponent2=null,this._mappedComponent=null,this._helicalFactor=1,this._extraPivot1=null,this._isSlidePivot=!1,this._associatedComponentHash=null,this._processed=!1}getType(){return this._type}_addToHash(t){this._associatedComponentHash||(this._associatedComponentHash=[]),this._associatedComponentHash[t.getId()]=t}async fromJson(t,e){t.extraComponent1&&(this._extraComponent1=t.extraComponent1),t.extraComponent2&&(this._extraComponent2=t.extraComponent2),t.mappedComponent&&(this._mappedComponent=t.mappedComponent),t.extraPivot1&&(this._extraPivot1=Communicator.Point3.fromJson(t.extraPivot1)),t.helicalFactor&&(this._helicalFactor=t.helicalFactor),this._isSlidePivot=t.isSlidePivot}jsonFixup(){this._extraComponent1&&(this._extraComponent1=this._component.getHierachy().getComponentHash()[this._extraComponent1],this._extraComponent1._behavior._addToHash(this._component)),this._extraComponent2&&(this._extraComponent2=this._component.getHierachy().getComponentHash()[this._extraComponent2],this._extraComponent2._behavior._addToHash(this._component)),this._mappedComponent&&(this._mappedComponent=this._component.getHierachy().getComponentHash()[this._mappedComponent],this._mappedComponent._behavior._addToHash(this._component))}toJson(t){this._extraComponent1&&(t.extraComponent1=this._extraComponent1._id),this._extraComponent2&&(t.extraComponent2=this._extraComponent2._id),this._mappedComponent&&(t.mappedComponent=this._mappedComponent._id),t.helicalFactor=this._helicalFactor,this._extraPivot1&&(t.extraPivot1=this._extraPivot1.toJson()),t.isSlidePivot=this._isSlidePivot}getCurrentValue(){return this._isSlidePivot?this._component._currentPosition:this._component._currentAngle}set(t){this._isSlidePivot?this._component._translate(t):this._component._rotate(t)}getMovementType(){return this._extraComponent1&&this._extraComponent2?C.fixed:this._isSlidePivot?C.prismatic:C.revolute}async execute(){let t=this._component;if(t._touched){let e,n,i,r=[];if(r[t._id]=!0,this._isSlidePivot?(e=this._extraComponent1.getWorldPlane(),n=this._extraComponent1.getXYMatrix()):(e=t.getWorldPlane(),n=t.getXYMatrix()),i=Communicator.Matrix.inverse(n),this._associatedComponentHash)for(let o in this._associatedComponentHash)this._associatedComponentHash[o]._behavior._mappedComponent==this._component?this._associatedComponentHash[o]._behavior._resolveMapped(this._component,e,n,i,r):this._associatedComponentHash[o]._behavior._resolve(t,e,n,i,r);else if(this._extraComponent1){if(this._isSlidePivot){let r=t._parent.transformlocalPointToWorldSpace(t._center);r=o.closestPointOnPlane(e,r);let a=t._parent.transformlocalPointToWorldSpace(this._extraPivot1);a=o.closestPointOnPlane(e,a);let s=t.transformlocalPointToWorldSpace(this._extraPivot1);s=o.closestPointOnPlane(e,s);let l=this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraComponent1._center);l=o.closestPointOnPlane(e,l);let m=this._extraComponent1._parent.transformlocalPointToWorldSpace(this._extraPivot1);m=o.closestPointOnPlane(e,m);let h=this._circleIntersectionFromPoints(r,s,l,m,n,i),c=this._calculateAngle(a,h,r),p=this._findAngleSignMatrix(c,this._extraComponent1._axis,t._center,new Communicator.Matrix,a,h,t,e),u=bt.viewer.model.getNodeMatrix(t._nodeid),_=Communicator.Matrix.multiply(u,p);bt.viewer.model.setNodeMatrix(t._nodeid,_)}this._extraComponent1._behavior._resolve(this._component,e,n,i,r)}this._mappedComponent&&this._mappedComponent._behavior._resolveMapped(this._component,e,n,i,r),t._touched=!1}}_circleLineIntersectionFromPoints(t,e,n,i,r,a){let s=r.transform(t),l=r.transform(e),m=r.transform(n),h=r.transform(i),c=Communicator.Point3.subtract(l,s).length(),p=o.circleLineIntersection(c,s.x,s.y,m.x,m.y,h.x,h.y),u=new Communicator.Point3(p.x1,p.y1,s.z),_=new Communicator.Point3(p.x2,p.y2,s.z),d=a.transform(u),g=a.transform(_);return Communicator.Point3.subtract(d,i).length()<Communicator.Point3.subtract(g,i).length()?d:g}_circleIntersectionFromPoints(t,e,n,i,r,a){let s=r.transform(t),l=r.transform(e),m=r.transform(n),h=r.transform(i),c=Communicator.Point3.subtract(l,s).length(),p=Communicator.Point3.subtract(h,m).length(),u=o.circleIntersection(s.x,s.y,c,m.x,m.y,p);u.p1.z=s.z,u.p2.z=m.z;let _=a.transform(u.p1),d=a.transform(u.p2);return Communicator.Point3.subtract(_,e).length()<Communicator.Point3.subtract(d,e).length()?_:d}_calculateAngle(t,e,o){let n=Communicator.Point3.subtract(t,o).normalize(),i=Communicator.Point3.subtract(e,o).normalize();return Communicator.Util.computeAngleBetweenVector(n,i)}_findAngleSignMatrix(t,e,n,i,r,a,s,l){let m=this._component._calculateAngleRotMatrix(t,void 0,e,n),h=Communicator.Matrix.multiply(i,m),c=this._component.transformlocalPointToWorldSpaceWithMatrix(r,h);c=o.closestPointOnPlane(l,c);let p=Communicator.Point3.subtract(c,a).length(),u=this._component._calculateAngleRotMatrix(-t,void 0,e,n),_=Communicator.Matrix.multiply(i,u),d=this._component.transformlocalPointToWorldSpaceWithMatrix(r,_);return d=o.closestPointOnPlane(l,d),p<Communicator.Point3.subtract(d,a).length()?(s._currentAngle=t,h):(s._currentAngle=-t,_)}async _resolveMapped(t,e,o,n,i){let r=this._component;if(i[r._id])return;i[r._id]=!0;let a=0;a=null!=t._behavior._mappedComponent&&t._behavior._mappedComponent==r?1/t._behavior._helicalFactor:r._behavior._helicalFactor,r._rotate(t._currentAngle*a);for(let t in this._associatedComponentHash)this._associatedComponentHash[t]._behavior._mappedComponent==r?this._associatedComponentHash[t]._behavior._resolveMapped(r,e,o,n,i):this._associatedComponentHash[t]._behavior._resolve(r,e,o,n,i);this._mappedComponent&&this._mappedComponent._behavior._resolveMapped(r,e,o,n,i)}async _resolve(t,e,n,i,r){let a=this._component;if(!r[a._id])if(r[a._id]=!0,this._associatedComponentHash){let s,l,m=a.transformlocalPointToWorldSpace(a._center);if(m=o.closestPointOnPlane(e,m),t._behavior._extraComponent1==a)if(t._behavior._extraComponent2)s=t._center;else if(s=t._behavior._extraPivot1,t._behavior._isSlidePivot)l=t.transformlocalPointToWorldSpace(s),l=o.closestPointOnPlane(e,l);else{let r=t.transformlocalPointToWorldSpace(s);r=o.closestPointOnPlane(e,r);let m=t.transformlocalPointToWorldSpace(t._center);m=o.closestPointOnPlane(e,m);let h=a.transformlocalPointToWorldSpace(a._center);h=o.closestPointOnPlane(e,h);let c=a.transformlocalPointToWorldSpace(s);c=o.closestPointOnPlane(e,c),l=this._circleLineIntersectionFromPoints(h,c,m,r,n,i)}else s=t._behavior._extraPivot1;let h,c=t._parent.transformlocalPointToWorldSpace(s);c=o.closestPointOnPlane(e,c),l?h=l:(h=t.transformlocalPointToWorldSpace(s),h=o.closestPointOnPlane(e,h));let p=this._calculateAngle(c,h,m),u=a._parent.transformPointToComponentSpace(m),_=a._parent.transformPointToComponentSpace(c),d=this._findAngleSignMatrix(p,a._axis,u,new Communicator.Matrix,_,h,a,e);bt.viewer.model.setNodeMatrix(a._nodeid,d);for(let o in this._associatedComponentHash)this._associatedComponentHash[o]!=t&&(this._associatedComponentHash[o]._behavior._mappedComponent==a?this._associatedComponentHash[o]._behavior._resolveMapped(a,e,n,i,r):this._associatedComponentHash[o]._behavior._resolve(a,e,n,i,r));this._mappedComponent&&this._mappedComponent._behavior._resolveMapped(a,e,n,i,r)}else if(this._extraComponent2){let s,l,m;this._extraComponent1.getId()==t.getId()?(s=a._center,m=this._extraComponent2,l=this._extraPivot1):(s=this._extraPivot1,m=this._extraComponent1,l=a._center);let h=t.transformlocalPointToWorldSpace(s),c=a._parent.transformlocalPointToWorldSpace(s),p=a._parent.transformlocalPointToWorldSpace(l),u=m._parent.transformlocalPointToWorldSpace(m._center);h=o.closestPointOnPlane(e,h),c=o.closestPointOnPlane(e,c),p=o.closestPointOnPlane(e,p),u=o.closestPointOnPlane(e,u);let _=a._parent.transformPointToComponentSpace(h),d=a._parent.transformPointToComponentSpace(c),g=Communicator.Point3.subtract(_,d),x=new Communicator.Matrix;x.setTranslationComponent(g.x,g.y,g.z),bt.viewer.model.setNodeMatrix(a._nodeid,x);let C,f=a.transformlocalPointToWorldSpace(l);f=o.closestPointOnPlane(e,f),r[m._id]?(C=m.transformlocalPointToWorldSpace(l),C=o.closestPointOnPlane(e,C)):C=this._circleIntersectionFromPoints(h,f,u,p,n,i);let P=this._calculateAngle(f,C,h),v=this._findAngleSignMatrix(P,a._axis,_,x,l,C,a,e);bt.viewer.model.setNodeMatrix(a._nodeid,v),m._behavior._resolve(a,e,n,i,r)}else{let n=a._parent.transformlocalPointToWorldSpace(a._center);n=o.closestPointOnPlane(e,n);let i=a._parent.transformlocalPointToWorldSpace(this._extraPivot1);i=o.closestPointOnPlane(e,i);let r=t.transformlocalPointToWorldSpace(this._extraPivot1);r=o.closestPointOnPlane(e,r);let s=this._calculateAngle(i,r,n);if(this._isSlidePivot){let l=this._findAngleSignMatrix(s,t._axis,a._center,new Communicator.Matrix,this._extraPivot1,r,a,e);bt.viewer.model.setNodeMatrix(a._nodeid,l),i=a.transformlocalPointToWorldSpace(this._extraPivot1),i=o.closestPointOnPlane(e,i);let m=Communicator.Point3.subtract(r,i).length();if(r.equalsWithTolerance(i,1e-4))return;let h=Communicator.Point3.subtract(r,i).normalize(),c=a._parent.transformPointToComponentSpace(n),p=a._parent.transformPointToComponentSpace(Communicator.Point3.add(n,h));h=Communicator.Point3.subtract(p,c).normalize();let u=new Communicator.Matrix;u=new Communicator.Matrix,u.setTranslationComponent(-a._center.x,-a._center.y,-a._center.z);let _=new Communicator.Matrix;_.setTranslationComponent(a._center.x,a._center.y,a._center.z);let d=new Communicator.Matrix;d.setTranslationComponent(h.x*m,h.y*m,h.z*m);let g=Communicator.Matrix.multiply(u,d),x=Communicator.Matrix.multiply(g,_),C=bt.viewer.model.getNodeMatrix(a._nodeid),f=Communicator.Matrix.multiply(C,x);bt.viewer.model.setNodeMatrix(a._nodeid,f)}else{let t=this._findAngleSignMatrix(s,a._axis,a._center,new Communicator.Matrix,this._extraPivot1,r,a,e);bt.viewer.model.setNodeMatrix(a._nodeid,t)}}}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}getMappedComponent(){return this._mappedComponent}setMappedComponent(t){this._mappedComponent=t}getExtraComponent2(){return this._extraComponent2}setExtraComponent2(t){this._extraComponent2=t}getHelicalFactor(){return this._helicalFactor}setHelicalFactor(t){this._helicalFactor=t}getIsSlidePivot(){return this._isSlidePivot}setIsSlidePivot(t){this._isSlidePivot=t}setExtraPivot1(t){this._extraPivot1=t}getExtraPivot1(){return this._extraPivot1}}const C={revolute:0,prismatic:1,fixed:2,prismaticAggregate:3,prismaticTriangle:4,helical:5,mapped:6,pistonController:7,prismaticPlane:8,belt:9,mate:10,revoluteSlide:11,target:12,pivotConnector:13,pivotSystem:14};class f{constructor(t,e){this._hierachy=e,this._id=e._highestId++,this._type=C.revolute,this._behavior=new r(this),this._children=[],this._parent=t,this._minLimit=void 0,this._maxLimit=void 0,this._nodeid=-1,this._center=new Communicator.Point3(0,0,0),this._axis=new Communicator.Point3(1,0,0),this._currentAngle=0,this._currentPosition=0,this._referenceNodes=[],this._parentMatrix=new Communicator.Matrix,this._extraComponent1=null,this._extraComponent2=null,this._reference=!0,this._touched=!1,this._animations=[],this._activeAnimation=!1}initialize(t,e){this._reference=e,this._parent?this._nodeid=bt.viewer.model.createNode(this._parent._nodeid,"component"):this._nodeid=bt.viewer.model.createNode(bt.viewer.model.getRootNode(),"rootComponent"),this._parentMatrix=bt.viewer.model.getNodeNetMatrix(bt.viewer.model.getNodeParent(t[0]));for(let e=0;e<t.length;e++)this._referenceNodes.push({nodeid:t[e],matrix:bt.viewer.model.getNodeNetMatrix(t[e]).copy()})}getId(){return this._id}setType(t){this._type=t,this._type==C.revolute?this._behavior=new r(this):this._type==C.prismatic?this._behavior=new a(this):this._type==C.pistonController?this._behavior=new s(this):this._type==C.fixed?this._behavior=new l(this):this._type==C.target?this._behavior=new m(this):this._type==C.pivotConnector?this._behavior=new h(this):this._type==C.prismaticTriangle?this._behavior=new c(this):this._type==C.mapped?this._behavior=new p(this):this._type==C.helical?this._behavior=new u(this):this._type==C.revoluteSlide?this._behavior=new d(this):this._type==C.prismaticAggregate?this._behavior=new _(this):this._type==C.mate?this._behavior=new g(this):this._type==C.pivotSystem?this._behavior=new x(this):this._behavior=bt.getCustomTypeCallback()(this,t)}getType(){return this._behavior?this._behavior.getType():this._type}setBehavior(t){this._behavior=t}getBehavior(){return this._behavior}setParent(t){this._parent=t}getParent(){return this._parent}getChildren(){return this._children}getChildByIndex(t){return this._children[t]}setNodeId(t){this._nodeid=t}getNodeId(){return this._nodeid}getHierachy(){return this._hierachy}setCenter(t){this._center=t}getCenter(){return this._center}setAxis(t){this._axis=t}getAxis(){return this._axis}getCurrentValue(){if(this._behavior)return this._behavior.getCurrentValue()}getReferenceNodes(){return this._referenceNodes}getParentMatrix(){return this._parentMatrix}setIsReference(t){this._reference=t}getIsReference(){return this._reference}getAnimations(){return this._animations}getAnimationActive(){return this._activeAnimation}setAnimationActive(t){this._activeAnimation=t}getAnimationByIndex(t){return this._animations[t]}setMinLimit(t){this._minLimit=t}getMinLimit(){return this._minLimit}setMaxLimit(t){this._maxLimit=t}getMaxLimit(){return this._maxLimit}set(t){this._behavior.set(t),this._touched=!0}toJson(){let t=[];for(let e=0;e<this._children.length;e++)t.push(this._children[e].toJson());let e=[];if(this.getType()==C.mapped&&this._behavior._mappedType==C.belt)for(let t=0;t<this._referenceNodes.length;t++)this._referenceNodes[t].nodeid!=this._behavior.belt.getBaseNode()&&e.push({nodeid:this._referenceNodes[t].nodeid,matrix:this._referenceNodes[t].matrix.toJson()});else for(let t=0;t<this._referenceNodes.length;t++)e.push({nodeid:this._referenceNodes[t].nodeid,matrix:this._referenceNodes[t].matrix.toJson()});let o={id:this._id,reference:this._reference,type:this.getType(),center:this._center.toJson(),axis:this._axis.toJson(),minangle:this._minLimit,maxangle:this._maxLimit,children:t,referenceNodes:e,parentMatrix:this._parentMatrix.toJson()};this._behavior&&this._behavior.toJson(o),o.animations=[];for(let t=0;t<this._animations.length;t++)o.animations.push(this._animations[t]);return o}async fromJson(t,e){if(this._minLimit=t.minangle,this._maxLimit=t.maxangle,this._reference=t.reference,this._center=Communicator.Point3.fromJson(t.center),null!=t.id&&(this._id=t.id,this._id>=this._hierachy._highestId&&(this._hierachy._highestId=this._id+1)),null==e){let e=Communicator.Point3.fromJson(t.axis);this._axis=Communicator.Point3.subtract(e,this._center).normalize(),isNaN(this._axis.x)&&(this._axis=new Communicator.Point3(1,0,0))}else this._axis=Communicator.Point3.fromJson(t.axis);this.setType(t.type),this._behavior&&this._behavior.fromJson(t,e),this._parentMatrix=Communicator.Matrix.fromJson(t.parentMatrix),this._hierachy.getComponentHash()[this._id]=this,this._parent?this._nodeid=bt.viewer.model.createNode(this._parent._nodeid,"component"):this._nodeid=bt.viewer.model.createNode(bt.viewer.model.getRootNode(),"rootComponent");for(let e=0;e<t.referenceNodes.length;e++)this._referenceNodes.push({nodeid:t.referenceNodes[e].nodeid,matrix:Communicator.Matrix.fromJson(t.referenceNodes[e].matrix)}),this._hierachy._componentNodeidHash[t.referenceNodes[e].nodeid]=this;for(let o=0;o<t.children.length;o++){let n=new f(this,this._hierachy);n.fromJson(t.children[o],e),this._children.push(n)}if(t.animations)for(let e=0;e<t.animations.length;e++)this._animations.push(t.animations[e])}addAnimation(t){this._animations.push(t)}removeAnimation(t){for(let e=0;e<this._animations.length;e++)if(this._animations[e]==t)return void this._animations.splice(e,1)}removeAnimationRecursive(t){for(let e=0;e<this._children.length;e++)this._children[e].removeAnimationRecursive(t);this.removeAnimation(t)}animToJson(t){for(let e=0;e<this._children.length;e++)this._children[e].animToJson(t);for(let e=0;e<this._animations.length;e++)t[this._animations[e]]=!0}updateReferenceNodes(t){for(let t=0;t<this._referenceNodes.length;t++)delete this._hierachy._componentNodeidHash[this._referenceNodes[t].nodeid];this._referenceNodes=[];for(let e=0;e<t.length;e++)this._referenceNodes.push({nodeid:t[e],matrix:bt.viewer.model.getNodeNetMatrix(t[e]).copy()}),this._hierachy._componentNodeidHash[this._referenceNodes[e].nodeid]=this}removeReferenceNodes(t){for(let e=0;e<this._referenceNodes.length;e++)for(let o=0;o<t.length;o++)if(this._referenceNodes[e].nodeid==t[o]){delete this._hierachy._componentNodeidHash[this._referenceNodes[e].nodeid],this._referenceNodes.splice(e,1),e--;break}}transformPointToComponentSpace(t){let e=this._hierachy.getReferenceNodeNetMatrix(this);return Communicator.Matrix.inverse(e).transform(t)}transformlocalPointToWorldSpace(t){return this._hierachy.getReferenceNodeNetMatrix(this).transform(t)}transformlocalPointToWorldSpaceWithMatrix(t,e){let o=this._hierachy.getReferenceNodeNetMatrix(this._parent);return o=Communicator.Matrix.multiply(e,o),o.transform(t)}_calculateAngleRotMatrix(t,e,o,n){let i,r,a=new Communicator.Matrix,s=new Communicator.Matrix;i=o||this._axis,r=n||this._center,s=new Communicator.Matrix,s.setTranslationComponent(-r.x,-r.y,-r.z);let l=new Communicator.Matrix;l.setTranslationComponent(r.x,r.y,r.z),Communicator.Util.computeOffaxisRotation(i,t,a);let m=Communicator.Matrix.multiply(s,a),h=Communicator.Matrix.multiply(m,l);if(null!=e){let t=bt.viewer.model.getNodeMatrix(this._nodeid);return Communicator.Matrix.multiply(t,h)}return h}_rotate(t,e,o){o?(null!=this._minLimit&&this._currentAngle+t<this._minLimit&&(t=this._minLimit-this._currentAngle),null!=this._maxLimit&&this._currentAngle+t>this._maxLimit&&(t=this._maxLimit-this._currentAngle),this._currentAngle+=t):(this._currentAngle=t,null!=this._minLimit&&this._currentAngle<this._minLimit&&(this._currentAngle=this._minLimit,t=this._currentAngle),null!=this._maxLimit&&this._currentAngle>this._maxLimit&&(this._currentAngle=this._maxLimit,t=this._currentAngle));let n=this._calculateAngleRotMatrix(t,o);bt.viewer.model.setNodeMatrix(this._nodeid,n)}_translate(t){null!=this._minLimit&&t<this._minLimit&&(t=this._minLimit),null!=this._maxLimit&&t>this._maxLimit&&(t=this._maxLimit),this._currentPosition=t;let e=new Communicator.Matrix,o=this._axis;e=new Communicator.Matrix,e.setTranslationComponent(-this._center.x,-this._center.y,-this._center.z);let n=new Communicator.Matrix;n.setTranslationComponent(this._center.x,this._center.y,this._center.z);let i=new Communicator.Matrix;i.setTranslationComponent(o.x*t,o.y*t,o.z*t);let r=Communicator.Matrix.multiply(e,i),a=Communicator.Matrix.multiply(r,n);bt.viewer.model.setNodeMatrix(this._nodeid,a)}async calculateMatrixFromHandleMatrix(t){let e;if(this._reference){let o,n=Communicator.Matrix.multiply(t,this._parentMatrix),i=Communicator.Matrix.inverse(this._referenceNodes[0].matrix),r=Communicator.Matrix.multiply(i,n);o=this._parent._parent?this._hierachy.getReferenceNodeNetMatrix(this._parent):new Communicator.Matrix,i=Communicator.Matrix.inverse(o),e=Communicator.Matrix.multiply(r,i)}else{let o=Communicator.Matrix.multiply(t,this._parentMatrix),n=Communicator.Matrix.inverse(this._referenceNodes[0].matrix);e=Communicator.Matrix.multiply(n,o)}if(this._behavior.getMovementType()==C.revolute){let t=bt.viewer.model.getNodeMatrix(this._nodeid),n=this._axis,i=Communicator.Point3.cross(new Communicator.Point3(1,0,0),n);i.length()<1e-5&&(i=Communicator.Point3.cross(new Communicator.Point3(0,1,0),n));let r=Communicator.Point3.add(i,this._center),a=t.transform(component._center),s=t.transform(r),l=(e.transform(this._center),e.transform(r)),m=Communicator.Point3.subtract(s,a).normalize(),h=Communicator.Point3.subtract(l,a).normalize(),c=o.signedAngle(m,h,n);await this._rotate(c,!0,!0)}else{let t=bt.viewer.model.getNodeNetMatrix(this._parent._nodeid);await bt.viewer.model.setNodeMatrix(this._nodeid,e);let o=bt.viewer.model.getNodeNetMatrix(this._nodeid),n=t.transform(this._center),i=o.transform(this._center),r=Communicator.Point3.subtract(i,n).length();await this._translate(r),n=bt.viewer.model.getNodeNetMatrix(this._nodeid).transform(this._center),i=Communicator.Matrix.multiply(t,e).transform(this._center),Communicator.Point3.subtract(i,n).length()>1e-4&&await this._translate(-r)}this._touched=!0}setParametersFromHandle(){if(bt.handlePlacementOperator.getPosition()){let t=bt.handlePlacementOperator.getPosition(),e=bt.handlePlacementOperator.getAxis();if(!e)return;let o=this._hierachy.getReferenceNodeNetMatrix(this),n=Communicator.Matrix.inverse(o),i=n.transform(t),r=new Communicator.Point3(t.x+e.x,t.y+e.y,t.z+e.z),a=n.transform(r);this.setCenter(i),this.setAxis(Communicator.Point3.subtract(a,i).normalize())}}selectReferenceNodes(){bt.viewer.selectionManager.clear();let t=[];for(let e=0;e<this._referenceNodes.length;e++)t.push(Communicator.Selection.SelectionItem.create(this._referenceNodes[e].nodeid));bt.viewer.selectionManager.add(t)}showHandles(t,e,o){let n=bt.handlePlacementOperator,i=this._hierachy.getReferenceNodeNetMatrix(this),r=i.transform(this._center),a=i.transform(Communicator.Point3.add(this._center,this._axis)),s=Communicator.Point3.subtract(a,r);o&&(r=o);let l=[];bt.viewer.selectionManager.clear();let m=[];for(let t=0;t<this._referenceNodes.length;t++)m.push(Communicator.Selection.SelectionItem.create(this._referenceNodes[t].nodeid)),l.push(this._referenceNodes[t].nodeid);if(bt.viewer.selectionManager.add(m),null!=e&&(l=[],l.push(e)),n._addAxisTranslationHandle(r,s,l),n._addAxisTranslationHandle(r,s.copy().scale(-1),l),this._behavior.getMovementType()!=C.prismatic&&n._addAxisRotationHandle(r,s,l),t||this._fixedAxis){let t;this._fixedAxis?t=this._fixedAxisTarget.copy():(t=Communicator.Point3.cross(new Communicator.Point3(1,0,0),s),t.length()<1e-5&&(t=Communicator.Point3.cross(new Communicator.Point3(0,1,0),s))),n._addAxisTranslationHandle(r,t,l),bt.getHandleOperator().setSecondAxis(t.copy())}bt.getHandleOperator().setAxis(s.copy())}async calculateGradient(){let t,e=this._currentAngle,o=this._currentPosition,n=this._hierachy.distanceFromIKTarget();return this._behavior.getMovementType()==C.revolute?(await this._rotate(this._currentAngle+this._hierachy._ikSamplingDistance,!0),t=(this._hierachy.distanceFromIKTarget()-n)/this._hierachy._ikSamplingDistance):(await this._translate(this._currentPosition+this._hierachy._ikSamplingDistanceTranslation),t=(this._hierachy.distanceFromIKTarget()-n)/this._hierachy._ikSamplingDistanceTranslation),this._behavior.getMovementType()==C.revolute?await this._rotate(e):await this._translate(o),t}async update(t){this._behavior.getMovementType()==C.revolute?await this._rotate(this._currentAngle-this._hierachy._ikLearningRate*t):await this._translate(this._currentPosition-this._hierachy._ikLearningRate*t)}reset(){this._behavior.getMovementType()==C.revolute?this._rotate(0):this._translate(0)}delete(){if(this._parent){delete this._hierachy.getComponentHash()[this._id];for(let t=0;t<this._children.length;t++)this._children[t]._parent=this._parent,this._parent._children.push(this._children[t]);for(let t=0;t<this._parent._children.length;t++)if(this._parent._children[t]==this){this._parent._children.splice(t,1);break}}}moveup(){if(this._parent){for(let t=0;t<this._parent._children.length;t++)if(this._parent._children[t]==this){this._parent._children.splice(t,1);break}this._parent._parent._children.push(this)}}async _execute(){this._behavior&&await this._behavior.execute(this)}async _updateReferenceNodeMatrices(){if(this._reference)if(this._parent&&0==this._parent._reference)for(let t=0;t<this._referenceNodes.length;t++){let e=Communicator.Matrix.multiply(this._referenceNodes[t].matrix,bt.viewer.model.getNodeMatrix(this._nodeid)),o=Communicator.Matrix.multiply(e,bt.viewer.model.getNodeMatrix(this._parent._nodeid)),n=Communicator.Matrix.inverse(this._parent._parentMatrix),i=Communicator.Matrix.multiply(o,n);bt.viewer.model.setNodeMatrix(this._referenceNodes[t].nodeid,i)}else for(let t=0;t<this._referenceNodes.length;t++){let e=Communicator.Matrix.multiply(this._referenceNodes[t].matrix,this._hierachy.getReferenceNodeNetMatrix(this)),o=Communicator.Matrix.inverse(this._parentMatrix),n=Communicator.Matrix.multiply(e,o);bt.viewer.model.setNodeMatrix(this._referenceNodes[t].nodeid,n)}else for(let t=0;t<this._referenceNodes.length;t++){let e=Communicator.Matrix.multiply(this._referenceNodes[t].matrix,bt.viewer.model.getNodeMatrix(this._nodeid)),o=Communicator.Matrix.inverse(this._parentMatrix),n=Communicator.Matrix.multiply(e,o);bt.viewer.model.setNodeMatrix(this._referenceNodes[t].nodeid,n)}}getWorldPlane(){let t=this._parent.transformlocalPointToWorldSpace(this._center),e=this._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(this._center,this._axis));return e=Communicator.Point3.subtract(e,t).normalize(),Communicator.Plane.createFromPointAndNormal(t,e)}getXYMatrix(){let t=this._parent.transformlocalPointToWorldSpace(this._center),e=this._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(this._center,this._axis));return e=Communicator.Point3.subtract(e,t).normalize(),o.ComputeVectorToVectorRotationMatrix(e,new Communicator.Point3(0,0,1))}}var P={update:null,begin:null,loopBegin:null,changeBegin:null,change:null,changeComplete:null,loopComplete:null,complete:null,loop:1,direction:"normal",autoplay:!0,timelineOffset:0},v={duration:1e3,delay:0,endDelay:0,easing:"easeOutElastic(1, .5)",round:0},w=["translateX","translateY","translateZ","rotate","rotateX","rotateY","rotateZ","scale","scaleX","scaleY","scaleZ","skew","skewX","skewY","perspective","matrix","matrix3d"],y={CSS:{},springs:{}};function M(t,e,o){return Math.min(Math.max(t,e),o)}function T(t,e){return t.indexOf(e)>-1}function b(t,e){return t.apply(null,e)}var N={arr:function(t){return Array.isArray(t)},obj:function(t){return T(Object.prototype.toString.call(t),"Object")},pth:function(t){return N.obj(t)&&t.hasOwnProperty("totalLength")},svg:function(t){return t instanceof SVGElement},inp:function(t){return t instanceof HTMLInputElement},dom:function(t){return t.nodeType||N.svg(t)},str:function(t){return"string"==typeof t},fnc:function(t){return"function"==typeof t},und:function(t){return void 0===t},nil:function(t){return N.und(t)||null===t},hex:function(t){return/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(t)},rgb:function(t){return/^rgb/.test(t)},hsl:function(t){return/^hsl/.test(t)},col:function(t){return N.hex(t)||N.rgb(t)||N.hsl(t)},key:function(t){return!P.hasOwnProperty(t)&&!v.hasOwnProperty(t)&&"targets"!==t&&"keyframes"!==t}};function S(t){var e=/\(([^)]+)\)/.exec(t);return e?e[1].split(",").map((function(t){return parseFloat(t)})):[]}function A(t,e){var o=S(t),n=M(N.und(o[0])?1:o[0],.1,100),i=M(N.und(o[1])?100:o[1],.1,100),r=M(N.und(o[2])?10:o[2],.1,100),a=M(N.und(o[3])?0:o[3],.1,100),s=Math.sqrt(i/n),l=r/(2*Math.sqrt(i*n)),m=l<1?s*Math.sqrt(1-l*l):0,h=l<1?(l*s-a)/m:-a+s;function c(t){var o=e?e*t/1e3:t;return o=l<1?Math.exp(-o*l*s)*(1*Math.cos(m*o)+h*Math.sin(m*o)):(1+h*o)*Math.exp(-o*s),0===t||1===t?t:1-o}return e?c:function(){var e=y.springs[t];if(e)return e;for(var o=1/6,n=0,i=0;;)if(1===c(n+=o)){if(++i>=16)break}else i=0;var r=n*o*1e3;return y.springs[t]=r,r}}function H(t){return void 0===t&&(t=10),function(e){return Math.ceil(M(e,1e-6,1)*t)*(1/t)}}var I,z,k=function(){var t=.1;function e(t,e){return 1-3*e+3*t}function o(t,e){return 3*e-6*t}function n(t){return 3*t}function i(t,i,r){return((e(i,r)*t+o(i,r))*t+n(i))*t}function r(t,i,r){return 3*e(i,r)*t*t+2*o(i,r)*t+n(i)}return function(e,o,n,a){if(0<=e&&e<=1&&0<=n&&n<=1){var s=new Float32Array(11);if(e!==o||n!==a)for(var l=0;l<11;++l)s[l]=i(l*t,e,n);return function(l){return e===o&&n===a||0===l||1===l?l:i(function(o){for(var a=0,l=1;10!==l&&s[l]<=o;++l)a+=t;--l;var m=a+(o-s[l])/(s[l+1]-s[l])*t,h=r(m,e,n);return h>=.001?function(t,e,o,n){for(var a=0;a<4;++a){var s=r(e,o,n);if(0===s)return e;e-=(i(e,o,n)-t)/s}return e}(o,m,e,n):0===h?m:function(t,e,o,n,r){var a,s,l=0;do{(a=i(s=e+(o-e)/2,n,r)-t)>0?o=s:e=s}while(Math.abs(a)>1e-7&&++l<10);return s}(o,a,a+t,e,n)}(l),o,a)}}}}(),O=(I={linear:function(){return function(t){return t}}},z={Sine:function(){return function(t){return 1-Math.cos(t*Math.PI/2)}},Circ:function(){return function(t){return 1-Math.sqrt(1-t*t)}},Back:function(){return function(t){return t*t*(3*t-2)}},Bounce:function(){return function(t){for(var e,o=4;t<((e=Math.pow(2,--o))-1)/11;);return 1/Math.pow(4,3-o)-7.5625*Math.pow((3*e-2)/22-t,2)}},Elastic:function(t,e){void 0===t&&(t=1),void 0===e&&(e=.5);var o=M(t,1,10),n=M(e,.1,2);return function(t){return 0===t||1===t?t:-o*Math.pow(2,10*(t-1))*Math.sin((t-1-n/(2*Math.PI)*Math.asin(1/o))*(2*Math.PI)/n)}}},["Quad","Cubic","Quart","Quint","Expo"].forEach((function(t,e){z[t]=function(){return function(t){return Math.pow(t,e+2)}}})),Object.keys(z).forEach((function(t){var e=z[t];I["easeIn"+t]=e,I["easeOut"+t]=function(t,o){return function(n){return 1-e(t,o)(1-n)}},I["easeInOut"+t]=function(t,o){return function(n){return n<.5?e(t,o)(2*n)/2:1-e(t,o)(-2*n+2)/2}},I["easeOutIn"+t]=function(t,o){return function(n){return n<.5?(1-e(t,o)(1-2*n))/2:(e(t,o)(2*n-1)+1)/2}}})),I);function W(t,e){if(N.fnc(t))return t;var o=t.split("(")[0],n=O[o],i=S(t);switch(o){case"spring":return A(t,e);case"cubicBezier":return b(k,i);case"steps":return b(H,i);default:return b(n,i)}}function F(t){try{return document.querySelectorAll(t)}catch(t){return}}function R(t,e){for(var o=t.length,n=arguments.length>=2?arguments[1]:void 0,i=[],r=0;r<o;r++)if(r in t){var a=t[r];e.call(n,a,r,t)&&i.push(a)}return i}function J(t){return t.reduce((function(t,e){return t.concat(N.arr(e)?J(e):e)}),[])}function L(t){return N.arr(t)?t:(N.str(t)&&(t=F(t)||t),t instanceof NodeList||t instanceof HTMLCollection?[].slice.call(t):[t])}function D(t,e){return t.some((function(t){return t===e}))}function B(t){var e={};for(var o in t)e[o]=t[o];return e}function E(t,e){var o=B(t);for(var n in t)o[n]=e.hasOwnProperty(n)?e[n]:t[n];return o}function V(t,e){var o=B(t);for(var n in e)o[n]=N.und(t[n])?e[n]:t[n];return o}function j(t){var e=/[+-]?\d*\.?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?(%|px|pt|em|rem|in|cm|mm|ex|ch|pc|vw|vh|vmin|vmax|deg|rad|turn)?$/.exec(t);if(e)return e[1]}function q(t,e){return N.fnc(t)?t(e.target,e.id,e.total):t}function G(t,e){return t.getAttribute(e)}function U(t,e,o){if(D([o,"deg","rad","turn"],j(e)))return e;var n=y.CSS[e+o];if(!N.und(n))return n;var i=document.createElement(t.tagName),r=t.parentNode&&t.parentNode!==document?t.parentNode:document.body;r.appendChild(i),i.style.position="absolute",i.style.width=100+o;var a=100/i.offsetWidth;r.removeChild(i);var s=a*parseFloat(e);return y.CSS[e+o]=s,s}function K(t,e,o){if(e in t.style){var n=e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),i=t.style[e]||getComputedStyle(t).getPropertyValue(n)||"0";return o?U(t,i,o):i}}function X(t,e){return N.dom(t)&&!N.inp(t)&&(!N.nil(G(t,e))||N.svg(t)&&t[e])?"attribute":N.dom(t)&&D(w,e)?"transform":N.dom(t)&&"transform"!==e&&K(t,e)?"css":null!=t[e]?"object":void 0}function Y(t){if(N.dom(t)){for(var e,o=t.style.transform||"",n=/(\w+)\(([^)]*)\)/g,i=new Map;e=n.exec(o);)i.set(e[1],e[2]);return i}}function $(t,e,o,n){switch(X(t,e)){case"transform":return function(t,e,o,n){var i=T(e,"scale")?1:0+function(t){return T(t,"translate")||"perspective"===t?"px":T(t,"rotate")||T(t,"skew")?"deg":void 0}(e),r=Y(t).get(e)||i;return o&&(o.transforms.list.set(e,r),o.transforms.last=e),n?U(t,r,n):r}(t,e,n,o);case"css":return K(t,e,o);case"attribute":return G(t,e);default:return t[e]||0}}function Q(t,e){var o=/^(\*=|\+=|-=)/.exec(t);if(!o)return t;var n=j(t)||0,i=parseFloat(e),r=parseFloat(t.replace(o[0],""));switch(o[0][0]){case"+":return i+r+n;case"-":return i-r+n;case"*":return i*r+n}}function Z(t,e){if(N.col(t))return function(t){return N.rgb(t)?(o=/rgb\((\d+,\s*[\d]+,\s*[\d]+)\)/g.exec(e=t))?"rgba("+o[1]+",1)":e:N.hex(t)?function(t){var e=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(t,e,o,n){return e+e+o+o+n+n})),o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return"rgba("+parseInt(o[1],16)+","+parseInt(o[2],16)+","+parseInt(o[3],16)+",1)"}(t):N.hsl(t)?function(t){var e,o,n,i=/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.exec(t)||/hsla\((\d+),\s*([\d.]+)%,\s*([\d.]+)%,\s*([\d.]+)\)/g.exec(t),r=parseInt(i[1],10)/360,a=parseInt(i[2],10)/100,s=parseInt(i[3],10)/100,l=i[4]||1;function m(t,e,o){return o<0&&(o+=1),o>1&&(o-=1),o<1/6?t+6*(e-t)*o:o<.5?e:o<2/3?t+(e-t)*(2/3-o)*6:t}if(0==a)e=o=n=s;else{var h=s<.5?s*(1+a):s+a-s*a,c=2*s-h;e=m(c,h,r+1/3),o=m(c,h,r),n=m(c,h,r-1/3)}return"rgba("+255*e+","+255*o+","+255*n+","+l+")"}(t):void 0;var e,o}(t);if(/\s/g.test(t))return t;var o=j(t),n=o?t.substr(0,t.length-o.length):t;return e?n+e:n}function tt(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function et(t){for(var e,o=t.points,n=0,i=0;i<o.numberOfItems;i++){var r=o.getItem(i);i>0&&(n+=tt(e,r)),e=r}return n}function ot(t){if(t.getTotalLength)return t.getTotalLength();switch(t.tagName.toLowerCase()){case"circle":return function(t){return 2*Math.PI*G(t,"r")}(t);case"rect":return function(t){return 2*G(t,"width")+2*G(t,"height")}(t);case"line":return function(t){return tt({x:G(t,"x1"),y:G(t,"y1")},{x:G(t,"x2"),y:G(t,"y2")})}(t);case"polyline":return et(t);case"polygon":return function(t){var e=t.points;return et(t)+tt(e.getItem(e.numberOfItems-1),e.getItem(0))}(t)}}function nt(t,e){var o=e||{},n=o.el||function(t){for(var e=t.parentNode;N.svg(e)&&N.svg(e.parentNode);)e=e.parentNode;return e}(t),i=n.getBoundingClientRect(),r=G(n,"viewBox"),a=i.width,s=i.height,l=o.viewBox||(r?r.split(" "):[0,0,a,s]);return{el:n,viewBox:l,x:l[0]/1,y:l[1]/1,w:a,h:s,vW:l[2],vH:l[3]}}function it(t,e,o){function n(o){void 0===o&&(o=0);var n=e+o>=1?e+o:0;return t.el.getPointAtLength(n)}var i=nt(t.el,t.svg),r=n(),a=n(-1),s=n(1),l=o?1:i.w/i.vW,m=o?1:i.h/i.vH;switch(t.property){case"x":return(r.x-i.x)*l;case"y":return(r.y-i.y)*m;case"angle":return 180*Math.atan2(s.y-a.y,s.x-a.x)/Math.PI}}function rt(t,e){var o=/[+-]?\d*\.?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?/g,n=Z(N.pth(t)?t.totalLength:t,e)+"";return{original:n,numbers:n.match(o)?n.match(o).map(Number):[0],strings:N.str(t)||e?n.split(o):[]}}function at(t){return R(t?J(N.arr(t)?t.map(L):L(t)):[],(function(t,e,o){return o.indexOf(t)===e}))}function st(t){var e=at(t);return e.map((function(t,o){return{target:t,id:o,total:e.length,transforms:{list:Y(t)}}}))}function lt(t,e){var o=B(e);if(/^spring/.test(o.easing)&&(o.duration=A(o.easing)),N.arr(t)){var n=t.length;2!==n||N.obj(t[0])?N.fnc(e.duration)||(o.duration=e.duration/n):t={value:t}}var i=N.arr(t)?t:[t];return i.map((function(t,o){var n=N.obj(t)&&!N.pth(t)?t:{value:t};return N.und(n.delay)&&(n.delay=o?0:e.delay),N.und(n.endDelay)&&(n.endDelay=o===i.length-1?e.endDelay:0),n})).map((function(t){return V(t,o)}))}var mt={css:function(t,e,o){return t.style[e]=o},attribute:function(t,e,o){return t.setAttribute(e,o)},object:function(t,e,o){return t[e]=o},transform:function(t,e,o,n,i){if(n.list.set(e,o),e===n.last||i){var r="";n.list.forEach((function(t,e){r+=e+"("+t+") "})),t.style.transform=r}}};function ht(t,e){st(t).forEach((function(t){for(var o in e){var n=q(e[o],t),i=t.target,r=j(n),a=$(i,o,r,t),s=Q(Z(n,r||j(a)),a),l=X(i,o);mt[l](i,o,s,t.transforms,!0)}}))}function ct(t,e){return R(J(t.map((function(t){return e.map((function(e){return function(t,e){var o=X(t.target,e.name);if(o){var n=function(t,e){var o;return t.tweens.map((function(n){var i=function(t,e){var o={};for(var n in t){var i=q(t[n],e);N.arr(i)&&1===(i=i.map((function(t){return q(t,e)}))).length&&(i=i[0]),o[n]=i}return o.duration=parseFloat(o.duration),o.delay=parseFloat(o.delay),o}(n,e),r=i.value,a=N.arr(r)?r[1]:r,s=j(a),l=$(e.target,t.name,s,e),m=o?o.to.original:l,h=N.arr(r)?r[0]:m,c=j(h)||j(l),p=s||c;return N.und(a)&&(a=m),i.from=rt(h,p),i.to=rt(Q(a,h),p),i.start=o?o.end:0,i.end=i.start+i.delay+i.duration+i.endDelay,i.easing=W(i.easing,i.duration),i.isPath=N.pth(r),i.isPathTargetInsideSVG=i.isPath&&N.svg(e.target),i.isColor=N.col(i.from.original),i.isColor&&(i.round=1),o=i,i}))}(e,t),i=n[n.length-1];return{type:o,property:e.name,animatable:t,tweens:n,duration:i.end,delay:n[0].delay,endDelay:i.endDelay}}}(t,e)}))}))),(function(t){return!N.und(t)}))}function pt(t,e){var o=t.length,n=function(t){return t.timelineOffset?t.timelineOffset:0},i={};return i.duration=o?Math.max.apply(Math,t.map((function(t){return n(t)+t.duration}))):e.duration,i.delay=o?Math.min.apply(Math,t.map((function(t){return n(t)+t.delay}))):e.delay,i.endDelay=o?i.duration-Math.max.apply(Math,t.map((function(t){return n(t)+t.duration-t.endDelay}))):e.endDelay,i}var ut=0,_t=[],dt=function(){var t;function e(o){for(var n=_t.length,i=0;i<n;){var r=_t[i];r.paused?(_t.splice(i,1),n--):(r.tick(o),i++)}t=i>0?requestAnimationFrame(e):void 0}return"undefined"!=typeof document&&document.addEventListener("visibilitychange",(function(){xt.suspendWhenDocumentHidden&&(gt()?t=cancelAnimationFrame(t):(_t.forEach((function(t){return t._onDocumentVisibility()})),dt()))})),function(){t||gt()&&xt.suspendWhenDocumentHidden||!(_t.length>0)||(t=requestAnimationFrame(e))}}();function gt(){return!!document&&document.hidden}function xt(t){void 0===t&&(t={});var e,o=0,n=0,i=0,r=0,a=null;function s(t){var e=window.Promise&&new Promise((function(t){return a=t}));return t.finished=e,e}var l=function(t){var e=E(P,t),o=E(v,t),n=function(t,e){var o=[],n=e.keyframes;for(var i in n&&(e=V(function(t){for(var e=R(J(t.map((function(t){return Object.keys(t)}))),(function(t){return N.key(t)})).reduce((function(t,e){return t.indexOf(e)<0&&t.push(e),t}),[]),o={},n=function(n){var i=e[n];o[i]=t.map((function(t){var e={};for(var o in t)N.key(o)?o==i&&(e.value=t[o]):e[o]=t[o];return e}))},i=0;i<e.length;i++)n(i);return o}(n),e)),e)N.key(i)&&o.push({name:i,tweens:lt(e[i],t)});return o}(o,t),i=st(t.targets),r=ct(i,n),a=pt(r,o),s=ut;return ut++,V(e,{id:s,children:[],animatables:i,animations:r,duration:a.duration,delay:a.delay,endDelay:a.endDelay})}(t);function m(){var t=l.direction;"alternate"!==t&&(l.direction="normal"!==t?"normal":"reverse"),l.reversed=!l.reversed,e.forEach((function(t){return t.reversed=l.reversed}))}function h(t){return l.reversed?l.duration-t:t}function c(){o=0,n=h(l.currentTime)*(1/xt.speed)}function p(t,e){e&&e.seek(t-e.timelineOffset)}function u(t){for(var e=0,o=l.animations,n=o.length;e<n;){var i=o[e],r=i.animatable,a=i.tweens,s=a.length-1,m=a[s];s&&(m=R(a,(function(e){return t<e.end}))[0]||m);for(var h=M(t-m.start-m.delay,0,m.duration)/m.duration,c=isNaN(h)?1:m.easing(h),p=m.to.strings,u=m.round,_=[],d=m.to.numbers.length,g=void 0,x=0;x<d;x++){var C=void 0,f=m.to.numbers[x],P=m.from.numbers[x]||0;C=m.isPath?it(m.value,c*f,m.isPathTargetInsideSVG):P+c*(f-P),u&&(m.isColor&&x>2||(C=Math.round(C*u)/u)),_.push(C)}var v=p.length;if(v){g=p[0];for(var w=0;w<v;w++){p[w];var y=p[w+1],T=_[w];isNaN(T)||(g+=y?T+y:T+" ")}}else g=_[0];mt[i.type](r.target,i.property,g,r.transforms),i.currentValue=g,e++}}function _(t){l[t]&&!l.passThrough&&l[t](l)}function d(t){var c=l.duration,d=l.delay,g=c-l.endDelay,x=h(t);l.progress=M(x/c*100,0,100),l.reversePlayback=x<l.currentTime,e&&function(t){if(l.reversePlayback)for(var o=r;o--;)p(t,e[o]);else for(var n=0;n<r;n++)p(t,e[n])}(x),!l.began&&l.currentTime>0&&(l.began=!0,_("begin")),!l.loopBegan&&l.currentTime>0&&(l.loopBegan=!0,_("loopBegin")),x<=d&&0!==l.currentTime&&u(0),(x>=g&&l.currentTime!==c||!c)&&u(c),x>d&&x<g?(l.changeBegan||(l.changeBegan=!0,l.changeCompleted=!1,_("changeBegin")),_("change"),u(x)):l.changeBegan&&(l.changeCompleted=!0,l.changeBegan=!1,_("changeComplete")),l.currentTime=M(x,0,c),l.began&&_("update"),t>=c&&(n=0,l.remaining&&!0!==l.remaining&&l.remaining--,l.remaining?(o=i,_("loopComplete"),l.loopBegan=!1,"alternate"===l.direction&&m()):(l.paused=!0,l.completed||(l.completed=!0,_("loopComplete"),_("complete"),!l.passThrough&&"Promise"in window&&(a(),s(l)))))}return s(l),l.reset=function(){var t=l.direction;l.passThrough=!1,l.currentTime=0,l.progress=0,l.paused=!0,l.began=!1,l.loopBegan=!1,l.changeBegan=!1,l.completed=!1,l.changeCompleted=!1,l.reversePlayback=!1,l.reversed="reverse"===t,l.remaining=l.loop,e=l.children;for(var o=r=e.length;o--;)l.children[o].reset();(l.reversed&&!0!==l.loop||"alternate"===t&&1===l.loop)&&l.remaining++,u(l.reversed?l.duration:0)},l._onDocumentVisibility=c,l.set=function(t,e){return ht(t,e),l},l.tick=function(t){i=t,o||(o=i),d((i+(n-o))*xt.speed)},l.seek=function(t){d(h(t))},l.pause=function(){l.paused=!0,c()},l.play=function(){l.paused&&(l.completed&&l.reset(),l.paused=!1,_t.push(l),c(),dt())},l.reverse=function(){m(),l.completed=!l.reversed,c()},l.restart=function(){l.reset(),l.play()},l.remove=function(t){ft(at(t),l)},l.reset(),l.autoplay&&l.play(),l}function Ct(t,e){for(var o=e.length;o--;)D(t,e[o].animatable.target)&&e.splice(o,1)}function ft(t,e){var o=e.animations,n=e.children;Ct(t,o);for(var i=n.length;i--;){var r=n[i],a=r.animations;Ct(t,a),a.length||r.children.length||n.splice(i,1)}o.length||n.length||e.pause()}xt.version="3.2.1",xt.speed=1,xt.suspendWhenDocumentHidden=!0,xt.running=_t,xt.remove=function(t){for(var e=at(t),o=_t.length;o--;)ft(e,_t[o])},xt.get=$,xt.set=ht,xt.convertPx=U,xt.path=function(t,e){var o=N.str(t)?F(t)[0]:t,n=e||100;return function(t){return{property:t,el:o,svg:nt(o),totalLength:ot(o)*(n/100)}}},xt.setDashoffset=function(t){var e=ot(t);return t.setAttribute("stroke-dasharray",e),e},xt.stagger=function(t,e){void 0===e&&(e={});var o=e.direction||"normal",n=e.easing?W(e.easing):null,i=e.grid,r=e.axis,a=e.from||0,s="first"===a,l="center"===a,m="last"===a,h=N.arr(t),c=h?parseFloat(t[0]):parseFloat(t),p=h?parseFloat(t[1]):0,u=j(h?t[1]:t)||0,_=e.start||0+(h?c:0),d=[],g=0;return function(t,e,x){if(s&&(a=0),l&&(a=(x-1)/2),m&&(a=x-1),!d.length){for(var C=0;C<x;C++){if(i){var f=l?(i[0]-1)/2:a%i[0],P=l?(i[1]-1)/2:Math.floor(a/i[0]),v=f-C%i[0],w=P-Math.floor(C/i[0]),y=Math.sqrt(v*v+w*w);"x"===r&&(y=-v),"y"===r&&(y=-w),d.push(y)}else d.push(Math.abs(a-C));g=Math.max.apply(Math,d)}n&&(d=d.map((function(t){return n(t/g)*g}))),"reverse"===o&&(d=d.map((function(t){return r?t<0?-1*t:-t:Math.abs(g-t)})))}return _+(h?(p-c)/g:c)*(Math.round(100*d[e])/100)+u}},xt.timeline=function(t){void 0===t&&(t={});var e=xt(t);return e.duration=0,e.add=function(o,n){var i=_t.indexOf(e),r=e.children;function a(t){t.passThrough=!0}i>-1&&_t.splice(i,1);for(var s=0;s<r.length;s++)a(r[s]);var l=V(o,E(v,t));l.targets=l.targets||t.targets;var m=e.duration;l.autoplay=!1,l.direction=e.direction,l.timelineOffset=N.und(n)?m:Q(n,m),a(e),e.seek(l.timelineOffset);var h=xt(l);a(h),r.push(h);var c=pt(r,t);return e.delay=c.delay,e.endDelay=c.endDelay,e.duration=c.duration,e.seek(0),e.reset(),e.autoplay&&e.play(),e},e},xt.easing=W,xt.penner=O,xt.random=function(t,e){return Math.floor(Math.random()*(e-t+1))+t};const Pt=xt;class vt{constructor(t){this._hierachy=t,this._animations=[],this.name=""}getAnimations(){return this._animations}getAnimationByIndex(t){return this._animations[t]}addAnimation(t,e){this._animations.push({animation:t,component:e})}setName(t){this.name=t}getName(){return this.name}toJson(){return{animations:this._animations,name:this.name}}fromJson(t){this._animations=t.animations,this.name=t.name}play(){for(let t=0;t<this._animations.length;t++){let e=this._animations[t],o=bt.getAnimationTemplate(e.animation),n=this._hierachy.getComponentHash()[e.component];bt.startAnimation(n,o)}}}class wt{static fromJson(t,e){return new wt(t.name,e,t.animedef)}constructor(t,e,o){this.name=t,this._component=e,this._done=!1;let n=this;this.value=this._component.getCurrentValue(),null!=o.infinite&&o.infinite?(this.type=1,this.startTime=Date.now(),this.lasttime=this.startTime,this.easeInTime=parseInt(o.easeintime)/1e3,this.target=parseInt(o.value),this.previoustarget=0):(this.type=0,null!=o.startcolor&&(this.color=o.startcolor,o.startcolor=void 0,o.color=o.endcolor,o.endcolor=void 0),o.targets=this,o.autoplay=!1,o.complete=function(){n.anime.remove(),n._done=!0},this.anime=Pt(o))}getName(){return this.name}getComponent(){return this._component}getDone(){return this._done}setDone(t){this._done=t}update(t){if(null!=this.color){this.anime.tick(t);let e=this._component.getReferenceNodes();for(let t=0;t<e.length;t++){let o=this.color.substring(5,this.color.length-1).split(",");bt.viewer.model.setNodesFaceColor([e[t].nodeid],new Communicator.Color(parseInt(o[0]),parseInt(o[1]),parseInt(o[2])))}}else{if(1==this.type){let t=Date.now(),e=(t-this.lasttime)/1e3,o=(t-this.startTime)/1e3,n=this.target;o<this.easeInTime&&(n=this.easeInQuad(o,this.previoustarget,this.target-this.previoustarget,this.easeInTime));let i=this.value+e*n;this._component.set(i),this.lasttime=t,this.value=i}else this.anime.tick(t),this._component.set(parseFloat(this.value));this._component._touched=!0}}changeAnimationSpeed(t){this.previoustarget=this.target,this.target=t,this.startTime=Date.now(),this.lasttime=Date.now()}easeInQuad(t,e,o,n){return o*(t/=n)*t+e}}class yt{constructor(){this._templateId=null,this._highestId=0,this._nodeid=void 0,this._componentNodeidHash=[],this._componentHash=[],this._ikTip=new Communicator.Point3(0,0,0),this._ikThreshold=1,this._ikSpeed=100,this._ikSamplingDistance=.1,this._ikSamplingDistanceTranslation=1,this._ikLearningRate=.1,this._interval=null,this._targetPoint=new Communicator.Point3(0,0,0),this._rootComponent=this.createComponent(null,[],!0),this._rootComponent.setType(C.fixed),this._tipComponent=null,this._targetAnchorPosition=null,this._targetAnchorNode=null,this._dirty=!1}getComponentHash(){return this._componentHash}getRootComponent(){return this._rootComponent}getComponentById(t){let e=this._componentHash[t];return null!=e?e:null}getTemplateId(){return this._templateId}generateTemplate(){if(this._templateId){let t=this.toJson(this);bt.updateTemplate(t)}else{this._templateId=o.generateGUID();let t=this.toJson();bt.addTemplate(t)}}async _updateComponentsRecursive(t){if(t&&(await t._execute(),await t._updateReferenceNodeMatrices(),t._children.length>0))for(let e=0;e<t._children.length;e++)await this._updateComponentsRecursive(t._children[e])}async updateComponents(){await this._updateComponentsRecursive(this._rootComponent),await this._updateComponentsRecursive(this._rootComponent)}setIkTip(t){this._ikTip=t}getIkTip(){return this._ikTip}setIkThreshold(t){this._ikThreshold=t}getIkThreshold(){return this._ikThreshold}setIkSpeed(t){this._ikSpeed=t}getIkSpeed(){return this._ikSpeed}setIkSamplingDistance(t){this._ikSamplingDistance=t}getIkSamplingDistance(){return this._ikSamplingDistance}setIkSamplingDistanceTranslation(t){this._ikSamplingDistanceTranslation=t}getIkSamplingDistanceTranslation(){return this._ikSamplingDistanceTranslation}setIkLearningRate(t){this._ikLearningRate=t}getIkLearningRate(){return this._ikLearningRate}isIKActive(){return!!this._interval}stopIK(){this._interval&&(clear_interval(this._interval),this._interval=null)}startIKFromHandle(){if(!this._interval){let t=this,e=bt.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);this._interval=set_interval((async function(){if(e.getPosition()||t._targetAnchorPosition){if(t._targetAnchorPosition){let e=bt.viewer.model.getNodeNetMatrix(t._targetAnchorNode);t._targetPoint=e.transform(t._targetAnchorPosition)}else{let e=bt.viewer.model.getNodeMatrix(bt.handleNode);t._targetPoint=e.transform(new Communicator.Point3(0,0,0))}for(let e=0;e<t._ikSpeed;e++)t.distanceFromIKTarget()>t._ikThreshold&&await t._inverseKinematics()}}),1)}}insertIKHandle(){let t=bt.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);t.removeHandles(),t.addHandles([bt.handleNode],this._targetPoint),bt.viewer.model.setNodesVisibility([bt.handleNode],!0),t.showHandles()}setIKHandleToTip(t){let e=this.getReferenceNodeNetMatrix(this._tipComponent),o=e.transform(this._ikTip);e=new Communicator.Matrix,e.setTranslationComponent(o.x,o.y,o.z),this._targetPoint=o.copy(),bt.viewer.model.setNodeMatrix(bt.handleNode,e),t&&this.insertIKHandle()}setTipToHandlePosition(){let t=bt.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).getPosition();this._ikTip=this._tipComponent.transformPointToComponentSpace(t)}setTargetAnchorToHandlePosition(){let t=bt.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).getPosition(),e=bt.viewer.selectionManager.getResults()[0].getNodeId(),o=Communicator.Matrix.inverse(bt.viewer.model.getNodeNetMatrix(e));this._targetAnchorPosition=o.transform(t),this._targetAnchorNode=e}distanceFromIKTarget(){let t=this.getReferenceNodeNetMatrix(this._tipComponent).transform(this._ikTip);return Communicator.Point3.subtract(this._targetPoint,t).length()}removeAnimationFromComponents(t){this._rootComponent.removeAnimationRecursive(t)}toJson(){let t={version:bt.getVersion(),_ikTip:this._ikTip.toJson(),_templateId:this._templateId,_ikSamplingDistance:this._ikSamplingDistance,_ikSamplingDistanceTranslation:this._ikSamplingDistanceTranslation,_ikLearningRate:this._ikLearningRate,_ikThreshold:this._ikThreshold,_ikSpeed:this._ikSpeed,_targetAnchorNode:this._targetAnchorNode};this._targetAnchorPosition&&(t._targetAnchorPosition=this._targetAnchorPosition.toJson()),t.components=this._rootComponent.toJson();let e=[],o=[];this._rootComponent.animToJson(e);for(let t in e){let e=bt.getAnimationTemplate(t);null!=e&&(e._templateId=t,o.push(e))}t.animations=o,t.animationGroups=[];for(let e=0;e<bt._animationGroups.length;e++){let o=bt._animationGroups[e];o._hierachy==this&&t.animationGroups.push(o.toJson())}return t}fromJson(t){this._highestId=0,this._ikTip=Communicator.Point3.fromJson(t._ikTip),this._ikThreshold=t._ikThreshold,this._ikSpeed=t._ikSpeed,this._ikSamplingDistance=t._ikSamplingDistance,this._ikSamplingDistanceTranslation=t._ikSamplingDistanceTranslation,this._ikLearningRate=t._ikLearningRate,this._targetAnchorNode=t._targetAnchorNode,this._templateId=t._templateId,t._targetAnchorPosition&&(this._targetAnchorPosition=Communicator.Point3.fromJson(t._targetAnchorPosition));let e=new f(null,this);for(e.fromJson(t.components,t.version),this._rootComponent=e;;){if(0==e.getChildren().length){this._tipComponent=e;break}e=e.getChildren()[0]}for(let t in this._componentHash){let e=this._componentHash[t];e.getBehavior()&&e.getBehavior().jsonFixup()}if(null!=t.animations)for(let e=0;e<t.animations.length;e++)bt.addAnimationTemplateFromJson(t.animations[e]._templateId,t.animations[e]);if(null!=t.animationGroups)for(let e=0;e<t.animationGroups.length;e++){let o=new vt(this);o.fromJson(t.animationGroups[e]),bt.addAnimationGroup(o)}return t}resetComponents(){let t=this._rootComponent;for(;t.reset(),0!=t.getChildren().length;)t=t.getChildren()[0];this._interval&&(clear_interval(this._interval),this._interval=null)}createComponent(t,e,o,n){let i=!0;null!=o&&0==o&&(i=!1);let r=new f(t,this);this._componentHash[r.getId()]=r,r.initialize(e,i),null==t?this._rootComponent=r:n?t.getChildren().unshift(r):t.getChildren().push(r),this._tipComponent=this._findTipComponent();for(let t=0;t<e.length;t++)this._componentNodeidHash[e[t]]=r;return r}createComponentFromSelection(t,e,o){let n=[],i=bt.viewer.selectionManager.getResults();for(let t=0;t<i.length;t++)n.push(i[t].getNodeId());let r=this.createComponent(t,n,e,o);return r.setParametersFromHandle(),r}async rebuildComponentTree(){bt.viewer.model.deleteNode(this._rootComponent.getNodeId()),this._rebuildComponentTreeRecursive(this._rootComponent)}applyToModel(t){this._componentNodeidHash=[];let e,o=bt.viewer.model.getNodeChildren(t)[0];e=t==bt.viewer.model.getRootNode()||null==t?new Communicator.Matrix:bt.viewer.model.getNodeMatrix(t),this._applyToModelRecursive(this._rootComponent,bt.viewer.model.getNodeIdOffset(o),e)}getReferenceNodeNetMatrix(t){return bt.viewer.model.getNodeNetMatrix(t.getNodeId())}_applyToModelRecursive(t,e,o){this._componentNodeidHash[t.getNodeId()]=t;let n=o.transform(Communicator.Point3.add(t.getCenter(),t.getAxis()));t.setCenter(o.transform(t.getCenter())),t.setAxis(Communicator.Point3.subtract(n,t.getCenter()).normalize()),t._parentMatrix=Communicator.Matrix.multiply(t.getParentMatrix(),o),t.fixedAxis&&(t.fixedAxis=o.transform(t.fixedAxis));let i=t.getReferenceNodes();for(let n=0;n<i.length;n++)i[n].nodeid=e+i[n].nodeid,i[n].matrix=Communicator.Matrix.multiply(i[n].matrix,o),this._componentNodeidHash[i[n].nodeid]=t;if(t.getChildren().length>0)for(let n=0;n<t.getChildren().length;n++)this._applyToModelRecursive(t.getChildren()[n],e,o)}setDirty(t){this._dirty=!0}getDirty(){return this._dirty}setNodeId(t){this._nodeid=t}_findTipComponent(){let t=this._rootComponent;for(;0!=t.getChildren().length;)t=t.getChildren()[0];return t}_rebuildComponentTreeRecursive(t){if(t.getParent()?t.setNodeId(bt.viewer.model.createNode(t.getParent().getNodeId(),"component")):t.setNodeId(bt.viewer.model.createNode(bt.viewer.model.getRootNode(),"_rootComponent")),t.getChildren().length>0)for(let e=0;e<t.getChildren().length;e++)this._rebuildComponentTreeRecursive(t.getChildren()[e])}async _inverseKinematics(){let t=this._rootComponent;for(;;){if(t.getType()!=C.fixed&&null==t.fixedAxis&&t.getType()!=C.pistonController&&t.getType()!=C.prismaticAggregate){let e=await t.calculateGradient();await t.update(e)}if(t.getType()==C.prismaticAggregate){let e=await t.getBehavior().getExtraComponent1().calculateGradient();await t.getBehavior().getExtraComponent1().update(e),e=await t.getBehavior().getExtraComponent2().calculateGradient(),await t.getBehavior().getExtraComponent2().update(e)}if(0==t.getChildren().length||t.getType()==C.fixed&&t!=this._rootComponent)break;t=t.getChildren()[0]}await this._rootComponent.updateComponentsFromReference()}}class Mt{constructor(t){this._viewer=t,this._activeHighlight=null,this._currentSelItem=null,this._axis=null,this._axis2=null}getPosition(){return this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).getPosition()}getAxis(){return this._axis}getSecondAxis(){return this._axis2}setAxis(t){this._axis=t}setSecondAxis(t){this._axis2=t}insertHandles(t){let e=this._currentSelItem,o=e.getNodeId(),n=e.getFaceEntity(),i=e.getLineEntity();if(null!==i||null!=n){let r,a=this._viewer.selectionManager.getResults();if(a.length>0){r=[];for(let t=0;t<a.length;t++)r.push(a[t].getNodeId())}else r=[o];if(null!=i){let t=i.getPoints();if(2===t.length){let e=Communicator.Point3.subtract(t[1],t[0]);this._axis=e.copy();let o=e.length(),n=t[0].copy().add(e.normalize().scale(o/2));this._addAxisTranslationHandle(n,e,r),this._addAxisTranslationHandle(n,e.copy().scale(-1),r),this._addAxisRotationHandle(n,e,r)}else this._getArcCenter(e).then((t=>{let e=this._viewer.model.getNodeNetMatrix(this._viewer.model.getNodeParent(o)),n=e.transform(new Communicator.Point3(0,0,0)),i=e.transform(t.normal),a=Communicator.Point3.cross(new Communicator.Point3(1,0,0),t.normal);a.length()<1e-5&&(a=Communicator.Point3.cross(new Communicator.Point3(0,1,0),t.normal));let s=e.transform(a),l=Communicator.Point3.subtract(i,n),m=Communicator.Point3.subtract(s,n);this._axis=l.copy(),this._axis2=m.copy();let h=t.center;this._addAxisTranslationHandle(h,l,r),this._addAxisTranslationHandle(h,l.copy().scale(-1),r),this._addAxisRotationHandle(h,l,r),this._addAxisTranslationHandle(h,m,r)}))}else{let e=n.getNormal(),o=n.getPosition().copy();if(o=n.getBounding().center().copy(),t)this._addMainHandle(r,o);else{let t=Communicator.Point3.cross(new Communicator.Point3(1,0,0),e);t.length()<1e-5&&(t=Communicator.Point3.cross(new Communicator.Point3(0,1,0),e)),this._axis=e.copy(),this._axis2=t.copy(),this._addAxisTranslationHandle(o,e,r),this._addAxisTranslationHandle(o,e.copy().scale(-1),r),this._addAxisRotationHandle(o,e,r),this._addAxisTranslationHandle(o,t,r)}}}}onMouseDown(t){if(t.shiftDown())return this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).removeHandles(),this._axis=null,this._axis2=null,t.controlDown()?(this._addAxisTranslationHandle(this._currentSelItem.getPosition(),new Communicator.Point3(0,0,1),[]),void t.setHandled(!0)):(this.insertHandles(t.altDown()),void t.setHandled(!0))}onMouseMove(t){if(t.shiftDown()){let e=t.getPosition(),o=this._viewer.view,n=new Communicator.PickConfig(Communicator.SelectionMask.Line);o.pickFromPoint(e,n).then((t=>{this._currentSelItem=t;let e=t.getNodeId();if(null!==e){if(this._viewer.model.getNodeType(e)!==Communicator.NodeType.BodyInstance)return;null!==this._activeHighlight?t.equals(this._activeHighlight)||(this._setNodeLineHighlighted(this._activeHighlight,!1),this._setNodeLineHighlighted(t,!0)):this._setNodeLineHighlighted(t,!0)}else null!==this._activeHighlight&&this._setNodeLineHighlighted(this._activeHighlight,!1)}))}else null!==this._activeHighlight&&this._setNodeLineHighlighted(this._activeHighlight,!1)}onMouseUp(t){t.shiftDown()&&t.setHandled(!0)}_setNodeLineHighlighted(t,e){if(null!==t){let o=t.getNodeId(),n=t.getLineEntity();if(null!==o&&null!==n){let i=n.getLineId();this._viewer.model._setNodeLineHighlighted(o,i,e),this._activeHighlight=e?t:null}}}_getArcCenter(t){let e=t.getNodeId(),o=t.getLineEntity();if(null!==e&&null!==o){let t=this._viewer.model;return t.getEdgeProperty(e,o.getLineId()).then((n=>{if(n instanceof Communicator.SubentityProperties.CircleElement){const o=n.origin;return t.getNodeNetMatrix(e).transform(o,o),{center:o,normal:n.normal}}if(n instanceof Communicator.SubentityProperties.LineElement){const t=o.getPoints();if(2===t.length)return Communicator.Point3.add(t[1],t[0]).scale(.5)}return null}))}return Promise.resolve(null)}_addMainHandle(t,e){let o=this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);o.addHandles(t,e),o.showHandles()}_addAxisRotationHandle(t,e,o,n){n||(n=Communicator.Color.red());let i=this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);i.addAxisRotationHandle(t,e,n),i.setNodeIds(o),i.showHandles()}_addAxisTranslationHandle(t,e,o,n){n||(n=Communicator.Color.red());let i=this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);i.addAxisTranslationHandle(t.copy(),e,n),i.setNodeIds(o),i.showHandles()}}class Tt{constructor(t){this._viewer=t,this._mouseDown=!1,this._component=null,this._disabled=!1}disable(){bt.viewer.selectionManager.clear(),this._disabled=!0}enable(){this._disabled=!1}onMouseDown(t){this._component&&!this._disabled&&(this._mouseDown=!0,this._startPosition=t.getPosition().copy(),this._currentcpos=this._component.getCurrentValue(),t.setHandled(!0))}onMouseMove(t){if(this._disabled)return;let e=t.getPosition();if(this._mouseDown){var o=t.getPosition();this._component.set(this._currentcpos+(o.x-this._startPosition.x)/2),this._component.getHierachy().updateComponents()}else{if(t.getButtons()!=Communicator.Buttons.None)return;let o=this._viewer.view,n=new Communicator.PickConfig(Communicator.SelectionMask.Line);this._component=null,bt.viewer.selectionManager.clear(),o.pickFromPoint(e,n).then((t=>{let e=t.getNodeId();if(e){let t=null;for(;t=bt.getComponentFromNodeId(e),null===t&&(e=this._viewer.model.getNodeParent(e),e!=this._viewer.model.getRootNode()););null!==t&&(t.getBehavior().getMovementType()!==C.revolute&&t.getBehavior().getMovementType()!==C.prismatic||t.getAnimationActive()||(t.selectReferenceNodes(),this._component=t))}}))}}onMouseUp(t){this._mouseDown&&!this._disabled&&(this._mouseDown=!1,this._component=null,t.setHandled(!0))}}class bt{static initialize(t){bt.viewer=t,bt._hierachies=[],bt._customTypeCallback=null,bt._hierachyTemplates=[],bt._animationTemplates=[],bt._animations=[],bt._animationGroups=[],bt.handlePlacementOperator=null,bt.componentMoveOperator=null,bt._version="0.9.0"}static getVersion(){return bt._version}static getHandleOperator(){return bt.handlePlacementOperator}static setupHandleOperator(){bt.handlePlacementOperator=new Mt(bt.viewer);let t=bt.viewer.operatorManager.registerCustomOperator(bt.handlePlacementOperator);bt.viewer.operatorManager.push(t),bt.handleNode=bt.viewer.model.createNode(bt.viewer.model.getRootNode(),"handlenode")}static setupComponentMoveOperator(){if(bt.componentMoveOperator)bt.componentMoveOperator.enable();else{bt.componentMoveOperator=new Tt(bt.viewer);let t=bt.viewer.operatorManager.registerCustomOperator(bt.componentMoveOperator);bt.viewer.operatorManager.push(t)}}static disableComponentMoveOperator(){bt.componentMoveOperator.disable()}static getHierachyTemplates(){return bt._hierachyTemplates}static getHierachies(){return bt._hierachies}static getAnimationTemplates(){return bt._animationTemplates}static getAnimationTemplate(t){return bt._animationTemplates[t]}static getAnimationGroups(){return bt._animationGroups}static getHierachyByIndex(t){return bt._hierachies[t]}static getComponentFromNodeId(t){for(let e=0;e<bt._hierachies.length;e++){let o=bt._hierachies[e]._componentNodeidHash[t];if(null!=o)return o}return null}static getHierachyFromNodeId(t){if(null!=t&&t!=bt.viewer.model.getRootNode())for(;bt.viewer.model.getNodeParent(t)!=bt.viewer.model.getRootNode();)t=bt.viewer.model.getNodeParent(t);for(let e=0;e<bt._hierachies.length;e++)if(bt._hierachies[e].nodeid==t)return e}static applyToModel(t,e){let o=new yt;return o.fromJson(bt._hierachyTemplates[t]),o.applyToModel(e),o.setNodeId(e),bt._hierachies.push(o),o}static createHierachy(){let t=new yt;return this._hierachies.push(t),t}static addTemplate(t){return bt._hierachyTemplates[t._templateId]=t,t._templateId}static updateTemplate(t){bt._hierachyTemplates[t._templateId]=t}static getTemplate(t){return bt._hierachyTemplates[t]}static updateAnimationTemplate(t,e,o){let n=bt._animationTemplates[t];n.name=e,n.anime=o,bt._animationTemplates[t]=JSON.parse(JSON.stringify(n))}static addAnimationTemplate(t,e){let n={name:t,anime:e};n=JSON.parse(JSON.stringify(n));let i=o.generateGUID();return bt._animationTemplates[i]=n,i}static addAnimationTemplateFromJson(t,e){let o=JSON.parse(JSON.stringify(e));bt._animationTemplates[t]=o}static startAnimation(t,e){t.setAnimationActive(!0);let o=new wt("test",t,JSON.parse(JSON.stringify(e.anime)));bt._animations.push(o),1==bt._animations.length&&window.requestAnimationFrame(bt._doAnimation)}static stopAnimation(t){for(let e=0;e<bt._animations.length;e++)null!=t&&bt._animations[e].getComponent()!=t||bt._animations[e].setDone(!0)}static changeAnimationSpeed(t,e){for(let o=0;o<bt._animations.length;o++)bt._animations[o].component==t&&bt._animations[o].changeAnimationSpeed(e)}static deleteAnimationTemplate(t){delete bt._animationTemplates[t];for(let e=0;e<bt._hierachies.length;e++)bt._hierachies[e].removeAnimationFromComponents(t)}static addAnimationGroup(t){return bt._animationGroups.push(t),bt._animationGroups.length-1}static startAnimationGroup(t){bt._animationGroups[t].play()}static setCustomBehaviorCreationCallback(t){bt._customTypeCallback=t}static getCustomTypeCallback(){return bt._customTypeCallback}static _doAnimation(t){if(bt._animations.length>0){for(let t=0;t<bt._hierachies.length;t++)bt._hierachies[t].setDirty(!1);for(let e=0;e<bt._animations.length;e++)bt._animations[e].getComponent().getHierachy().setDirty(!0),bt._animations[e].update(t),bt._animations[e].getDone()&&(bt._animations[e].getComponent().setAnimationActive(!1),bt._animations.splice(e,1),e--);for(let t=0;t<bt._hierachies.length;t++)bt._hierachies[t].getDirty()&&bt._hierachies[t].updateComponents();window.requestAnimationFrame(bt._doAnimation)}}}KT=e})();