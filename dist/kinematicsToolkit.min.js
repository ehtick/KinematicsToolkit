var KT;(()=>{"use strict";var t={d:(e,n)=>{for(var i in n)t.o(n,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:n[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{KinematicsAnimationGroup:()=>lt,KinematicsBelt:()=>o,KinematicsComponent:()=>a,KinematicsHierachy:()=>ht,KinematicsManager:()=>ut,componentType:()=>r});class n{static nearestPointOnLine(t,e,n){e.normalize();var i=Communicator.Point3.subtract(n,t),o=Communicator.Point3.dot(i,e),r=Communicator.Point3.add(t,Communicator.Point3.scale(e,o));return Communicator.Point3.subtract(r,n),r}static closestPointOnPlane(t,e){let n=Communicator.Point3.dot(t.normal,e)+t.d;return Communicator.Point3.subtract(e,new Communicator.Point3(n*t.normal.x,n*t.normal.y,n*t.normal.z))}static signedAngle(t,e,n){return Math.atan2(Communicator.Point3.dot(Communicator.Point3.cross(t,e),n),Communicator.Point3.dot(t,e))*(180/Math.PI)}static ComputeVectorToVectorRotationMatrix(t,e){const n=1e-7;t.normalize(),e.normalize();let i=Communicator.Point3.cross(t,e),o=Communicator.Point3.dot(t,e),r=i.length();if(r>-1e-7&&r<n){if(!(o<0))return new Communicator.Matrix;if(t.x<-1e-7||t.x>n)i.x=t.y,i.y=-t.x,i.z=0;else if(t.y<-1e-7||t.y>n)i.x=-t.y,i.y=t.x,i.z=0;else{if(!(t.z<-1e-7||t.z>n))return new Communicator.Matrix;i.x=-t.z,i.z=t.x,i.y=0}}var a=Math.atan2(r,o);return a*=180/Math.PI,Communicator.Matrix.createFromOffAxisRotation(i,a)}static generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}static computeOffaxisRotationMatrix(t,e,n){let i=new Communicator.Matrix,o=new Communicator.Matrix;o=new Communicator.Matrix,o.setTranslationComponent(-t.x,-t.y,-t.z);let r=new Communicator.Matrix;r.setTranslationComponent(t.x,t.y,t.z),Communicator.Util.computeOffaxisRotation(e,n,i);let a=Communicator.Matrix.multiply(o,i);return Communicator.Matrix.multiply(a,r)}static circleIntersection(t,e,n,i,o,r){let a,s,l,m,h,c,p,u,d;if(s=i-t,l=o-e,m=Math.sqrt(l*l+s*s),m>n+r)return!1;if(m<Math.abs(n-r))return!1;a=(n*n-r*r+m*m)/(2*m),u=t+s*a/m,d=e+l*a/m,h=Math.sqrt(n*n-a*a),c=h/m*-l,p=s*(h/m);let _=u+c,g=u-c,f=d+p,x=d-p;return{p1:new Communicator.Point3(_,f,0),p2:new Communicator.Point3(g,x,0)}}}class o{constructor(){this._wheels=[],this._poslookup=[],this._baseNode=null,this._nodeids=[],this._segmentnum=500,this._width=10,this._thickness=10,this._gap=.1,this._tracks=0,this._alignvector=null,this._trackorientation=!1,this._color1=new Communicator.Color(64,64,64),this._color2=new Communicator.Color(20,20,20)}getBaseNode(){return this._baseNode}getWidth(){return this._width}setWidth(t){this._width=t}setSegmentNum(t){this._segmentnum=t}getSegmentNum(){return this._segmentnum}setThickness(t){this._thickness=t}getThickness(){return this._thickness}setGap(t){this._gap=t}getGap(){return this._gap}setTracks(t){this._tracks=t}getTracks(){return this._tracks}setTrackOrientation(t){this._trackorientation=t}getTrackOrientation(){return this._trackorientation}setAlignVector(t){this._alignvector=t}getAlignVector(){return this._alignvector}setColor1(t){this._color1=t}getColor1(){return this._color1}setColor2(t){this._color2=t}getColor2(){return this._color2}getWheelByIndex(){return this._wheels[i]}getWheels(){return this._wheels}initializeWheels(){this.calcuateAlignMatrix();for(let t=0;t<this._wheels.length;t++){let e=this._wheels[t],n=this.alignmatrix.transform(e.component.getCenter());e.pos=new Communicator.Point3(n.x,n.y,0)}}addWheel(){this._wheels.push({pos:null,radius:0,component:null,inner:!1,other:!1})}insertWheel(t){this_wheels.splice(t,0,{pos:null,radius:0,component:null,inner:!1,other:!1})}deleteWheel(t){this_wheels.splice(t,1)}toJson(){let t={alignvector:this._alignvector?this._alignvector.toJson():null,wheels:[],segmentnum:this._segmentnum,width:this._width,thickness:this._thickness,gap:this._gap,tracks:this._tracks,trackorientation:this._trackorientation,color1:this._color1.toJson(),color2:this._color2.toJson()};for(let e=0;e<this._wheels.length;e++)t.wheels.push({radius:this._wheels[e].radius,component:this._wheels[e].component.getId(),inner:this._wheels[e].inner,other:this._wheels[e].other});return t}fromJson(t,e){this._segmentnum=t.segmentnum,t.width&&(this._width=t.width),t.thickness&&(this._thickness=t.thickness),t.color1&&(this._color1=Communicator.Color.fromJson(t.color1)),t.alignvector&&(this._alignvector=Communicator.Point3.fromJson(t.alignvector)),t.color2&&(this._color2=Communicator.Color.fromJson(t.color2)),this._gap=t.gap,this._tracks=t.tracks,t.trackorientation&&(this._trackorientation=t.trackorientation);for(let n=0;n<t.wheels.length;n++)this._wheels.push({pos:null,radius:t.wheels[n].radius,component:e.getHierachy().getComponentHash()[t.wheels[n].component],inner:t.wheels[n].inner,other:t.wheels[n].other});return t}calcuateAlignMatrix(){let t;this._wheels.length>2&&!this._alignvector?(t=Communicator.Plane.createFromPoints(this._wheels[0].component.getCenter(),this._wheels[1].component.getCenter(),this._wheels[2].component.getCenter()),this.alignmatrix=n.ComputeVectorToVectorRotationMatrix(t.normal,new Communicator.Point3(0,0,1))):this._alignvector?this.alignmatrix=n.ComputeVectorToVectorRotationMatrix(this._alignvector,new Communicator.Point3(0,0,1)):this.alignmatrix=n.ComputeVectorToVectorRotationMatrix(new Communicator.Point3(1,0,0),new Communicator.Point3(0,0,1));let e=this.alignmatrix.transform(this._wheels[0].component.getCenter()),i=new Communicator.Matrix;i.setTranslationComponent(0,0,-e.z),this.alignmatrix=Communicator.Matrix.multiply(this.alignmatrix,i)}addBoxMesh(t,e,n,i){let o=[t.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,e.z,e.x,e.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,e.x,e.y,t.z,t.x,e.y,t.z,t.x,t.y,t.z,e.x,e.y,t.z,t.x,t.y,t.z,e.x,t.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,t.x,e.y,t.z,e.x,e.y,e.z,t.x,e.y,e.z,t.x,t.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,e.z,e.x,t.y,e.z,t.x,e.y,t.z,t.x,e.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,t.y,e.z,t.x,t.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,e.y,e.z,e.x,t.y,t.z,e.x,t.y,e.z],r=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0];for(let t=0;t<o.length;t++)n.push(o[t]);for(let t=0;t<r.length;t++)i.push(r[t])}async createMesh(t,e,n){let i=new Communicator.MeshData;i.setFaceWinding(Communicator.FaceWinding.Clockwise);let o=[],r=[];if(0==n)this.addBoxMesh(new Communicator.Point3(-e.x,-e.y,-e.z),new Communicator.Point3(e.x,e.y,e.z),o,r);else{this._trackorientation?this.addBoxMesh(new Communicator.Point3(-e.x,0,-e.z),new Communicator.Point3(e.x,e.y,e.z),o,r):this.addBoxMesh(new Communicator.Point3(-e.x,-e.y,-e.z),new Communicator.Point3(e.x,0,e.z),o,r);let t=2*e.x/(3*n),i=-e.x+t/2;for(let a=0;a<n;a++)this._trackorientation?this.addBoxMesh(new Communicator.Point3(i,-e.y,-e.z),new Communicator.Point3(i+2*t,0,e.z),o,r):this.addBoxMesh(new Communicator.Point3(i,0,-e.z),new Communicator.Point3(i+2*t,e.y,e.z),o,r),i+=2*t+t}return i.addFaces(o,r),await t.model.createMesh(i)}findCircleTangents(t,e){let n=t.pos.x,i=t.pos.y,o=e.pos.x,r=e.pos.y,a=t.radius,s=e.radius+1e-6,l=(o*a-n*s)/(a-s),m=(r*a-i*s)/(a-s),h=(Math.pow(a,2)*(l-n)+a*(m-i)*Math.sqrt(Math.pow(l-n,2)+Math.pow(m-i,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(m-i,2))+n,c=(Math.pow(a,2)*(l-n)-a*(m-i)*Math.sqrt(Math.pow(l-n,2)+Math.pow(m-i,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(m-i,2))+n,p=(Math.pow(a,2)*(m-i)-a*(l-n)*Math.sqrt(Math.pow(l-n,2)+Math.pow(m-i,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(m-i,2))+i,u=(Math.pow(a,2)*(m-i)+a*(l-n)*Math.sqrt(Math.pow(l-n,2)+Math.pow(m-i,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(m-i,2))+i,d=(Math.pow(s,2)*(l-o)+s*(m-r)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-o,2)+Math.pow(m-r,2))+o,_=(Math.pow(s,2)*(l-o)-s*(m-r)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-o,2)+Math.pow(m-r,2))+o,g=(Math.pow(s,2)*(m-r)-s*(l-o)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-o,2)+Math.pow(m-r,2))+r,f=(Math.pow(s,2)*(m-r)+s*(l-o)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-o,2)+Math.pow(m-r,2))+r;return{xt1:new Communicator.Point3(h,p,0),xt2:new Communicator.Point3(c,u,0),xt3:new Communicator.Point3(d,g,0),xt4:new Communicator.Point3(_,f,0)}}findCircleInnerTangents(t,e){let n=t.pos.x,i=t.pos.y,o=e.pos.x,r=e.pos.y,a=t.radius,s=e.radius+1e-6,l=(o*a+n*s)/(a+s),m=(r*a+i*s)/(a+s),h=(Math.pow(a,2)*(l-n)+a*(m-i)*Math.sqrt(Math.pow(l-n,2)+Math.pow(m-i,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(m-i,2))+n,c=(Math.pow(a,2)*(l-n)-a*(m-i)*Math.sqrt(Math.pow(l-n,2)+Math.pow(m-i,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(m-i,2))+n,p=(Math.pow(a,2)*(m-i)-a*(l-n)*Math.sqrt(Math.pow(l-n,2)+Math.pow(m-i,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(m-i,2))+i,u=(Math.pow(a,2)*(m-i)+a*(l-n)*Math.sqrt(Math.pow(l-n,2)+Math.pow(m-i,2)-Math.pow(a,2)))/(Math.pow(l-n,2)+Math.pow(m-i,2))+i,d=(Math.pow(s,2)*(l-o)+s*(m-r)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-o,2)+Math.pow(m-r,2))+o,_=(Math.pow(s,2)*(l-o)-s*(m-r)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-o,2)+Math.pow(m-r,2))+o,g=(Math.pow(s,2)*(m-r)-s*(l-o)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-o,2)+Math.pow(m-r,2))+r,f=(Math.pow(s,2)*(m-r)+s*(l-o)*Math.sqrt(Math.pow(l-o,2)+Math.pow(m-r,2)-Math.pow(s,2)))/(Math.pow(l-o,2)+Math.pow(m-r,2))+r;return{xt1:new Communicator.Point3(h,p,0),xt2:new Communicator.Point3(c,u,0),xt3:new Communicator.Point3(d,g,0),xt4:new Communicator.Point3(_,f,0)}}async initialize(){this.initializeWheels();for(let t=0;t<this._wheels.length;t++){let e,n=t==this._wheels.length-1?0:t+1;this._wheels[t].inner?(e=this.findCircleInnerTangents(this._wheels[t],this._wheels[n]),this._wheels[t].other?(this._wheels[t].exitpos=e.xt2.copy(),this._wheels[n].enterpos=e.xt4.copy()):(this._wheels[t].exitpos=e.xt1.copy(),this._wheels[n].enterpos=e.xt3.copy())):(e=this.findCircleTangents(this._wheels[t],this._wheels[n]),this._wheels[t].other?(this._wheels[t].exitpos=e.xt2.copy(),this._wheels[n].enterpos=e.xt4.copy()):(this._wheels[t].exitpos=e.xt1.copy(),this._wheels[n].enterpos=e.xt3.copy()))}for(let t=0;t<this._wheels.length;t++)this._wheels[t].rotation=this.calculateWheelRotation(t);this.calculateTotalLength();let t=0;this._poslookup=[];for(let e=0;e<1e4;e++){t+=1e-4;let e=new Communicator.Matrix,n=this.computePositionOnBelt(t);e.setTranslationComponent(n.pos.x,n.pos.y,n.pos.z);let i=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(new Communicator.Point3(0,0,1),n.angle,i);let o=Communicator.Matrix.multiply(i,e);this._poslookup.push(o)}let e=this._totalLength/this._segmentnum,n=await this.createMesh(ut.viewer,new Communicator.Point3(e/2-e*this._gap+1e-4,this._thickness,this._width),this._tracks),i=new Communicator.MeshInstanceData(n);this._baseNode&&await ut.viewer.model.deleteNode(this._baseNode),this._baseNode=ut.viewer.model.createNode(ut.viewer.model.getRootNode()),this.adjustnode=ut.viewer.model.createNode(this._baseNode),this._nodeids=[];for(let t=0;t<this._segmentnum;t++)this._nodeids[t]=await ut.viewer.model.createMeshInstance(i,this.adjustnode),t%2?ut.viewer.model.setNodesFaceColor([this._nodeids[t]],this._color1):ut.viewer.model.setNodesFaceColor([this._nodeids[t]],this._color2);ut.viewer.model.setMetallicRoughness([this._baseNode],.2,.6),ut.viewer.model.setNodeMatrix(this.adjustnode,Communicator.Matrix.inverse(this.alignmatrix)),this.move(0)}calculateTotalLength(){this._totalLength=0;for(let t=0;t<this._wheels.length;t++){0==t&&this._wheels.length;let e=t==this._wheels.length-1?0:t+1,n=this._wheels[t];this._totalLength+=this.calculateCircumference(n.radius,n.rotation.steps),this._totalLength+=Communicator.Point3.subtract(n.exitpos,this._wheels[e].enterpos).length()}}computePositionOnBelt(t){let e=this._totalLength*t,i=0,o=0,r=Communicator.Point3.subtract(this._wheels[0].enterpos,this._wheels[this._wheels.length-1].exitpos).normalize();o=n.signedAngle(r,new Communicator.Point3(-1,0,0),new Communicator.Point3(0,0,-1));for(let t=0;t<this._wheels.length;t++){let n=t==this._wheels.length-1?0:t+1,r=this._wheels[t],a=this.calculateCircumference(r.radius,r.rotation.steps),s=Communicator.Point3.subtract(r.exitpos,this._wheels[n].enterpos).length();if(!(i+a<e)){let n=(e-i)/a*r.rotation.steps;return o+=Math.sign(r.rotation.angle)*n,{pos:this.wheelRotation(this._wheels[t],this._wheels[t].enterpos,Math.sign(r.rotation.angle)*n),angle:o}}if(i+=a,o+=Math.sign(r.rotation.angle)*r.rotation.steps,!(i+s<e)){let a=e-i,s=Communicator.Point3.subtract(this._wheels[n].enterpos,r.exitpos).normalize();return{pos:Communicator.Point3.add(this._wheels[t].exitpos,Communicator.Point3.scale(s,a)),angle:o}}i+=s}}calculateWheelRotation(t){let e=0==t?this._wheels.length-1:t-1,i=(this._wheels.length,this._wheels[t]),o=Communicator.Point3.subtract(i.enterpos,i.pos).normalize(),r=Communicator.Point3.subtract(i.exitpos,i.pos).normalize(),a=n.signedAngle(o,r,new Communicator.Point3(0,0,1)),s=Communicator.Point3.subtract(i.enterpos,this._wheels[e].exitpos).length(),l=this.wheelRotation(i,i.enterpos,2*Math.sign(a)),m=Communicator.Point3.subtract(l,this._wheels[e].exitpos).length(),h=Math.abs(a);return m<s&&(h=360-Math.abs(a),a=-a),{steps:h,angle:a}}wheelRotation(t,e,n){let i=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(new Communicator.Point3(0,0,1),n,i);let o=new Communicator.Matrix;o.setTranslationComponent(-t.pos.x,-t.pos.y,0);let r=new Communicator.Matrix;r.setTranslationComponent(t.pos.x,t.pos.y,0);let a=Communicator.Matrix.multiply(o,i);return Communicator.Matrix.multiply(a,r).transform(e)}async move(t){let e=this._totalLength/this._segmentnum;for(let n=0;n<this._segmentnum;n++)this.moveInternal(t+n*e,this._nodeids[n])}async moveInternal(t,e){let n=t%this._totalLength;n<0&&(n=this._totalLength+n);let i=Math.floor(n/this._totalLength*this._poslookup.length);ut.viewer.model.setNodeMatrix(e,this._poslookup[i])}animate(){let t=this;setInterval((function(){t.move(mover),mover+=.2}),10)}calculateCircumference(t,e){return e/360*2*Math.PI*t}calculateCircumferenceAngle(t,e){return e/(2*Math.PI*t)*360}}const r={revolute:0,prismatic:1,fixed:2,prismaticAggregate:3,prismaticTriangle:4,helical:5,mapped:6,pistonController:7,prismaticPlane:8,belt:9,mate:10,revoluteSlide:11,target:12};class a{constructor(t,e){this._hierachy=e,this._id=e._highestId++,this._type=r.revolute,this._mappedType=null,this._children=[],this._parent=t,this._minLimit=void 0,this._maxLimit=void 0,this._nodeid=-1,this._center=new Communicator.Point3(0,0,0),this._axis=new Communicator.Point3(1,0,0),this._currentAngle=0,this._currentPosition=0,this._fixedAxis=null,this._fixedAxisTarget=null,this._referenceNodes=[],this._parentMatrix=new Communicator.Matrix,this._extraComponent1=null,this._extraComponent2=null,this._mappedTargetComponent=null,this._helicalFactor=1,this._reference=!0,this._touched=!1,this._animations=[],this._activeAnimation=!1}initialize(t,e){this._reference=e,this._parent?this._nodeid=ut.viewer.model.createNode(this._parent._nodeid,"component"):this._nodeid=ut.viewer.model.createNode(ut.viewer.model.getRootNode(),"rootComponent"),this._parentMatrix=ut.viewer.model.getNodeNetMatrix(ut.viewer.model.getNodeParent(t[0]));for(let e=0;e<t.length;e++)this._referenceNodes.push({nodeid:t[e],matrix:ut.viewer.model.getNodeNetMatrix(t[e]).copy()})}getId(){return this._id}setType(t){this._type=t}getType(){return this._type}setParent(t){this._parent=t}getParent(){return this._parent}getChildren(){return this._children}getChildByIndex(t){return this._children[t]}setMappedType(t){this._mappedType=t}getMappedType(){return this._mappedType}setNodeId(t){this._nodeid=t}getNodeId(){return this._nodeid}getHierachy(){return this._hierachy}setCenter(t){this._center=t}getCenter(){return this._center}setAxis(t){this._axis=t}getAxis(){return this._axis}getCurrentValue(){return this._type==r.revolute?this._currentAngle:this._type==r.prismatic||this._type==r.helical?this._currentPosition:void 0}getReferenceNodes(){return this._referenceNodes}getParentMatrix(){return this._parentMatrix}getExtraComponent1(){return this._extraComponent1}setExtraComponent1(t){this._extraComponent1=t}getExtraComponent2(){return this._extraComponent2}setExtraComponent2(t){this._extraComponent2=t}setExtraPivot1(t){this._extraPivot1=t}getExtraPivot1(){return this._extraPivot1}setExtraPivot2(t){this._extraPivot2=t}getExtraPivot2(){return this._extraPivot2}setMappedTargetComponent(t){this._mappedTargetComponent=t}getMappedTargetComponent(){return this._mappedTargetComponent}setHelicalFactor(t){this._helicalFactor=t}getHelicalFactor(){return this._helicalFactor}setIsReference(t){this._reference=t}getIsReference(){return this._reference}getAnimations(){return this._animations}getAnimationActive(){return this._activeAnimation}setAnimationActive(t){this._activeAnimation=t}getAnimationByIndex(t){return this._animations[t]}setMinLimit(t){this._minLimit=t}getMinLimit(){return this._minLimit}setMaxLimit(t){this._maxLimit=t}getMaxLimit(){return this._maxLimit}setFixedAxis(t){this._fixedAxis=t}setFixedAxisTarget(t){this._fixedAxisTarget=t}getFixedAxis(){return this._fixedAxis}getBelt(){return this.belt}setPrismaticPlanePlane(t){this._prismaticPlanePlane=t}getPrismaticPlanePlane(){return this._prismaticPlanePlane}setPrismaticPlaneTip(t){this._prismaticPlaneTip=t}getPrismaticPlaneTip(){return this._prismaticPlaneTip}set(t){this._type==r.revolute?this._rotate(t):this._type!=r.prismatic&&this._type!=r.helical||this._translate(t)}toJson(){let t=[];for(let e=0;e<this._children.length;e++)t.push(this._children[e].toJson());let e=[];if(this._type==r.mapped&&this._mappedType==r.belt)for(let t=0;t<this._referenceNodes.length;t++)this._referenceNodes[t].nodeid!=this.belt.getBaseNode()&&e.push({nodeid:this._referenceNodes[t].nodeid,matrix:this._referenceNodes[t].matrix.toJson()});else for(let t=0;t<this._referenceNodes.length;t++)e.push({nodeid:this._referenceNodes[t].nodeid,matrix:this._referenceNodes[t].matrix.toJson()});let n={nodeid:this._nodeid,id:this._id,mappedType:this._mappedType,reference:this._reference,type:this._type,center:this._center.toJson(),axis:this._axis.toJson(),minangle:this._minLimit,maxangle:this._maxLimit,children:t,referenceNodes:e,parentMatrix:this._parentMatrix.toJson()};this._mappedType==r.belt&&(n.parentMatrix=(new Communicator.Matrix).toJson()),this._type==r.prismaticTriangle||this._type==r.prismaticAggregate||this._type==r.mate?(n.extraComponent1=this._extraComponent1._id,n.extraComponent2=this._extraComponent2._id,this._type==r.mate&&(n.extraPivot1=this._extraPivot1.toJson(),n.extraPivot2=this._extraPivot2.toJson())):this._type==r.revoluteSlide?(n.extraComponent1=this._extraComponent1._id,n.extraPivot1=this._extraPivot1.toJson()):this._type==r.pistonController?n.extraComponent1=this._extraComponent1._id:this._type==r.helical?n.helicalFactor=this._helicalFactor:this._type==r.mapped?(n.helicalFactor=this._helicalFactor,n.mappedTargetComponent=this._mappedTargetComponent._id,this._mappedType==r.belt&&(n.belt=this.belt.toJson()),this._mappedType==r.prismaticPlane&&(n._prismaticPlanePlane={d:this._prismaticPlanePlane.d,normal:this._prismaticPlanePlane.normal.toJson()},n._prismaticPlaneTip=this._prismaticPlaneTip.toJson())):this._type==r.revolute&&this._fixedAxis&&(n.fixedAxis=this._fixedAxis.toJson(),n.fixedAxisTarget=this._fixedAxisTarget.toJson()),n.animations=[];for(let t=0;t<this._animations.length;t++)n.animations.push(this._animations[t]);return n}async fromJson(t,e){if(this._minLimit=t.minangle,this._maxLimit=t.maxangle,this._reference=t.reference,this._center=Communicator.Point3.fromJson(t.center),null!=t.id&&(this._id=t.id,this._id>=this._hierachy._highestId&&(this._hierachy._highestId=this._id+1)),null==e){let e=Communicator.Point3.fromJson(t.axis);this._axis=Communicator.Point3.subtract(e,this._center).normalize(),isNaN(this._axis.x)&&(this._axis=new Communicator.Point3(1,0,0))}else this._axis=Communicator.Point3.fromJson(t.axis);this._type=t.type,this._mappedType=t.mappedType,this._parentMatrix=Communicator.Matrix.fromJson(t.parentMatrix),this._hierachy.getComponentHash()[this._id]=this,this._parent?this._nodeid=ut.viewer.model.createNode(this._parent._nodeid,"component"):this._nodeid=ut.viewer.model.createNode(ut.viewer.model.getRootNode(),"rootComponent");for(let e=0;e<t.referenceNodes.length;e++)this._referenceNodes.push({nodeid:t.referenceNodes[e].nodeid,matrix:Communicator.Matrix.fromJson(t.referenceNodes[e].matrix)}),this._hierachy._componentNodeidHash[t.referenceNodes[e].nodeid]=this;if(this._type==r.prismaticTriangle||this._type==r.prismaticAggregate||this._type==r.mate)this._extraComponent1=t.extraComponent1,this._extraComponent2=t.extraComponent2,this._type==r.mate&&(this._extraPivot1=Communicator.Point3.fromJson(t.extraPivot1),this._extraPivot2=Communicator.Point3.fromJson(t.extraPivot2));else if(this._type==r.revoluteSlide)this._extraComponent1=t.extraComponent1,this._extraPivot1=Communicator.Point3.fromJson(t.extraPivot1);else if(this._type==r.pistonController)this._extraComponent1=t.extraComponent1;else if(this._type==r.helical)this._helicalFactor=t.helicalFactor;else if(this._type==r.mapped){if(this._helicalFactor=t.helicalFactor,this._mappedTargetComponent=t.mappedTargetComponent,this._mappedType==r.belt){this.belt=new o,this.belt.fromJson(t.belt,this);for(let t=0;t<this._referenceNodes.length;t++)ut.viewer.model.setNodesVisibility([this._referenceNodes[t].nodeid],!1);await this.belt.initialize(),this._referenceNodes.push({nodeid:this.belt.getBaseNode(),matrix:new Communicator.Matrix})}if(this._mappedType==r.prismaticPlane){let e=Communicator.Point3.fromJson(t._prismaticPlanePlane.normal);this._prismaticPlanePlane=new Communicator.Plane,this._prismaticPlanePlane.d=t._prismaticPlanePlane.d,this._prismaticPlanePlane.normal=e,this._prismaticPlaneTip=Communicator.Point3.fromJson(t._prismaticPlaneTip)}}else if(this._type==r.revolute&&t.fixedAxis){if(null==e){let e=Communicator.Point3.fromJson(t.fixedAxis);this._fixedAxis=Communicator.Point3.subtract(e,this._center).normalize()}else this._fixedAxis=Communicator.Point3.fromJson(t.fixedAxis);this._fixedAxisTarget=Communicator.Point3.fromJson(t.fixedAxisTarget)}for(let n=0;n<t.children.length;n++){let i=new a(this,this._hierachy);i.fromJson(t.children[n],e),this._children.push(i)}if(t.animations)for(let e=0;e<t.animations.length;e++)this._animations.push(t.animations[e])}addAnimation(t){this._animations.push(t)}removeAnimation(t){for(let e=0;e<this._animations.length;e++)if(this._animations[e]==t)return void this._animations.splice(e,1)}removeAnimationRecursive(t){for(let e=0;e<this._children.length;e++)this._children[e].removeAnimationRecursive(t);this.removeAnimation(t)}animToJson(t){for(let e=0;e<this._children.length;e++)this._children[e].animToJson(t);for(let e=0;e<this._animations.length;e++)t[this._animations[e]]=!0}updateReferenceNodes(t){for(let t=0;t<this._referenceNodes.length;t++)delete this._hierachy._componentNodeidHash[this._referenceNodes[t].nodeid];this._referenceNodes=[];for(let e=0;e<t.length;e++)this._referenceNodes.push({nodeid:t[e],matrix:ut.viewer.model.getNodeNetMatrix(t[e]).copy()}),this._hierachy._componentNodeidHash[this._referenceNodes[e].nodeid]=this}removeReferenceNodes(t){for(let e=0;e<this._referenceNodes.length;e++)for(let n=0;n<t.length;n++)if(this._referenceNodes[e].nodeid==t[n]){delete this._hierachy._componentNodeidHash[this._referenceNodes[e].nodeid],this._referenceNodes.splice(e,1),e--;break}}adjustExtraComponentToPistonController(){let t=component._axis,e=Communicator.Plane.createFromPointAndNormal(component._center,t),i=n.closestPointOnPlane(e,component._extraComponent1._center);component._extraComponent1._axis=component._extraComponent1._axis.copy(),component._extraComponent1._center=i}transformPointToComponentSpace(t){let e=this._hierachy.getReferenceNodeNetMatrix(this);return Communicator.Matrix.inverse(e).transform(t)}transformlocalPointToWorldSpace(t){return this._hierachy.getReferenceNodeNetMatrix(this).transform(t)}_rotate(t,e,n){n?(null!=this._minLimit&&this._currentAngle+t<this._minLimit&&(t=this._minLimit-this._currentAngle),null!=this._maxLimit&&this._currentAngle+t>this._maxLimit&&(t=this._maxLimit-this._currentAngle),this._currentAngle+=t):(this._currentAngle=t,null!=this._minLimit&&this._currentAngle<this._minLimit&&(this._currentAngle=this._minLimit,t=this._currentAngle),null!=this._maxLimit&&this._currentAngle>this._maxLimit&&(this._currentAngle=this._maxLimit,t=this._currentAngle));let i=new Communicator.Matrix,o=new Communicator.Matrix,r=this._axis;o=new Communicator.Matrix,o.setTranslationComponent(-this._center.x,-this._center.y,-this._center.z);let a=new Communicator.Matrix;a.setTranslationComponent(this._center.x,this._center.y,this._center.z),Communicator.Util.computeOffaxisRotation(r,t,i);let s=Communicator.Matrix.multiply(o,i),l=Communicator.Matrix.multiply(s,a);if(null!=n){let t=ut.viewer.model.getNodeMatrix(this._nodeid),e=Communicator.Matrix.multiply(t,l);ut.viewer.model.setNodeMatrix(this._nodeid,e)}else ut.viewer.model.setNodeMatrix(this._nodeid,l)}_translate(t){null!=this._minLimit&&t<this._minLimit&&(t=this._minLimit),null!=this._maxLimit&&t>this._maxLimit&&(t=this._maxLimit),this._currentPosition=t,new Communicator.Matrix;let e=new Communicator.Matrix,n=this._axis;e=new Communicator.Matrix,e.setTranslationComponent(-this._center.x,-this._center.y,-this._center.z);let i=new Communicator.Matrix;i.setTranslationComponent(this._center.x,this._center.y,this._center.z);let o=new Communicator.Matrix;o.setTranslationComponent(n.x*t,n.y*t,n.z*t);let r=Communicator.Matrix.multiply(e,o),a=Communicator.Matrix.multiply(r,i);ut.viewer.model.setNodeMatrix(this._nodeid,a)}async calculateMatrixFromHandleMatrix(t){let e;if(this._reference){let n,i=Communicator.Matrix.multiply(t,this._parentMatrix),o=Communicator.Matrix.inverse(this._referenceNodes[0].matrix),r=Communicator.Matrix.multiply(o,i);n=this._parent._parent?this._hierachy.getReferenceNodeNetMatrix(this._parent):new Communicator.Matrix,o=Communicator.Matrix.inverse(n),e=Communicator.Matrix.multiply(r,o)}else{let n=Communicator.Matrix.multiply(t,this._parentMatrix),i=Communicator.Matrix.inverse(this._referenceNodes[0].matrix);e=Communicator.Matrix.multiply(i,n)}if(this._type==r.revolute){let t=ut.viewer.model.getNodeMatrix(this._nodeid),i=this._axis,o=Communicator.Point3.cross(new Communicator.Point3(1,0,0),i);o.length()<1e-5&&(o=Communicator.Point3.cross(new Communicator.Point3(0,1,0),i));let r=Communicator.Point3.add(o,this._center),a=t.transform(component._center),s=t.transform(r),l=(e.transform(this._center),e.transform(r)),m=Communicator.Point3.subtract(s,a).normalize(),h=Communicator.Point3.subtract(l,a).normalize(),c=n.signedAngle(m,h,i);await this._rotate(c,!0,!0)}else{let t=ut.viewer.model.getNodeNetMatrix(this._parent._nodeid);await ut.viewer.model.setNodeMatrix(this._nodeid,e);let n=ut.viewer.model.getNodeNetMatrix(this._nodeid),i=t.transform(this._center),o=n.transform(this._center),r=Communicator.Point3.subtract(o,i).length();await this._translate(r),i=ut.viewer.model.getNodeNetMatrix(this._nodeid).transform(this._center),o=Communicator.Matrix.multiply(t,e).transform(this._center),Communicator.Point3.subtract(o,i).length()>1e-4&&await this._translate(-r)}this._touched=!0}setParametersFromHandle(){let t=ut.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);if(t.getPosition()){let e=t.getPosition(),n=ut.handlePlacementOperator.lastAxis;if(!n)return;let i=this._hierachy.getReferenceNodeNetMatrix(this),o=Communicator.Matrix.inverse(i),r=o.transform(e),a=new Communicator.Point3(e.x+n.x,e.y+n.y,e.z+n.z),s=o.transform(a);this.setCenter(r),this.setAxis(Communicator.Point3.subtract(s,r).normalize())}}setFixedAxisFromMatrix(t){let e=ut.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);if(e.getPosition()){if(!ut.handlePlacementOperator.lastAxis2)return;let n=Communicator.Point3.add(e.getPosition(),ut.handlePlacementOperator.lastAxis2);t.transform(e.getPosition()),n=t.transform(n),this._fixedAxis=Communicator.Point3.subtract(n,this.center).normalize(),this._fixedAxisTarget=new Communicator.Point3(0,-1,0)}}selectReferenceNodes(){ut.viewer.selectionManager.clear();let t=[];for(let e=0;e<this._referenceNodes.length;e++)t.push(Communicator.Selection.SelectionItem.create(this._referenceNodes[e].nodeid));ut.viewer.selectionManager.add(t)}showHandles(t,e,n){let i=ut.handlePlacementOperator,o=this._hierachy.getReferenceNodeNetMatrix(this),a=o.transform(this._center),s=o.transform(Communicator.Point3.add(this._center,this._axis)),l=Communicator.Point3.subtract(s,a);n&&(a=n);let m=[];ut.viewer.selectionManager.clear();let h=[];for(let t=0;t<this._referenceNodes.length;t++)h.push(Communicator.Selection.SelectionItem.create(this._referenceNodes[t].nodeid)),m.push(this._referenceNodes[t].nodeid);if(ut.viewer.selectionManager.add(h),null!=e&&(m=[],m.push(e)),i._addAxisTranslationHandle(a,l,m),i._addAxisTranslationHandle(a,l.copy().scale(-1),m),this._type!=r.prismatic&&this._type!=r.prismaticTriangle&&i._addAxisRotationHandle(a,l,m),t||this._fixedAxis){let t;this._fixedAxis?t=this._fixedAxisTarget.copy():(t=Communicator.Point3.cross(new Communicator.Point3(1,0,0),l),t.length()<1e-5&&(t=Communicator.Point3.cross(new Communicator.Point3(0,1,0),l))),i._addAxisTranslationHandle(a,t,m),ut.handlePlacementOperator.lastAxis2=t.copy()}ut.handlePlacementOperator.lastAxis=l.copy()}async calculateGradient(){let t,e=this._currentAngle,n=this._currentPosition,i=this._hierachy.distanceFromIKTarget();return this._type==r.revolute?(await this._rotate(this._currentAngle+this._hierachy._ikSamplingDistance,!0),t=(this._hierachy.distanceFromIKTarget()-i)/this._hierachy._ikSamplingDistance):(await this._translate(this._currentPosition+this._hierachy._ikSamplingDistanceTranslation),t=(this._hierachy.distanceFromIKTarget()-i)/this._hierachy._ikSamplingDistanceTranslation),this._type==r.revolute?await this._rotate(e):await this._translate(n),this._touched=!0,t}async update(t){this._type==r.revolute?await this._rotate(this._currentAngle-this._hierachy._ikLearningRate*t):await this._translate(this._currentPosition-this._hierachy._ikLearningRate*t)}reset(){this._type==r.revolute?this._rotate(0):this._translate(0)}delete(){if(this._parent){delete this._hierachy.getComponentHash()[this._id];for(let t=0;t<this._children.length;t++)this._children[t]._parent=this._parent,this._parent._children.push(this._children[t]);for(let t=0;t<this._parent._children.length;t++)if(this._parent._children[t]==this){this._parent._children.splice(t,1);break}}}moveup(){if(this._parent){for(let t=0;t<this._parent._children.length;t++)if(this._parent._children[t]==this){this._parent._children.splice(t,1);break}this._parent._parent._children.push(this)}}async _updateComponentsFromReferenceRecursive(t){if(t){if(t._type==r.revoluteSlide){let e=t._extraComponent1.transformlocalPointToWorldSpace(t._extraPivot1),n=t._parent.transformlocalPointToWorldSpace(t._center),i=t._parent.transformlocalPointToWorldSpace(t._extraPivot1),o=Communicator.Point3.subtract(i,n).normalize(),r=Communicator.Point3.subtract(e,n).normalize(),a=Communicator.Util.computeAngleBetweenVector(o,r);await t._rotate(a);let s=t.transformlocalPointToWorldSpace(t._extraPivot1),l=new Communicator.Point3(n.x+1e4*r.x,n.y+1e4*r.y,n.z+1e4*r.z),m=new Communicator.Point3(0,0,0);Communicator.Util.computePointToLineDistance(s,n,l,m)>1e-4&&await t._rotate(-a)}if(t._type==r.mate){let e=Communicator.Point3.subtract(t._extraPivot1,t._extraPivot2).length(),i=t._extraComponent1.transformlocalPointToWorldSpace(t._extraPivot1),o=t._extraComponent2.transformlocalPointToWorldSpace(t._extraPivot2),r=Communicator.Point3.subtract(i,o).length();if(Math.abs(e-r)>.001){let i,o;t._extraComponent2._touched?(i={j:t._extraComponent1,pivot:t._extraPivot1},o={j:t._extraComponent2,pivot:t._extraPivot2}):(o={j:t._extraComponent1,pivot:t._extraPivot1},i={j:t._extraComponent2,pivot:t._extraPivot2}),t._extraComponent1._touched=!1,t._extraComponent2._touched=!1;let r=o.j.transformlocalPointToWorldSpace(o.pivot),a=i.j.transformlocalPointToWorldSpace(i.pivot),s=i.j.transformlocalPointToWorldSpace(i.j._center),l=o.j.transformlocalPointToWorldSpace(t._center),m=o.j.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),h=Communicator.Point3.subtract(m,l).normalize(),c=t._axis,p=n.ComputeVectorToVectorRotationMatrix(h,new Communicator.Point3(0,0,1)),u=Communicator.Matrix.inverse(p),d=p.transform(r),_=e,g=p.transform(s),f=Communicator.Point3.subtract(i.j._center,i.pivot).length(),x=n.circleIntersection(d.x,d.y,_,g.x,g.y,f);x.p1.z=d.z,x.p2.z=d.z;let C=u.transform(x.p1),w=u.transform(x.p2),v=Communicator.Point3.subtract(C,a).length(),y=Communicator.Point3.subtract(w,a).length();v>y&&(C=w);let P=o.j.transformlocalPointToWorldSpace(i.pivot),M=Communicator.Point3.subtract(P,r).normalize(),T=Communicator.Point3.subtract(C,r).normalize(),N=Communicator.Util.computeAngleBetweenVector(M,T),A=n.computeOffaxisRotationMatrix(o.pivot,c,N),b=Communicator.Matrix.inverse(ut.viewer.model.getNodeNetMatrix(ut.viewer.model.getNodeParent(t._nodeid))),I=Communicator.Matrix.multiply(A,ut.viewer.model.getNodeNetMatrix(o.j._nodeid)),k=Communicator.Matrix.multiply(I,b);await ut.viewer.model.setNodeMatrix(t._nodeid,k);let S=t.transformlocalPointToWorldSpace(i.pivot);if(Communicator.Point3.subtract(S,C).length()>1e-4){A=n.computeOffaxisRotationMatrix(o.pivot,c,-N),I=Communicator.Matrix.multiply(A,ut.viewer.model.getNodeNetMatrix(o.j._nodeid));let e=Communicator.Matrix.multiply(I,b);await ut.viewer.model.setNodeMatrix(t._nodeid,e)}P=i.j._parent.transformlocalPointToWorldSpace(i.pivot),M=Communicator.Point3.subtract(P,s).normalize(),T=Communicator.Point3.subtract(C,s).normalize(),N=Communicator.Util.computeAngleBetweenVector(M,T),await i.j._rotate(N);let H=this._hierachy.getReferenceNodeNetMatrix(i.j);S=H.transform(i.pivot),await i.j._rotate(-N),H=this._hierachy.getReferenceNodeNetMatrix(i.j);let z=H.transform(i.pivot);v=Communicator.Point3.subtract(S,C).length(),y=Communicator.Point3.subtract(z,C).length(),v<y&&await i.j._rotate(N),await this.getHierachy().updateComponents()}}else if(t._type==r.pistonController){let e=t._parent.transformlocalPointToWorldSpace(t._center),i=t._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),o=t._extraComponent1._parent.transformlocalPointToWorldSpace(t._extraComponent1._center),r=t._extraComponent1._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(t._extraComponent1._center,t._extraComponent1._axis)),a=Communicator.Point3.subtract(r,o).normalize(),s=n.nearestPointOnLine(o,a,e),l=Communicator.Point3.subtract(s,e).length(),m=Communicator.Point3.subtract(t._extraComponent1._center,t._center).length(),h=Math.sqrt(m*m-l*l),c=Math.asin(h/m)*(180/Math.PI),p=new Communicator.Matrix,u=new Communicator.Matrix,d=Communicator.Point3.subtract(i,e).normalize();u=new Communicator.Matrix,u.setTranslationComponent(-e.x,-e.y,-e.z);let _=new Communicator.Matrix;_.setTranslationComponent(e.x,e.y,e.z),Communicator.Util.computeOffaxisRotation(d,-c,p);let g=Communicator.Matrix.multiply(u,p),f=Communicator.Matrix.multiply(g,_),x=Communicator.Point3.subtract(s,e).normalize();x.scale(h);let C=Communicator.Point3.add(e,x),w=f.transform(C);p=new Communicator.Matrix,Communicator.Util.computeOffaxisRotation(d,c,p),g=Communicator.Matrix.multiply(u,p),f=Communicator.Matrix.multiply(g,_),x=Communicator.Point3.subtract(s,e).normalize(),x.scale(h),C=Communicator.Point3.add(e,x);let v=f.transform(C),y=t._extraComponent1._parent.transformlocalPointToWorldSpace(t._extraComponent1._center),P=Communicator.Point3.subtract(w,y).length();Communicator.Point3.subtract(v,y).length()<P&&(w=v);let M=t._parent.transformlocalPointToWorldSpace(t._extraComponent1._center),T=Communicator.Point3.subtract(M,e).normalize(),N=Communicator.Point3.subtract(w,e).normalize(),A=Communicator.Util.computeAngleBetweenVector(T,N);await t._rotate(-A),M=t.transformlocalPointToWorldSpace(t._extraComponent1._center);let b=Communicator.Point3.subtract(M,w).length();await t._rotate(A),M=t.transformlocalPointToWorldSpace(t._extraComponent1._center),Communicator.Point3.subtract(M,w).length()>b&&await t._rotate(-A);let I=Communicator.Point3.subtract(t._extraComponent1._center,t.transformlocalPointToWorldSpace(t._extraComponent1._center)).length();await t._extraComponent1._translate(-I);let k=Communicator.Point3.subtract(t._extraComponent1.transformlocalPointToWorldSpace(t._extraComponent1._center),t.transformlocalPointToWorldSpace(t._extraComponent1._center)).length();await t._extraComponent1._translate(I),Communicator.Point3.subtract(t._extraComponent1.transformlocalPointToWorldSpace(t._extraComponent1._center),t.transformlocalPointToWorldSpace(t._extraComponent1._center)).length()>k&&await t._extraComponent1._translate(-I)}else if(t._type==r.prismaticAggregate){let e=ut.viewer.model.getNodeMatrix(t._extraComponent1._nodeid),n=ut.viewer.model.getNodeMatrix(t._extraComponent2._nodeid),i=Communicator.Matrix.multiply(e,n);await ut.viewer.model.setNodeMatrix(t._nodeid,i)}else if(t._type==r.prismaticTriangle){let e=t._extraComponent1.transformlocalPointToWorldSpace(t._center),n=t._extraComponent2.transformlocalPointToWorldSpace(t._extraComponent2._center),i=t._extraComponent2._parent.transformlocalPointToWorldSpace(t._center),o=Communicator.Point3.subtract(n,e),r=Communicator.Point3.subtract(n,i),a=o.length(),s=r.length();o.normalize(),r.normalize();let l=Communicator.Util.computeAngleBetweenVector(o,r);await t._extraComponent2._rotate(-l,!0);let m=t._extraComponent2.transformlocalPointToWorldSpace(t._center),h=Communicator.Point3.subtract(m,e).length();await t._extraComponent2._rotate(l,!0),m=t._extraComponent2.transformlocalPointToWorldSpace(t._center),Communicator.Point3.subtract(m,e).length()>h&&await t._extraComponent2._rotate(-l,!0),await this._updateReferenceNodeMatrices(t._extraComponent2),await t._translate(a-s)}else if(t._type==r.helical){let e=t._parent.transformlocalPointToWorldSpace(t._center),n=t.transformlocalPointToWorldSpace(t._center),i=Communicator.Point3.subtract(n,e).length();t._translate(i);let o=t.transformlocalPointToWorldSpace(t._center);t._translate(-i);let r=t.transformlocalPointToWorldSpace(t._center);Communicator.Point3.subtract(o,n).length()<Communicator.Point3.subtract(r,n).length()&&(t._translate(i),i=-i),t._rotate(i*t._helicalFactor,!0,!0)}else if(t._type==r.mapped)if(t._mappedType==r.prismaticPlane){let e=ut.viewer.model.getNodeNetMatrix(t._mappedTargetComponent._nodeid).transform(t._prismaticPlaneTip),n=t._prismaticPlanePlane.distanceToPoint(e);n<0?await t._translate(n*t._helicalFactor):await t._translate(0)}else if(t._mappedTargetComponent._type==r.prismatic||t._mappedTargetComponent._type==r.mapped&&t._mappedTargetComponent._mappedType==r.prismatic){let e=t._mappedTargetComponent._currentPosition,n=ut.viewer.model.getNodeMatrix(t._mappedTargetComponent._nodeid),i=t._mappedTargetComponent._parent.transformlocalPointToWorldSpace(t._mappedTargetComponent._center),o=t._mappedTargetComponent.transformlocalPointToWorldSpace(t._mappedTargetComponent._center),a=Communicator.Point3.subtract(o,i).length();t._mappedTargetComponent._translate(a);let s=t._mappedTargetComponent.transformlocalPointToWorldSpace(t._mappedTargetComponent._center);t._mappedTargetComponent._translate(-a);let l=t._mappedTargetComponent.transformlocalPointToWorldSpace(t._mappedTargetComponent._center);Communicator.Point3.subtract(s,o).length()<Communicator.Point3.subtract(l,o).length()&&(a=-a),ut.viewer.model.setNodeMatrix(t._mappedTargetComponent._nodeid,n),t._mappedType==r.revolute?(await t._rotate(a*t._helicalFactor,!0),t._currentAngle=a*t._helicalFactor):t._mappedType==r.prismatic?await t._translate(a*t._helicalFactor,!0):t._mappedType==r.belt&&await t.belt.move(a*t._helicalFactor),t._mappedTargetComponent._currentPosition=e}else t._mappedTargetComponent._type!=r.revolute&&t._mappedTargetComponent._type!=r.mapped||(t._mappedType==r.revolute?(await t._rotate(t._mappedTargetComponent._currentAngle*t._helicalFactor,!0),t._currentAngle=t._mappedTargetComponent._currentAngle*t._helicalFactor):t._mappedType==r.prismatic?await t._translate(t._mappedTargetComponent._currentAngle*t._helicalFactor,!0):t._mappedType==r.belt&&await t.belt.move(t._mappedTargetComponent._currentAngle*t._helicalFactor));else if(t._type==r.revolute&&t._fixedAxis){let e=t.transformlocalPointToWorldSpace(t._center),i=t.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._fixedAxis)),o=Communicator.Point3.subtract(i,e).normalize(),r=t._fixedAxisTarget,a=t.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),s=Communicator.Point3.subtract(a,e).normalize(),l=Communicator.Plane.createFromPointAndNormal(e,s),m=(l.distanceToPoint(new Communicator.Point3.add(e,r)),n.closestPointOnPlane(l,new Communicator.Point3.add(e,r)));r=new Communicator.Point3.subtract(m,e).normalize();let h=Communicator.Util.computeAngleBetweenVector(o,r);await t._rotate(h,!0,!0),e=t.transformlocalPointToWorldSpace(t._center),i=t.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._fixedAxis));let c=Communicator.Point3.subtract(i,e).normalize();Communicator.Point3.subtract(c,r).length()>.001&&await t._rotate(2*-h,!0,!0)}if(await this._updateReferenceNodeMatrices(t),t._children.length>0)for(let e=0;e<t._children.length;e++)await this._updateComponentsFromReferenceRecursive(t._children[e])}}async _updateReferenceNodeMatrices(t){if(t._reference)if(t._parent&&0==t._parent._reference)for(let e=0;e<t._referenceNodes.length;e++){let n=Communicator.Matrix.multiply(t._referenceNodes[e].matrix,ut.viewer.model.getNodeMatrix(t._nodeid)),i=Communicator.Matrix.multiply(n,ut.viewer.model.getNodeMatrix(t._parent._nodeid)),o=Communicator.Matrix.inverse(t._parent._parentMatrix),r=Communicator.Matrix.multiply(i,o);ut.viewer.model.setNodeMatrix(t._referenceNodes[e].nodeid,r)}else for(let e=0;e<t._referenceNodes.length;e++){let n=Communicator.Matrix.multiply(t._referenceNodes[e].matrix,this._hierachy.getReferenceNodeNetMatrix(t)),i=Communicator.Matrix.inverse(t._parentMatrix),o=Communicator.Matrix.multiply(n,i);ut.viewer.model.setNodeMatrix(t._referenceNodes[e].nodeid,o)}else for(let e=0;e<t._referenceNodes.length;e++){let n=Communicator.Matrix.multiply(t._referenceNodes[e].matrix,ut.viewer.model.getNodeMatrix(t._nodeid)),i=Communicator.Matrix.inverse(t._parentMatrix),o=Communicator.Matrix.multiply(n,i);ut.viewer.model.setNodeMatrix(t._referenceNodes[e].nodeid,o)}}}var s={update:null,begin:null,loopBegin:null,changeBegin:null,change:null,changeComplete:null,loopComplete:null,complete:null,loop:1,direction:"normal",autoplay:!0,timelineOffset:0},l={duration:1e3,delay:0,endDelay:0,easing:"easeOutElastic(1, .5)",round:0},m=["translateX","translateY","translateZ","rotate","rotateX","rotateY","rotateZ","scale","scaleX","scaleY","scaleZ","skew","skewX","skewY","perspective","matrix","matrix3d"],h={CSS:{},springs:{}};function c(t,e,n){return Math.min(Math.max(t,e),n)}function p(t,e){return t.indexOf(e)>-1}function u(t,e){return t.apply(null,e)}var d={arr:function(t){return Array.isArray(t)},obj:function(t){return p(Object.prototype.toString.call(t),"Object")},pth:function(t){return d.obj(t)&&t.hasOwnProperty("totalLength")},svg:function(t){return t instanceof SVGElement},inp:function(t){return t instanceof HTMLInputElement},dom:function(t){return t.nodeType||d.svg(t)},str:function(t){return"string"==typeof t},fnc:function(t){return"function"==typeof t},und:function(t){return void 0===t},nil:function(t){return d.und(t)||null===t},hex:function(t){return/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(t)},rgb:function(t){return/^rgb/.test(t)},hsl:function(t){return/^hsl/.test(t)},col:function(t){return d.hex(t)||d.rgb(t)||d.hsl(t)},key:function(t){return!s.hasOwnProperty(t)&&!l.hasOwnProperty(t)&&"targets"!==t&&"keyframes"!==t}};function _(t){var e=/\(([^)]+)\)/.exec(t);return e?e[1].split(",").map((function(t){return parseFloat(t)})):[]}function g(t,e){var n=_(t),i=c(d.und(n[0])?1:n[0],.1,100),o=c(d.und(n[1])?100:n[1],.1,100),r=c(d.und(n[2])?10:n[2],.1,100),a=c(d.und(n[3])?0:n[3],.1,100),s=Math.sqrt(o/i),l=r/(2*Math.sqrt(o*i)),m=l<1?s*Math.sqrt(1-l*l):0,p=l<1?(l*s-a)/m:-a+s;function u(t){var n=e?e*t/1e3:t;return n=l<1?Math.exp(-n*l*s)*(1*Math.cos(m*n)+p*Math.sin(m*n)):(1+p*n)*Math.exp(-n*s),0===t||1===t?t:1-n}return e?u:function(){var e=h.springs[t];if(e)return e;for(var n=1/6,i=0,o=0;;)if(1===u(i+=n)){if(++o>=16)break}else o=0;var r=i*n*1e3;return h.springs[t]=r,r}}function f(t){return void 0===t&&(t=10),function(e){return Math.ceil(c(e,1e-6,1)*t)*(1/t)}}var x,C,w=function(){var t=.1;function e(t,e){return 1-3*e+3*t}function n(t,e){return 3*e-6*t}function i(t){return 3*t}function o(t,o,r){return((e(o,r)*t+n(o,r))*t+i(o))*t}function r(t,o,r){return 3*e(o,r)*t*t+2*n(o,r)*t+i(o)}return function(e,n,i,a){if(0<=e&&e<=1&&0<=i&&i<=1){var s=new Float32Array(11);if(e!==n||i!==a)for(var l=0;l<11;++l)s[l]=o(l*t,e,i);return function(l){return e===n&&i===a||0===l||1===l?l:o(function(n){for(var a=0,l=1;10!==l&&s[l]<=n;++l)a+=t;--l;var m=a+(n-s[l])/(s[l+1]-s[l])*t,h=r(m,e,i);return h>=.001?function(t,e,n,i){for(var a=0;a<4;++a){var s=r(e,n,i);if(0===s)return e;e-=(o(e,n,i)-t)/s}return e}(n,m,e,i):0===h?m:function(t,e,n,i,r){var a,s,l=0;do{(a=o(s=e+(n-e)/2,i,r)-t)>0?n=s:e=s}while(Math.abs(a)>1e-7&&++l<10);return s}(n,a,a+t,e,i)}(l),n,a)}}}}(),v=(x={linear:function(){return function(t){return t}}},C={Sine:function(){return function(t){return 1-Math.cos(t*Math.PI/2)}},Circ:function(){return function(t){return 1-Math.sqrt(1-t*t)}},Back:function(){return function(t){return t*t*(3*t-2)}},Bounce:function(){return function(t){for(var e,n=4;t<((e=Math.pow(2,--n))-1)/11;);return 1/Math.pow(4,3-n)-7.5625*Math.pow((3*e-2)/22-t,2)}},Elastic:function(t,e){void 0===t&&(t=1),void 0===e&&(e=.5);var n=c(t,1,10),i=c(e,.1,2);return function(t){return 0===t||1===t?t:-n*Math.pow(2,10*(t-1))*Math.sin((t-1-i/(2*Math.PI)*Math.asin(1/n))*(2*Math.PI)/i)}}},["Quad","Cubic","Quart","Quint","Expo"].forEach((function(t,e){C[t]=function(){return function(t){return Math.pow(t,e+2)}}})),Object.keys(C).forEach((function(t){var e=C[t];x["easeIn"+t]=e,x["easeOut"+t]=function(t,n){return function(i){return 1-e(t,n)(1-i)}},x["easeInOut"+t]=function(t,n){return function(i){return i<.5?e(t,n)(2*i)/2:1-e(t,n)(-2*i+2)/2}},x["easeOutIn"+t]=function(t,n){return function(i){return i<.5?(1-e(t,n)(1-2*i))/2:(e(t,n)(2*i-1)+1)/2}}})),x);function y(t,e){if(d.fnc(t))return t;var n=t.split("(")[0],i=v[n],o=_(t);switch(n){case"spring":return g(t,e);case"cubicBezier":return u(w,o);case"steps":return u(f,o);default:return u(i,o)}}function P(t){try{return document.querySelectorAll(t)}catch(t){return}}function M(t,e){for(var n=t.length,i=arguments.length>=2?arguments[1]:void 0,o=[],r=0;r<n;r++)if(r in t){var a=t[r];e.call(i,a,r,t)&&o.push(a)}return o}function T(t){return t.reduce((function(t,e){return t.concat(d.arr(e)?T(e):e)}),[])}function N(t){return d.arr(t)?t:(d.str(t)&&(t=P(t)||t),t instanceof NodeList||t instanceof HTMLCollection?[].slice.call(t):[t])}function A(t,e){return t.some((function(t){return t===e}))}function b(t){var e={};for(var n in t)e[n]=t[n];return e}function I(t,e){var n=b(t);for(var i in t)n[i]=e.hasOwnProperty(i)?e[i]:t[i];return n}function k(t,e){var n=b(t);for(var i in e)n[i]=d.und(t[i])?e[i]:t[i];return n}function S(t){var e=/[+-]?\d*\.?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?(%|px|pt|em|rem|in|cm|mm|ex|ch|pc|vw|vh|vmin|vmax|deg|rad|turn)?$/.exec(t);if(e)return e[1]}function H(t,e){return d.fnc(t)?t(e.target,e.id,e.total):t}function z(t,e){return t.getAttribute(e)}function O(t,e,n){if(A([n,"deg","rad","turn"],S(e)))return e;var i=h.CSS[e+n];if(!d.und(i))return i;var o=document.createElement(t.tagName),r=t.parentNode&&t.parentNode!==document?t.parentNode:document.body;r.appendChild(o),o.style.position="absolute",o.style.width=100+n;var a=100/o.offsetWidth;r.removeChild(o);var s=a*parseFloat(e);return h.CSS[e+n]=s,s}function R(t,e,n){if(e in t.style){var i=e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),o=t.style[e]||getComputedStyle(t).getPropertyValue(i)||"0";return n?O(t,o,n):o}}function L(t,e){return d.dom(t)&&!d.inp(t)&&(!d.nil(z(t,e))||d.svg(t)&&t[e])?"attribute":d.dom(t)&&A(m,e)?"transform":d.dom(t)&&"transform"!==e&&R(t,e)?"css":null!=t[e]?"object":void 0}function F(t){if(d.dom(t)){for(var e,n=t.style.transform||"",i=/(\w+)\(([^)]*)\)/g,o=new Map;e=i.exec(n);)o.set(e[1],e[2]);return o}}function D(t,e,n,i){switch(L(t,e)){case"transform":return function(t,e,n,i){var o=p(e,"scale")?1:0+function(t){return p(t,"translate")||"perspective"===t?"px":p(t,"rotate")||p(t,"skew")?"deg":void 0}(e),r=F(t).get(e)||o;return n&&(n.transforms.list.set(e,r),n.transforms.last=e),i?O(t,r,i):r}(t,e,i,n);case"css":return R(t,e,n);case"attribute":return z(t,e);default:return t[e]||0}}function J(t,e){var n=/^(\*=|\+=|-=)/.exec(t);if(!n)return t;var i=S(t)||0,o=parseFloat(e),r=parseFloat(t.replace(n[0],""));switch(n[0][0]){case"+":return o+r+i;case"-":return o-r+i;case"*":return o*r+i}}function W(t,e){if(d.col(t))return function(t){return d.rgb(t)?(n=/rgb\((\d+,\s*[\d]+,\s*[\d]+)\)/g.exec(e=t))?"rgba("+n[1]+",1)":e:d.hex(t)?function(t){var e=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(t,e,n,i){return e+e+n+n+i+i})),n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return"rgba("+parseInt(n[1],16)+","+parseInt(n[2],16)+","+parseInt(n[3],16)+",1)"}(t):d.hsl(t)?function(t){var e,n,i,o=/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.exec(t)||/hsla\((\d+),\s*([\d.]+)%,\s*([\d.]+)%,\s*([\d.]+)\)/g.exec(t),r=parseInt(o[1],10)/360,a=parseInt(o[2],10)/100,s=parseInt(o[3],10)/100,l=o[4]||1;function m(t,e,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+6*(e-t)*n:n<.5?e:n<2/3?t+(e-t)*(2/3-n)*6:t}if(0==a)e=n=i=s;else{var h=s<.5?s*(1+a):s+a-s*a,c=2*s-h;e=m(c,h,r+1/3),n=m(c,h,r),i=m(c,h,r-1/3)}return"rgba("+255*e+","+255*n+","+255*i+","+l+")"}(t):void 0;var e,n}(t);if(/\s/g.test(t))return t;var n=S(t),i=n?t.substr(0,t.length-n.length):t;return e?i+e:i}function B(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function E(t){for(var e,n=t.points,i=0,o=0;o<n.numberOfItems;o++){var r=n.getItem(o);o>0&&(i+=B(e,r)),e=r}return i}function j(t){if(t.getTotalLength)return t.getTotalLength();switch(t.tagName.toLowerCase()){case"circle":return function(t){return 2*Math.PI*z(t,"r")}(t);case"rect":return function(t){return 2*z(t,"width")+2*z(t,"height")}(t);case"line":return function(t){return B({x:z(t,"x1"),y:z(t,"y1")},{x:z(t,"x2"),y:z(t,"y2")})}(t);case"polyline":return E(t);case"polygon":return function(t){var e=t.points;return E(t)+B(e.getItem(e.numberOfItems-1),e.getItem(0))}(t)}}function q(t,e){var n=e||{},i=n.el||function(t){for(var e=t.parentNode;d.svg(e)&&d.svg(e.parentNode);)e=e.parentNode;return e}(t),o=i.getBoundingClientRect(),r=z(i,"viewBox"),a=o.width,s=o.height,l=n.viewBox||(r?r.split(" "):[0,0,a,s]);return{el:i,viewBox:l,x:l[0]/1,y:l[1]/1,w:a,h:s,vW:l[2],vH:l[3]}}function V(t,e,n){function i(n){void 0===n&&(n=0);var i=e+n>=1?e+n:0;return t.el.getPointAtLength(i)}var o=q(t.el,t.svg),r=i(),a=i(-1),s=i(1),l=n?1:o.w/o.vW,m=n?1:o.h/o.vH;switch(t.property){case"x":return(r.x-o.x)*l;case"y":return(r.y-o.y)*m;case"angle":return 180*Math.atan2(s.y-a.y,s.x-a.x)/Math.PI}}function G(t,e){var n=/[+-]?\d*\.?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?/g,i=W(d.pth(t)?t.totalLength:t,e)+"";return{original:i,numbers:i.match(n)?i.match(n).map(Number):[0],strings:d.str(t)||e?i.split(n):[]}}function K(t){return M(t?T(d.arr(t)?t.map(N):N(t)):[],(function(t,e,n){return n.indexOf(t)===e}))}function U(t){var e=K(t);return e.map((function(t,n){return{target:t,id:n,total:e.length,transforms:{list:F(t)}}}))}function $(t,e){var n=b(e);if(/^spring/.test(n.easing)&&(n.duration=g(n.easing)),d.arr(t)){var i=t.length;2!==i||d.obj(t[0])?d.fnc(e.duration)||(n.duration=e.duration/i):t={value:t}}var o=d.arr(t)?t:[t];return o.map((function(t,n){var i=d.obj(t)&&!d.pth(t)?t:{value:t};return d.und(i.delay)&&(i.delay=n?0:e.delay),d.und(i.endDelay)&&(i.endDelay=n===o.length-1?e.endDelay:0),i})).map((function(t){return k(t,n)}))}var Q={css:function(t,e,n){return t.style[e]=n},attribute:function(t,e,n){return t.setAttribute(e,n)},object:function(t,e,n){return t[e]=n},transform:function(t,e,n,i,o){if(i.list.set(e,n),e===i.last||o){var r="";i.list.forEach((function(t,e){r+=e+"("+t+") "})),t.style.transform=r}}};function X(t,e){U(t).forEach((function(t){for(var n in e){var i=H(e[n],t),o=t.target,r=S(i),a=D(o,n,r,t),s=J(W(i,r||S(a)),a),l=L(o,n);Q[l](o,n,s,t.transforms,!0)}}))}function Y(t,e){return M(T(t.map((function(t){return e.map((function(e){return function(t,e){var n=L(t.target,e.name);if(n){var i=function(t,e){var n;return t.tweens.map((function(i){var o=function(t,e){var n={};for(var i in t){var o=H(t[i],e);d.arr(o)&&1===(o=o.map((function(t){return H(t,e)}))).length&&(o=o[0]),n[i]=o}return n.duration=parseFloat(n.duration),n.delay=parseFloat(n.delay),n}(i,e),r=o.value,a=d.arr(r)?r[1]:r,s=S(a),l=D(e.target,t.name,s,e),m=n?n.to.original:l,h=d.arr(r)?r[0]:m,c=S(h)||S(l),p=s||c;return d.und(a)&&(a=m),o.from=G(h,p),o.to=G(J(a,h),p),o.start=n?n.end:0,o.end=o.start+o.delay+o.duration+o.endDelay,o.easing=y(o.easing,o.duration),o.isPath=d.pth(r),o.isPathTargetInsideSVG=o.isPath&&d.svg(e.target),o.isColor=d.col(o.from.original),o.isColor&&(o.round=1),n=o,o}))}(e,t),o=i[i.length-1];return{type:n,property:e.name,animatable:t,tweens:i,duration:o.end,delay:i[0].delay,endDelay:o.endDelay}}}(t,e)}))}))),(function(t){return!d.und(t)}))}function Z(t,e){var n=t.length,i=function(t){return t.timelineOffset?t.timelineOffset:0},o={};return o.duration=n?Math.max.apply(Math,t.map((function(t){return i(t)+t.duration}))):e.duration,o.delay=n?Math.min.apply(Math,t.map((function(t){return i(t)+t.delay}))):e.delay,o.endDelay=n?o.duration-Math.max.apply(Math,t.map((function(t){return i(t)+t.duration-t.endDelay}))):e.endDelay,o}var tt=0,et=[],nt=function(){var t;function e(n){for(var i=et.length,o=0;o<i;){var r=et[o];r.paused?(et.splice(o,1),i--):(r.tick(n),o++)}t=o>0?requestAnimationFrame(e):void 0}return"undefined"!=typeof document&&document.addEventListener("visibilitychange",(function(){ot.suspendWhenDocumentHidden&&(it()?t=cancelAnimationFrame(t):(et.forEach((function(t){return t._onDocumentVisibility()})),nt()))})),function(){t||it()&&ot.suspendWhenDocumentHidden||!(et.length>0)||(t=requestAnimationFrame(e))}}();function it(){return!!document&&document.hidden}function ot(t){void 0===t&&(t={});var e,n=0,i=0,o=0,r=0,a=null;function m(t){var e=window.Promise&&new Promise((function(t){return a=t}));return t.finished=e,e}var h=function(t){var e=I(s,t),n=I(l,t),i=function(t,e){var n=[],i=e.keyframes;for(var o in i&&(e=k(function(t){for(var e=M(T(t.map((function(t){return Object.keys(t)}))),(function(t){return d.key(t)})).reduce((function(t,e){return t.indexOf(e)<0&&t.push(e),t}),[]),n={},i=function(i){var o=e[i];n[o]=t.map((function(t){var e={};for(var n in t)d.key(n)?n==o&&(e.value=t[n]):e[n]=t[n];return e}))},o=0;o<e.length;o++)i(o);return n}(i),e)),e)d.key(o)&&n.push({name:o,tweens:$(e[o],t)});return n}(n,t),o=U(t.targets),r=Y(o,i),a=Z(r,n),m=tt;return tt++,k(e,{id:m,children:[],animatables:o,animations:r,duration:a.duration,delay:a.delay,endDelay:a.endDelay})}(t);function p(){var t=h.direction;"alternate"!==t&&(h.direction="normal"!==t?"normal":"reverse"),h.reversed=!h.reversed,e.forEach((function(t){return t.reversed=h.reversed}))}function u(t){return h.reversed?h.duration-t:t}function _(){n=0,i=u(h.currentTime)*(1/ot.speed)}function g(t,e){e&&e.seek(t-e.timelineOffset)}function f(t){for(var e=0,n=h.animations,i=n.length;e<i;){var o=n[e],r=o.animatable,a=o.tweens,s=a.length-1,l=a[s];s&&(l=M(a,(function(e){return t<e.end}))[0]||l);for(var m=c(t-l.start-l.delay,0,l.duration)/l.duration,p=isNaN(m)?1:l.easing(m),u=l.to.strings,d=l.round,_=[],g=l.to.numbers.length,f=void 0,x=0;x<g;x++){var C=void 0,w=l.to.numbers[x],v=l.from.numbers[x]||0;C=l.isPath?V(l.value,p*w,l.isPathTargetInsideSVG):v+p*(w-v),d&&(l.isColor&&x>2||(C=Math.round(C*d)/d)),_.push(C)}var y=u.length;if(y){f=u[0];for(var P=0;P<y;P++){u[P];var T=u[P+1],N=_[P];isNaN(N)||(f+=T?N+T:N+" ")}}else f=_[0];Q[o.type](r.target,o.property,f,r.transforms),o.currentValue=f,e++}}function x(t){h[t]&&!h.passThrough&&h[t](h)}function C(t){var s=h.duration,l=h.delay,d=s-h.endDelay,_=u(t);h.progress=c(_/s*100,0,100),h.reversePlayback=_<h.currentTime,e&&function(t){if(h.reversePlayback)for(var n=r;n--;)g(t,e[n]);else for(var i=0;i<r;i++)g(t,e[i])}(_),!h.began&&h.currentTime>0&&(h.began=!0,x("begin")),!h.loopBegan&&h.currentTime>0&&(h.loopBegan=!0,x("loopBegin")),_<=l&&0!==h.currentTime&&f(0),(_>=d&&h.currentTime!==s||!s)&&f(s),_>l&&_<d?(h.changeBegan||(h.changeBegan=!0,h.changeCompleted=!1,x("changeBegin")),x("change"),f(_)):h.changeBegan&&(h.changeCompleted=!0,h.changeBegan=!1,x("changeComplete")),h.currentTime=c(_,0,s),h.began&&x("update"),t>=s&&(i=0,h.remaining&&!0!==h.remaining&&h.remaining--,h.remaining?(n=o,x("loopComplete"),h.loopBegan=!1,"alternate"===h.direction&&p()):(h.paused=!0,h.completed||(h.completed=!0,x("loopComplete"),x("complete"),!h.passThrough&&"Promise"in window&&(a(),m(h)))))}return m(h),h.reset=function(){var t=h.direction;h.passThrough=!1,h.currentTime=0,h.progress=0,h.paused=!0,h.began=!1,h.loopBegan=!1,h.changeBegan=!1,h.completed=!1,h.changeCompleted=!1,h.reversePlayback=!1,h.reversed="reverse"===t,h.remaining=h.loop,e=h.children;for(var n=r=e.length;n--;)h.children[n].reset();(h.reversed&&!0!==h.loop||"alternate"===t&&1===h.loop)&&h.remaining++,f(h.reversed?h.duration:0)},h._onDocumentVisibility=_,h.set=function(t,e){return X(t,e),h},h.tick=function(t){o=t,n||(n=o),C((o+(i-n))*ot.speed)},h.seek=function(t){C(u(t))},h.pause=function(){h.paused=!0,_()},h.play=function(){h.paused&&(h.completed&&h.reset(),h.paused=!1,et.push(h),_(),nt())},h.reverse=function(){p(),h.completed=!h.reversed,_()},h.restart=function(){h.reset(),h.play()},h.remove=function(t){at(K(t),h)},h.reset(),h.autoplay&&h.play(),h}function rt(t,e){for(var n=e.length;n--;)A(t,e[n].animatable.target)&&e.splice(n,1)}function at(t,e){var n=e.animations,i=e.children;rt(t,n);for(var o=i.length;o--;){var r=i[o],a=r.animations;rt(t,a),a.length||r.children.length||i.splice(o,1)}n.length||i.length||e.pause()}ot.version="3.2.1",ot.speed=1,ot.suspendWhenDocumentHidden=!0,ot.running=et,ot.remove=function(t){for(var e=K(t),n=et.length;n--;)at(e,et[n])},ot.get=D,ot.set=X,ot.convertPx=O,ot.path=function(t,e){var n=d.str(t)?P(t)[0]:t,i=e||100;return function(t){return{property:t,el:n,svg:q(n),totalLength:j(n)*(i/100)}}},ot.setDashoffset=function(t){var e=j(t);return t.setAttribute("stroke-dasharray",e),e},ot.stagger=function(t,e){void 0===e&&(e={});var n=e.direction||"normal",i=e.easing?y(e.easing):null,o=e.grid,r=e.axis,a=e.from||0,s="first"===a,l="center"===a,m="last"===a,h=d.arr(t),c=h?parseFloat(t[0]):parseFloat(t),p=h?parseFloat(t[1]):0,u=S(h?t[1]:t)||0,_=e.start||0+(h?c:0),g=[],f=0;return function(t,e,d){if(s&&(a=0),l&&(a=(d-1)/2),m&&(a=d-1),!g.length){for(var x=0;x<d;x++){if(o){var C=l?(o[0]-1)/2:a%o[0],w=l?(o[1]-1)/2:Math.floor(a/o[0]),v=C-x%o[0],y=w-Math.floor(x/o[0]),P=Math.sqrt(v*v+y*y);"x"===r&&(P=-v),"y"===r&&(P=-y),g.push(P)}else g.push(Math.abs(a-x));f=Math.max.apply(Math,g)}i&&(g=g.map((function(t){return i(t/f)*f}))),"reverse"===n&&(g=g.map((function(t){return r?t<0?-1*t:-t:Math.abs(f-t)})))}return _+(h?(p-c)/f:c)*(Math.round(100*g[e])/100)+u}},ot.timeline=function(t){void 0===t&&(t={});var e=ot(t);return e.duration=0,e.add=function(n,i){var o=et.indexOf(e),r=e.children;function a(t){t.passThrough=!0}o>-1&&et.splice(o,1);for(var s=0;s<r.length;s++)a(r[s]);var m=k(n,I(l,t));m.targets=m.targets||t.targets;var h=e.duration;m.autoplay=!1,m.direction=e.direction,m.timelineOffset=d.und(i)?h:J(i,h),a(e),e.seek(m.timelineOffset);var c=ot(m);a(c),r.push(c);var p=Z(r,t);return e.delay=p.delay,e.endDelay=p.endDelay,e.duration=p.duration,e.seek(0),e.reset(),e.autoplay&&e.play(),e},e},ot.easing=y,ot.penner=v,ot.random=function(t,e){return Math.floor(Math.random()*(e-t+1))+t};const st=ot;class lt{constructor(t){this._hierachy=t,this._animations=[],this.name=""}getAnimations(){return this._animations}getAnimationByIndex(t){return this._animations[t]}addAnimation(t,e){this._animations.push({animation:t,component:e})}setName(t){this.name=t}getName(){return this.name}toJson(){return{animations:this._animations,name:this.name}}fromJson(t){this._animations=t.animations,this.name=t.name}play(){for(let t=0;t<this._animations.length;t++){let e=this._animations[t],n=ut.getAnimationTemplate(e.animation),i=this._hierachy.getComponentHash()[e.component];ut.startAnimation(i,n)}}}class mt{static fromJson(t,e){return new mt(t.name,e,t.animedef)}constructor(t,e,n){this.name=t,this._component=e,this._done=!1;let i=this;this.value=this._component.getCurrentValue(),null!=n.infinite&&n.infinite?(this.type=1,this.startTime=Date.now(),this.lasttime=this.startTime,this.easeInTime=parseInt(n.easeintime)/1e3,this.target=parseInt(n.value),this.previoustarget=0):(this.type=0,null!=n.startcolor&&(this.color=n.startcolor,n.startcolor=void 0,n.color=n.endcolor,n.endcolor=void 0),n.targets=this,n.autoplay=!1,n.complete=function(){i.anime.remove(),i._done=!0},this.anime=st(n))}getName(){return this.name}getComponent(){return this._component}getDone(){return this._done}setDone(t){this._done=t}update(t){if(null!=this.color){this.anime.tick(t);let e=this._component.getReferenceNodes();for(let t=0;t<e.length;t++){let n=this.color.substring(5,this.color.length-1).split(",");ut.viewer.model.setNodesFaceColor([e[t].nodeid],new Communicator.Color(parseInt(n[0]),parseInt(n[1]),parseInt(n[2])))}}else{if(1==this.type){let t=Date.now(),e=(t-this.lasttime)/1e3,n=(t-this.startTime)/1e3,i=this.target;n<this.easeInTime&&(i=this.easeInQuad(n,this.previoustarget,this.target-this.previoustarget,this.easeInTime));let o=this.value+e*i;this._component.set(o),this.lasttime=t,this.value=o}else this.anime.tick(t),this._component.set(parseFloat(this.value));this._component._touched=!0}}changeAnimationSpeed(t){this.previoustarget=this.target,this.target=t,this.startTime=Date.now(),this.lasttime=Date.now()}easeInQuad(t,e,n,i){return n*(t/=i)*t+e}}class ht{constructor(){this._templateId=null,this._highestId=0,this._nodeid=void 0,this._componentNodeidHash=[],this._componentHash=[],this._ikTip=new Communicator.Point3(0,0,0),this._ikThreshold=1,this._ikSpeed=100,this._ikSamplingDistance=.1,this._ikSamplingDistanceTranslation=1,this._ikLearningRate=.1,this._interval=null,this._targetPoint=new Communicator.Point3(0,0,0),this._rootComponent=this.createComponent(null,[],!0),this._rootComponent.setType(r.fixed),this._tipComponent=null,this._targetAnchorPosition=null,this._targetAnchorNode=null,this._dirty=!1}getComponentHash(){return this._componentHash}getRootComponent(){return this._rootComponent}getComponentById(t){let e=this._componentHash[t];return null!=e?e:null}getTemplateId(){return this._templateId}generateTemplate(){if(this._templateId){let t=this.toJson(this);ut.updateTemplate(t)}else{this._templateId=n.generateGUID();let t=this.toJson();ut.addTemplate(t)}}async updateComponents(){await this._rootComponent._updateComponentsFromReferenceRecursive(this._rootComponent)}setIkTip(t){this._ikTip=t}getIkTip(){return this._ikTip}setIkThreshold(t){this._ikThreshold=t}getIkThreshold(){return this._ikThreshold}setIkSpeed(t){this._ikSpeed=t}getIkSpeed(){return this._ikSpeed}setIkSamplingDistance(t){this._ikSamplingDistance=t}getIkSamplingDistance(){return this._ikSamplingDistance}setIkSamplingDistanceTranslation(t){this._ikSamplingDistanceTranslation=t}getIkSamplingDistanceTranslation(){return this._ikSamplingDistanceTranslation}setIkLearningRate(t){this._ikLearningRate=t}getIkLearningRate(){return this._ikLearningRate}isIKActive(){return!!this._interval}stopIK(){this._interval&&(clear_interval(this._interval),this._interval=null)}startIKFromHandle(){if(!this._interval){let t=this,e=ut.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);this._interval=set_interval((async function(){if(e.getPosition()||t._targetAnchorPosition){if(t._targetAnchorPosition){let e=ut.viewer.model.getNodeNetMatrix(t._targetAnchorNode);t._targetPoint=e.transform(t._targetAnchorPosition)}else{let e=ut.viewer.model.getNodeMatrix(ut.handleNode);t._targetPoint=e.transform(new Communicator.Point3(0,0,0))}for(let e=0;e<t._ikSpeed;e++)t.distanceFromIKTarget()>t._ikThreshold&&await t._inverseKinematics()}}),1)}}insertIKHandle(){let t=ut.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);t.removeHandles(),t.addHandles([ut.handleNode],this._targetPoint),ut.viewer.model.setNodesVisibility([ut.handleNode],!0),t.showHandles()}setIKHandleToTip(t){let e=this.getReferenceNodeNetMatrix(this._tipComponent),n=e.transform(this._ikTip);e=new Communicator.Matrix,e.setTranslationComponent(n.x,n.y,n.z),this._targetPoint=n.copy(),ut.viewer.model.setNodeMatrix(ut.handleNode,e),t&&this.insertIKHandle()}setTipToHandlePosition(){let t=ut.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).getPosition();this._ikTip=this._tipComponent.transformPointToComponentSpace(t)}setTargetAnchorToHandlePosition(){let t=ut.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).getPosition(),e=ut.viewer.selectionManager.getResults()[0].getNodeId(),n=Communicator.Matrix.inverse(ut.viewer.model.getNodeNetMatrix(e));this._targetAnchorPosition=n.transform(t),this._targetAnchorNode=e}distanceFromIKTarget(){let t=this.getReferenceNodeNetMatrix(this._tipComponent).transform(this._ikTip);return Communicator.Point3.subtract(this._targetPoint,t).length()}removeAnimationFromComponents(t){this._rootComponent.removeAnimationRecursive(t)}toJson(){let t={version:1,_ikTip:this._ikTip.toJson(),_templateId:this._templateId,_ikSamplingDistance:this._ikSamplingDistance,_ikSamplingDistanceTranslation:this._ikSamplingDistanceTranslation,_ikLearningRate:this._ikLearningRate,_ikThreshold:this._ikThreshold,_ikSpeed:this._ikSpeed,_targetAnchorNode:this._targetAnchorNode};this._targetAnchorPosition&&(t._targetAnchorPosition=this._targetAnchorPosition.toJson()),t.components=this._rootComponent.toJson();let e=[],n=[];this._rootComponent.animToJson(e);for(let t in e){let e=ut.getAnimationTemplate(t);null!=e&&(e._templateId=t,n.push(e))}t.animations=n,t.animationGroups=[];for(let e=0;e<ut._animationGroups.length;e++){let n=ut._animationGroups[e];n.hierachy==this&&t.animationGroups.push(n.toJson())}return t}fromJson(t){this._highestId=0,this._ikTip=Communicator.Point3.fromJson(t._ikTip),this._ikThreshold=t._ikThreshold,this._ikSpeed=t._ikSpeed,this._ikSamplingDistance=t._ikSamplingDistance,this._ikSamplingDistanceTranslation=t._ikSamplingDistanceTranslation,this._ikLearningRate=t._ikLearningRate,this._targetAnchorNode=t._targetAnchorNode,this._templateId=t._templateId,t._targetAnchorPosition&&(this._targetAnchorPosition=Communicator.Point3.fromJson(t._targetAnchorPosition));let e=new a(null,this);for(e.fromJson(t.components,t.version),this._rootComponent=e;;){if(0==e.getChildren().length){this._tipComponent=e;break}e=e.getChildren()[0]}for(let t in this._componentHash){let e=this._componentHash[t];e.getType()!=r.prismaticTriangle&&e.getType()!=r.prismaticAggregate&&e.getType()!=r.mate||(e.setExtraComponent1(this._componentHash[e.getExtraComponent1()]),e.setExtraComponent2(this._componentHash[e.getExtraComponent2()])),e.getType()==r.revoluteSlide||e.getType()==r.pistonController?e.setExtraComponent1(this._componentHash[e.getExtraComponent1()]):e.getType()==r.mapped&&(e._mappedTargetComponent=this._componentHash[e.getMappedTargetComponent()])}if(null!=t.animations)for(let e=0;e<t.animations.length;e++)ut.addAnimationTemplateFromJson(t.animations[e]._templateId,t.animations[e]);if(null!=t.animationGroups)for(let e=0;e<t.animationGroups.length;e++){let n=new lt(this);n.fromJson(t.animationGroups[e]),ut.addAnimationGroup(n)}return t}resetComponents(){let t=this._rootComponent;for(;t.reset(),0!=t.getChildren().length;)t=t.getChildren()[0];this._interval&&(clear_interval(this._interval),this._interval=null)}createComponent(t,e,n,i){let o=!0;null!=n&&0==n&&(o=!1);let r=new a(t,this);this._componentHash[r.getId()]=r,r.initialize(e,o),null==t?this._rootComponent=r:i?t.getChildren().unshift(r):t.getChildren().push(r),this._tipComponent=this._findTipComponent();for(let t=0;t<e.length;t++)this._componentNodeidHash[e[t]]=r;return r}createComponentFromSelection(t,e,n){let i=[],o=ut.viewer.selectionManager.getResults();for(let t=0;t<o.length;t++)i.push(o[t].getNodeId());let r=this.createComponent(t,i,e,n);return r.setParametersFromHandle(),r}async rebuildComponentTree(){ut.viewer.model.deleteNode(this._rootComponent.getNodeId()),this._rebuildComponentTreeRecursive(this._rootComponent)}applyToModel(t){this._componentNodeidHash=[];let e,n=ut.viewer.model.getNodeChildren(t)[0];e=t==ut.viewer.model.getRootNode()||null==t?new Communicator.Matrix:ut.viewer.model.getNodeMatrix(t),this._applyToModelRecursive(this._rootComponent,ut.viewer.model.getNodeIdOffset(n),e)}getReferenceNodeNetMatrix(t){return ut.viewer.model.getNodeNetMatrix(t.getNodeId())}_applyToModelRecursive(t,e,n){this._componentNodeidHash[t.getNodeId()]=t;let i=n.transform(Communicator.Point3.add(t.getCenter(),t.getAxis()));t.setCenter(n.transform(t.getCenter())),t.setAxis(Communicator.Point3.subtract(i,t.getCenter()).normalize()),t._parentMatrix=Communicator.Matrix.multiply(t.getParentMatrix(),n),t.fixedAxis&&(t.fixedAxis=n.transform(t.fixedAxis));let o=t.getReferenceNodes();for(let i=0;i<o.length;i++)o[i].nodeid=e+o[i].nodeid,o[i].matrix=Communicator.Matrix.multiply(o[i].matrix,n),this._componentNodeidHash[o[i].nodeid]=t;if(t.getChildren().length>0)for(let i=0;i<t.getChildren().length;i++)this._applyToModelRecursive(t.getChildren()[i],e,n)}setDirty(t){this._dirty=!0}getDirty(){return this._dirty}setNodeId(t){this._nodeid=t}_findTipComponent(){let t=this._rootComponent;for(;0!=t.getChildren().length;)t=t.getChildren()[0];return t}_rebuildComponentTreeRecursive(t){if(t.getParent()?t.setNodeId(ut.viewer.model.createNode(t.getParent().getNodeId(),"component")):t.setNodeId(ut.viewer.model.createNode(ut.viewer.model.getRootNode(),"_rootComponent")),t.getChildren().length>0)for(let e=0;e<t.getChildren().length;e++)this._rebuildComponentTreeRecursive(t.getChildren()[e])}async _inverseKinematics(){let t=this._rootComponent;for(;;){if(t.getType()!=r.fixed&&null==t.fixedAxis&&t.getType()!=r.pistonController&&t.getType()!=r.prismaticAggregate){let e=await t.calculateGradient();await t.update(e)}if(t.getType()==r.prismaticAggregate){let e=await t.getExtraComponent1().calculateGradient();await t.getExtraComponent1().update(e),e=await t.getExtraComponent2().calculateGradient(),await t.getExtraComponent2().update(e)}if(0==t.getChildren().length||t.getType()==r.fixed&&t!=this._rootComponent)break;t=t.getChildren()[0]}await this._rootComponent.updateComponentsFromReference()}}class ct{constructor(t){this._viewer=t,this._activeHighlight=null,this._currentSelItem=null,this.lastAxis=null,this.lastAxis2=null}insertHandles(t){let e=this._currentSelItem,n=e.getNodeId(),i=e.getFaceEntity(),o=e.getLineEntity();if(null!==o||null!=i){let r,a=this._viewer.selectionManager.getResults();if(a.length>0){r=[];for(let t=0;t<a.length;t++)r.push(a[t].getNodeId())}else r=[n];if(null!=o){let t=o.getPoints();if(2===t.length){let e=Communicator.Point3.subtract(t[1],t[0]);this.lastAxis=e.copy();let n=e.length(),i=t[0].copy().add(e.normalize().scale(n/2));this._addAxisTranslationHandle(i,e,r),this._addAxisTranslationHandle(i,e.copy().scale(-1),r),this._addAxisRotationHandle(i,e,r)}else this._getArcCenter(e).then((t=>{let e=this._viewer.model.getNodeNetMatrix(this._viewer.model.getNodeParent(n)),i=e.transform(new Communicator.Point3(0,0,0)),o=e.transform(t.normal),a=Communicator.Point3.cross(new Communicator.Point3(1,0,0),t.normal);a.length()<1e-5&&(a=Communicator.Point3.cross(new Communicator.Point3(0,1,0),t.normal));let s=e.transform(a),l=Communicator.Point3.subtract(o,i),m=Communicator.Point3.subtract(s,i);this.lastAxis=l.copy(),this.lastAxis2=m.copy();let h=t.center;this._addAxisTranslationHandle(h,l,r),this._addAxisTranslationHandle(h,l.copy().scale(-1),r),this._addAxisRotationHandle(h,l,r),this._addAxisTranslationHandle(h,m,r)}))}else{let e=i.getNormal(),n=(e.length(),i.getPosition().copy());if(n=i.getBounding().center().copy(),t)this._addMainHandle(r,n);else{let t=Communicator.Point3.cross(new Communicator.Point3(1,0,0),e);t.length()<1e-5&&(t=Communicator.Point3.cross(new Communicator.Point3(0,1,0),e)),this.lastAxis=e.copy(),this.lastAxis2=t.copy(),this._addAxisTranslationHandle(n,e,r),this._addAxisTranslationHandle(n,e.copy().scale(-1),r),this._addAxisRotationHandle(n,e,r),this._addAxisTranslationHandle(n,t,r)}}}}onMouseDown(t){if(t.shiftDown())return this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).removeHandles(),t.controlDown()?(this._addAxisTranslationHandle(this._currentSelItem.getPosition(),new Communicator.Point3(0,0,1),[]),void t.setHandled(!0)):(this.insertHandles(t.altDown()),void t.setHandled(!0))}onMouseMove(t){if(t.shiftDown()){let e=t.getPosition(),n=this._viewer.view,i=new Communicator.PickConfig(Communicator.SelectionMask.Line);n.pickFromPoint(e,i).then((t=>{this._currentSelItem=t;let e=t.getNodeId();if(null!==e){if(this._viewer.model.getNodeType(e)!==Communicator.NodeType.BodyInstance)return;null!==this._activeHighlight?t.equals(this._activeHighlight)||(this._setNodeLineHighlighted(this._activeHighlight,!1),this._setNodeLineHighlighted(t,!0)):this._setNodeLineHighlighted(t,!0)}else null!==this._activeHighlight&&this._setNodeLineHighlighted(this._activeHighlight,!1)}))}else null!==this._activeHighlight&&this._setNodeLineHighlighted(this._activeHighlight,!1)}onMouseUp(t){t.shiftDown()&&t.setHandled(!0)}_setNodeLineHighlighted(t,e){if(null!==t){let n=t.getNodeId(),i=t.getLineEntity();if(null!==n&&null!==i){let o=i.getLineId();this._viewer.model._setNodeLineHighlighted(n,o,e),this._activeHighlight=e?t:null}}}_getArcCenter(t){let e=t.getNodeId(),n=t.getLineEntity();if(null!==e&&null!==n){let t=this._viewer.model;return t.getEdgeProperty(e,n.getLineId()).then((i=>{if(i instanceof Communicator.SubentityProperties.CircleElement){const n=i.origin;return t.getNodeNetMatrix(e).transform(n,n),{center:n,normal:i.normal}}if(i instanceof Communicator.SubentityProperties.LineElement){const t=n.getPoints();if(2===t.length)return Communicator.Point3.add(t[1],t[0]).scale(.5)}return null}))}return Promise.resolve(null)}_addMainHandle(t,e){let n=this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);n.addHandles(t,e),n.showHandles()}_addAxisRotationHandle(t,e,n,i){i||(i=Communicator.Color.red());let o=this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);o.addAxisRotationHandle(t,e,i),o.setNodeIds(n),o.showHandles()}_addAxisTranslationHandle(t,e,n,i){i||(i=Communicator.Color.red());let o=this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);o.addAxisTranslationHandle(t.copy(),e,i),o.setNodeIds(n),o.showHandles()}}class pt{constructor(t){this._viewer=t,this._mouseDown=!1,this._component=null,this._disabled=!1}disable(){ut.viewer.selectionManager.clear(),this._disabled=!0}enable(){this._disabled=!1}onMouseDown(t){this._component&&!this._disabled&&(this._mouseDown=!0,this._startPosition=t.getPosition().copy(),this._currentcpos=this._component.getCurrentValue(),t.setHandled(!0))}onMouseMove(t){if(this._disabled)return;let e=t.getPosition();if(this._mouseDown){var n=t.getPosition();this._component.set(this._currentcpos+n.x-this._startPosition.x),this._component.getHierachy().updateComponents()}else{let t=this._viewer.view,n=new Communicator.PickConfig(Communicator.SelectionMask.Line);this._component=null,ut.viewer.selectionManager.clear(),t.pickFromPoint(e,n).then((t=>{let e=t.getNodeId();if(e){let t=null;for(;t=ut.getComponentFromNodeId(e),null===t&&(e=this._viewer.model.getNodeParent(e),e!=this._viewer.model.getRootNode()););null!==t&&(t.getType()!==r.revolute&&t.getType()!==r.prismatic||t.getAnimationActive()||(t.selectReferenceNodes(),this._component=t))}}))}}onMouseUp(t){this._mouseDown&&!this._disabled&&(this._mouseDown=!1,this._component=null,t.setHandled(!0))}}class ut{static initialize(t){ut.viewer=t,ut._hierachies=[],ut._hierachyTemplates=[],ut._animationTemplates=[],ut._animations=[],ut._animationGroups=[],ut.handlePlacementOperator=null,ut.componentMoveOperator=null}static setupHandleOperator(){ut.handlePlacementOperator=new ct(ut.viewer);let t=ut.viewer.operatorManager.registerCustomOperator(ut.handlePlacementOperator);ut.viewer.operatorManager.push(t),ut.handleNode=ut.viewer.model.createNode(ut.viewer.model.getRootNode(),"handlenode")}static setupComponentMoveOperator(){if(ut.componentMoveOperator)ut.componentMoveOperator.enable();else{ut.componentMoveOperator=new pt(ut.viewer);let t=ut.viewer.operatorManager.registerCustomOperator(ut.componentMoveOperator);ut.viewer.operatorManager.push(t)}}static disableComponentMoveOperator(){ut.componentMoveOperator.disable()}static getHierachyTemplates(){return ut._hierachyTemplates}static getHierachies(){return ut._hierachies}static getAnimationTemplates(){return ut._animationTemplates}static getAnimationTemplate(t){return ut._animationTemplates[t]}static getAnimationGroups(){return ut._animationGroups}static getHierachyByIndex(t){return ut._hierachies[t]}static getComponentFromNodeId(t){for(let e=0;e<ut._hierachies.length;e++){let n=ut._hierachies[e]._componentNodeidHash[t];if(null!=n)return n}return null}static getHierachyFromNodeId(t){if(null!=t&&t!=ut.viewer.model.getRootNode())for(;ut.viewer.model.getNodeParent(t)!=ut.viewer.model.getRootNode();)t=ut.viewer.model.getNodeParent(t);for(let e=0;e<ut._hierachies.length;e++)if(ut._hierachies[e].nodeid==t)return e}static applyToModel(t,e){let n=new ht;return n.fromJson(ut._hierachyTemplates[t]),n.applyToModel(e),n.setNodeId(e),ut._hierachies.push(n),n}static createHierachy(){let t=new ht;return this._hierachies.push(t),t}static addTemplate(t){return ut._hierachyTemplates[t._templateId]=t,t._templateId}static updateTemplate(t){ut._hierachyTemplates[t._templateId]=t}static getTemplate(t){return ut._hierachyTemplates[t]}static updateAnimationTemplate(t,e,n){let i=ut._animationTemplates[t];i.name=e,i.anime=n,ut._animationTemplates[t]=JSON.parse(JSON.stringify(i))}static addAnimationTemplate(t,e){let i={name:t,anime:e};i=JSON.parse(JSON.stringify(i));let o=n.generateGUID();return ut._animationTemplates[o]=i,o}static addAnimationTemplateFromJson(t,e){let n=JSON.parse(JSON.stringify(e));ut._animationTemplates[t]=n}static startAnimation(t,e){t.setAnimationActive(!0);let n=new mt("test",t,JSON.parse(JSON.stringify(e.anime)));ut._animations.push(n),1==ut._animations.length&&window.requestAnimationFrame(ut._doAnimation)}static stopAnimation(t){for(let e=0;e<ut._animations.length;e++)null!=t&&ut._animations[e].getComponent()!=t||ut._animations[e].setDone(!0)}static changeAnimationSpeed(t,e){for(let n=0;n<ut._animations.length;n++)ut._animations[n].component==t&&ut._animations[n].changeAnimationSpeed(e)}static deleteAnimationTemplate(t){delete ut._animationTemplates[t];for(let e=0;e<ut._hierachies.length;e++)ut._hierachies[e].removeAnimationFromComponents(t)}static addAnimationGroup(t){return ut._animationGroups.push(t),ut._animationGroups.length-1}static startAnimationGroup(t){ut._animationGroups[t].play()}static _doAnimation(t){if(ut._animations.length>0){for(let t=0;t<ut._hierachies.length;t++)ut._hierachies[t].setDirty(!1);for(let e=0;e<ut._animations.length;e++)ut._animations[e].getComponent().getHierachy().setDirty(!0),ut._animations[e].update(t),ut._animations[e].getDone()&&(ut._animations[e].getComponent().setAnimationActive(!1),ut._animations.splice(e,1),e--);for(let t=0;t<ut._hierachies.length;t++)ut._hierachies[t].getDirty()&&ut._hierachies[t].updateComponents();window.requestAnimationFrame(ut._doAnimation)}}}KT=e})();