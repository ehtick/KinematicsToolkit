var KM;(()=>{"use strict";var t={d:(e,i)=>{for(var n in i)t.o(i,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:i[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{KinematicsAnimationGroup:()=>lt,KinematicsBelt:()=>r,KinematicsHierachy:()=>ct,KinematicsJoint:()=>a,KinematicsManager:()=>ut,jointType:()=>o});class n{static nearestPointOnLine(t,e,i){e.normalize();var n=Communicator.Point3.subtract(i,t),r=Communicator.Point3.dot(n,e),o=Communicator.Point3.add(t,Communicator.Point3.scale(e,r));return Communicator.Point3.subtract(o,i),o}static closestPointOnPlane(t,e){let i=Communicator.Point3.dot(t.normal,e)+t.d;return Communicator.Point3.subtract(e,new Communicator.Point3(i*t.normal.x,i*t.normal.y,i*t.normal.z))}static signedAngle(t,e,i){return Math.atan2(Communicator.Point3.dot(Communicator.Point3.cross(t,e),i),Communicator.Point3.dot(t,e))*(180/Math.PI)}static ComputeVectorToVectorRotationMatrix(t,e){const i=1e-7;t.normalize(),e.normalize();let n=Communicator.Point3.cross(t,e),r=Communicator.Point3.dot(t,e),o=n.length();if(o>-1e-7&&o<i){if(!(r<0))return new Communicator.Matrix;if(t.x<-1e-7||t.x>i)n.x=t.y,n.y=-t.x,n.z=0;else if(t.y<-1e-7||t.y>i)n.x=-t.y,n.y=t.x,n.z=0;else{if(!(t.z<-1e-7||t.z>i))return new Communicator.Matrix;n.x=-t.z,n.z=t.x,n.y=0}}var a=Math.atan2(o,r);return a*=180/Math.PI,Communicator.Matrix.createFromOffAxisRotation(n,a)}static generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}static computeOffaxisRotationMatrix(t,e,i){let n=new Communicator.Matrix,r=new Communicator.Matrix;r=new Communicator.Matrix,r.setTranslationComponent(-t.x,-t.y,-t.z);let o=new Communicator.Matrix;o.setTranslationComponent(t.x,t.y,t.z),Communicator.Util.computeOffaxisRotation(e,i,n);let a=Communicator.Matrix.multiply(r,n);return Communicator.Matrix.multiply(a,o)}static circleIntersection(t,e,i,n,r,o){let a,s,l,h,c,m,u,d,p;if(s=n-t,l=r-e,h=Math.sqrt(l*l+s*s),h>i+o)return!1;if(h<Math.abs(i-o))return!1;a=(i*i-o*o+h*h)/(2*h),d=t+s*a/h,p=e+l*a/h,c=Math.sqrt(i*i-a*a),m=c/h*-l,u=s*(c/h);let _=d+m,g=d-m,f=p+u,x=p-u;return{p1:new Communicator.Point3(_,f,0),p2:new Communicator.Point3(g,x,0)}}}class r{constructor(){this._wheels=[],this._poslookup=[],this._baseNode=null,this._nodeids=[],this._segmentnum=500,this._width=10,this._thickness=10,this._gap=.1,this._tracks=0,this._alignvector=null,this._trackorientation=!1,this._color1=new Communicator.Color(64,64,64),this._color2=new Communicator.Color(20,20,20)}getBaseNode(){return this._baseNode}getWidth(){return this._width}setWidth(t){this._width=t}setSegmentNum(t){this._segmentnum=t}getSegmentNum(){return this._segmentnum}setThickness(t){this._thickness=t}getThickness(){return this._thickness}setGap(t){this._gap=t}getGap(){return this._gap}setTracks(t){this._tracks=t}getTracks(){return this._tracks}setTrackOrientation(t){this._trackorientation=t}getTrackOrientation(){return this._trackorientation}setAlignVector(t){this._alignvector=t}getAlignVector(){return this._alignvector}setColor1(t){this._color1=t}getColor1(){return this._color1}setColor2(t){this._color2=t}getColor2(){return this._color2}getWheelByIndex(){return this._wheels[i]}getWheels(){return this._wheels}initializeWheels(){this.calcuateAlignMatrix();for(let t=0;t<this._wheels.length;t++){let e=this._wheels[t],i=this.alignmatrix.transform(e.joint.getCenter());e.pos=new Communicator.Point3(i.x,i.y,0)}}addWheel(){this._wheels.push({pos:null,radius:0,joint:null,inner:!1,other:!1})}insertWheel(t){this_wheels.splice(t,0,{pos:null,radius:0,joint:null,inner:!1,other:!1})}deleteWheel(t){this_wheels.splice(t,1)}toJson(){let t={alignvector:this._alignvector?this._alignvector.toJson():null,wheels:[],segmentnum:this._segmentnum,width:this._width,thickness:this._thickness,gap:this._gap,tracks:this._tracks,trackorientation:this._trackorientation,color1:this._color1.toJson(),color2:this._color2.toJson()};for(let e=0;e<this._wheels.length;e++)t.wheels.push({radius:this._wheels[e].radius,joint:this._wheels[e].joint.getId(),inner:this._wheels[e].inner,other:this._wheels[e].other});return t}fromJson(t,e){this._segmentnum=t.segmentnum,t.width&&(this._width=t.width),t.thickness&&(this._thickness=t.thickness),t.color1&&(this._color1=Communicator.Color.fromJson(t.color1)),t.alignvector&&(this._alignvector=Communicator.Point3.fromJson(t.alignvector)),t.color2&&(this._color2=Communicator.Color.fromJson(t.color2)),this._gap=t.gap,this._tracks=t.tracks,t.trackorientation&&(this._trackorientation=t.trackorientation);for(let i=0;i<t.wheels.length;i++)this._wheels.push({pos:null,radius:t.wheels[i].radius,joint:e.getHierachy().getJointHash()[t.wheels[i].joint],inner:t.wheels[i].inner,other:t.wheels[i].other});return t}calcuateAlignMatrix(){let t;this._wheels.length>2&&!this._alignvector?(t=Communicator.Plane.createFromPoints(this._wheels[0].joint.getCenter(),this._wheels[1].joint.getCenter(),this._wheels[2].joint.getCenter()),this.alignmatrix=n.ComputeVectorToVectorRotationMatrix(t.normal,new Communicator.Point3(0,0,1))):this._alignvector?this.alignmatrix=n.ComputeVectorToVectorRotationMatrix(this._alignvector,new Communicator.Point3(0,0,1)):this.alignmatrix=n.ComputeVectorToVectorRotationMatrix(new Communicator.Point3(1,0,0),new Communicator.Point3(0,0,1));let e=this.alignmatrix.transform(this._wheels[0].joint.getCenter()),i=new Communicator.Matrix;i.setTranslationComponent(0,0,-e.z),this.alignmatrix=Communicator.Matrix.multiply(this.alignmatrix,i)}addBoxMesh(t,e,i,n){let r=[t.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,e.z,e.x,e.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,e.x,e.y,t.z,t.x,e.y,t.z,t.x,t.y,t.z,e.x,e.y,t.z,t.x,t.y,t.z,e.x,t.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,t.x,e.y,t.z,e.x,e.y,e.z,t.x,e.y,e.z,t.x,t.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,e.z,e.x,t.y,e.z,t.x,e.y,t.z,t.x,e.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,t.y,e.z,t.x,t.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,e.y,e.z,e.x,t.y,t.z,e.x,t.y,e.z],o=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0];for(let t=0;t<r.length;t++)i.push(r[t]);for(let t=0;t<o.length;t++)n.push(o[t])}async createMesh(t,e,i){let n=new Communicator.MeshData;n.setFaceWinding(Communicator.FaceWinding.Clockwise);let r=[],o=[];if(0==i)this.addBoxMesh(new Communicator.Point3(-e.x,-e.y,-e.z),new Communicator.Point3(e.x,e.y,e.z),r,o);else{this._trackorientation?this.addBoxMesh(new Communicator.Point3(-e.x,0,-e.z),new Communicator.Point3(e.x,e.y,e.z),r,o):this.addBoxMesh(new Communicator.Point3(-e.x,-e.y,-e.z),new Communicator.Point3(e.x,0,e.z),r,o);let t=2*e.x/(3*i),n=-e.x+t/2;for(let a=0;a<i;a++)this._trackorientation?this.addBoxMesh(new Communicator.Point3(n,-e.y,-e.z),new Communicator.Point3(n+2*t,0,e.z),r,o):this.addBoxMesh(new Communicator.Point3(n,0,-e.z),new Communicator.Point3(n+2*t,e.y,e.z),r,o),n+=2*t+t}return n.addFaces(r,o),await t.model.createMesh(n)}findCircleTangents(t,e){let i=t.pos.x,n=t.pos.y,r=e.pos.x,o=e.pos.y,a=t.radius,s=e.radius+1e-6,l=(r*a-i*s)/(a-s),h=(o*a-n*s)/(a-s),c=(Math.pow(a,2)*(l-i)+a*(h-n)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-n,2)-Math.pow(a,2)))/(Math.pow(l-i,2)+Math.pow(h-n,2))+i,m=(Math.pow(a,2)*(l-i)-a*(h-n)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-n,2)-Math.pow(a,2)))/(Math.pow(l-i,2)+Math.pow(h-n,2))+i,u=(Math.pow(a,2)*(h-n)-a*(l-i)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-n,2)-Math.pow(a,2)))/(Math.pow(l-i,2)+Math.pow(h-n,2))+n,d=(Math.pow(a,2)*(h-n)+a*(l-i)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-n,2)-Math.pow(a,2)))/(Math.pow(l-i,2)+Math.pow(h-n,2))+n,p=(Math.pow(s,2)*(l-r)+s*(h-o)*Math.sqrt(Math.pow(l-r,2)+Math.pow(h-o,2)-Math.pow(s,2)))/(Math.pow(l-r,2)+Math.pow(h-o,2))+r,_=(Math.pow(s,2)*(l-r)-s*(h-o)*Math.sqrt(Math.pow(l-r,2)+Math.pow(h-o,2)-Math.pow(s,2)))/(Math.pow(l-r,2)+Math.pow(h-o,2))+r,g=(Math.pow(s,2)*(h-o)-s*(l-r)*Math.sqrt(Math.pow(l-r,2)+Math.pow(h-o,2)-Math.pow(s,2)))/(Math.pow(l-r,2)+Math.pow(h-o,2))+o,f=(Math.pow(s,2)*(h-o)+s*(l-r)*Math.sqrt(Math.pow(l-r,2)+Math.pow(h-o,2)-Math.pow(s,2)))/(Math.pow(l-r,2)+Math.pow(h-o,2))+o;return{xt1:new Communicator.Point3(c,u,0),xt2:new Communicator.Point3(m,d,0),xt3:new Communicator.Point3(p,g,0),xt4:new Communicator.Point3(_,f,0)}}findCircleInnerTangents(t,e){let i=t.pos.x,n=t.pos.y,r=e.pos.x,o=e.pos.y,a=t.radius,s=e.radius+1e-6,l=(r*a+i*s)/(a+s),h=(o*a+n*s)/(a+s),c=(Math.pow(a,2)*(l-i)+a*(h-n)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-n,2)-Math.pow(a,2)))/(Math.pow(l-i,2)+Math.pow(h-n,2))+i,m=(Math.pow(a,2)*(l-i)-a*(h-n)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-n,2)-Math.pow(a,2)))/(Math.pow(l-i,2)+Math.pow(h-n,2))+i,u=(Math.pow(a,2)*(h-n)-a*(l-i)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-n,2)-Math.pow(a,2)))/(Math.pow(l-i,2)+Math.pow(h-n,2))+n,d=(Math.pow(a,2)*(h-n)+a*(l-i)*Math.sqrt(Math.pow(l-i,2)+Math.pow(h-n,2)-Math.pow(a,2)))/(Math.pow(l-i,2)+Math.pow(h-n,2))+n,p=(Math.pow(s,2)*(l-r)+s*(h-o)*Math.sqrt(Math.pow(l-r,2)+Math.pow(h-o,2)-Math.pow(s,2)))/(Math.pow(l-r,2)+Math.pow(h-o,2))+r,_=(Math.pow(s,2)*(l-r)-s*(h-o)*Math.sqrt(Math.pow(l-r,2)+Math.pow(h-o,2)-Math.pow(s,2)))/(Math.pow(l-r,2)+Math.pow(h-o,2))+r,g=(Math.pow(s,2)*(h-o)-s*(l-r)*Math.sqrt(Math.pow(l-r,2)+Math.pow(h-o,2)-Math.pow(s,2)))/(Math.pow(l-r,2)+Math.pow(h-o,2))+o,f=(Math.pow(s,2)*(h-o)+s*(l-r)*Math.sqrt(Math.pow(l-r,2)+Math.pow(h-o,2)-Math.pow(s,2)))/(Math.pow(l-r,2)+Math.pow(h-o,2))+o;return{xt1:new Communicator.Point3(c,u,0),xt2:new Communicator.Point3(m,d,0),xt3:new Communicator.Point3(p,g,0),xt4:new Communicator.Point3(_,f,0)}}async initialize(){this.initializeWheels();for(let t=0;t<this._wheels.length;t++){let e,i=t==this._wheels.length-1?0:t+1;this._wheels[t].inner?(e=this.findCircleInnerTangents(this._wheels[t],this._wheels[i]),this._wheels[t].other?(this._wheels[t].exitpos=e.xt2.copy(),this._wheels[i].enterpos=e.xt4.copy()):(this._wheels[t].exitpos=e.xt1.copy(),this._wheels[i].enterpos=e.xt3.copy())):(e=this.findCircleTangents(this._wheels[t],this._wheels[i]),this._wheels[t].other?(this._wheels[t].exitpos=e.xt2.copy(),this._wheels[i].enterpos=e.xt4.copy()):(this._wheels[t].exitpos=e.xt1.copy(),this._wheels[i].enterpos=e.xt3.copy()))}for(let t=0;t<this._wheels.length;t++)this._wheels[t].rotation=this.calculateWheelRotation(t);this.calculateTotalLength();let t=0;this._poslookup=[];for(let e=0;e<1e4;e++){t+=1e-4;let e=new Communicator.Matrix,i=this.computePositionOnBelt(t);e.setTranslationComponent(i.pos.x,i.pos.y,i.pos.z);let n=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(new Communicator.Point3(0,0,1),i.angle,n);let r=Communicator.Matrix.multiply(n,e);this._poslookup.push(r)}let e=this._totalLength/this._segmentnum,i=await this.createMesh(ut.viewer,new Communicator.Point3(e/2-e*this._gap+1e-4,this._thickness,this._width),this._tracks),n=new Communicator.MeshInstanceData(i);this._baseNode&&await ut.viewer.model.deleteNode(this._baseNode),this._baseNode=ut.viewer.model.createNode(ut.viewer.model.getRootNode()),this.adjustnode=ut.viewer.model.createNode(this._baseNode),this._nodeids=[];for(let t=0;t<this._segmentnum;t++)this._nodeids[t]=await ut.viewer.model.createMeshInstance(n,this.adjustnode),t%2?ut.viewer.model.setNodesFaceColor([this._nodeids[t]],this._color1):ut.viewer.model.setNodesFaceColor([this._nodeids[t]],this._color2);ut.viewer.model.setMetallicRoughness([this._baseNode],.2,.6),ut.viewer.model.setNodeMatrix(this.adjustnode,Communicator.Matrix.inverse(this.alignmatrix)),this.move(0)}calculateTotalLength(){this._totalLength=0;for(let t=0;t<this._wheels.length;t++){0==t&&this._wheels.length;let e=t==this._wheels.length-1?0:t+1,i=this._wheels[t];this._totalLength+=this.calculateCircumference(i.radius,i.rotation.steps),this._totalLength+=Communicator.Point3.subtract(i.exitpos,this._wheels[e].enterpos).length()}}computePositionOnBelt(t){let e=this._totalLength*t,i=0,r=0,o=Communicator.Point3.subtract(this._wheels[0].enterpos,this._wheels[this._wheels.length-1].exitpos).normalize();r=n.signedAngle(o,new Communicator.Point3(-1,0,0),new Communicator.Point3(0,0,-1));for(let t=0;t<this._wheels.length;t++){let n=t==this._wheels.length-1?0:t+1,o=this._wheels[t],a=this.calculateCircumference(o.radius,o.rotation.steps),s=Communicator.Point3.subtract(o.exitpos,this._wheels[n].enterpos).length();if(!(i+a<e)){let n=(e-i)/a*o.rotation.steps;return r+=Math.sign(o.rotation.angle)*n,{pos:this.wheelRotation(this._wheels[t],this._wheels[t].enterpos,Math.sign(o.rotation.angle)*n),angle:r}}if(i+=a,r+=Math.sign(o.rotation.angle)*o.rotation.steps,!(i+s<e)){let a=e-i,s=Communicator.Point3.subtract(this._wheels[n].enterpos,o.exitpos).normalize();return{pos:Communicator.Point3.add(this._wheels[t].exitpos,Communicator.Point3.scale(s,a)),angle:r}}i+=s}}calculateWheelRotation(t){let e=0==t?this._wheels.length-1:t-1,i=(this._wheels.length,this._wheels[t]),r=Communicator.Point3.subtract(i.enterpos,i.pos).normalize(),o=Communicator.Point3.subtract(i.exitpos,i.pos).normalize(),a=n.signedAngle(r,o,new Communicator.Point3(0,0,1)),s=Communicator.Point3.subtract(i.enterpos,this._wheels[e].exitpos).length(),l=this.wheelRotation(i,i.enterpos,2*Math.sign(a)),h=Communicator.Point3.subtract(l,this._wheels[e].exitpos).length(),c=Math.abs(a);return h<s&&(c=360-Math.abs(a),a=-a),{steps:c,angle:a}}wheelRotation(t,e,i){let n=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(new Communicator.Point3(0,0,1),i,n);let r=new Communicator.Matrix;r.setTranslationComponent(-t.pos.x,-t.pos.y,0);let o=new Communicator.Matrix;o.setTranslationComponent(t.pos.x,t.pos.y,0);let a=Communicator.Matrix.multiply(r,n);return Communicator.Matrix.multiply(a,o).transform(e)}async move(t){let e=this._totalLength/this._segmentnum;for(let i=0;i<this._segmentnum;i++)this.moveInternal(t+i*e,this._nodeids[i])}async moveInternal(t,e){let i=t%this._totalLength;i<0&&(i=this._totalLength+i);let n=Math.floor(i/this._totalLength*this._poslookup.length);ut.viewer.model.setNodeMatrix(e,this._poslookup[n])}animate(){let t=this;setInterval((function(){t.move(mover),mover+=.2}),10)}calculateCircumference(t,e){return e/360*2*Math.PI*t}calculateCircumferenceAngle(t,e){return e/(2*Math.PI*t)*360}}const o={revolute:0,prismatic:1,fixed:2,prismaticAggregate:3,prismaticTriangle:4,helical:5,mapped:6,pistonController:7,conveyor:8,prismaticPlane:9,belt:10,mate:11,revoluteSlide:12};class a{constructor(t,e){this._hierachy=e,this._id=e._highestId++,this._type=o.revolute,this._mappedType=null,this._children=[],this._parent=t,this._minangle=0,this._maxangle=0,this._nodeid=-1,this._center=new Communicator.Point3(0,0,0),this._axis=new Communicator.Point3(1,0,0),this._currentAngle=0,this._currentPosition=0,this._fixedAxis=null,this._fixedAxisTarget=null,this._referenceNodes=[],this._parentMatrix=new Communicator.Matrix,this._extraJoint1=null,this._extraJoint2=null,this._mappedTargetJoint=null,this._helicalFactor=1,this._reference=!0,this._touched=!1,this._animations=[]}initialize(t,e){this._reference=e,this._parent?this._nodeid=ut.viewer.model.createNode(this._parent._nodeid,"joint"):this._nodeid=ut.viewer.model.createNode(ut.viewer.model.getRootNode(),"rootJoint"),this._parentMatrix=ut.viewer.model.getNodeNetMatrix(ut.viewer.model.getNodeParent(t[0]));for(let e=0;e<t.length;e++)this._referenceNodes.push({nodeid:t[e],matrix:ut.viewer.model.getNodeNetMatrix(t[e]).copy()})}getId(){return this._id}setType(t){this._type=t}getType(){return this._type}setParent(t){this._parent=t}getParent(){return this._currentPosition}getChildren(){return this._children}getChildByIndex(t){return this._children[t]}setMappedType(t){this._mappedType=t}getMappedType(){return this._mappedType}setNodeId(t){this._nodeid=t}getNodeId(){return this._nodeid}getHierachy(){return this._hierachy}setCenter(t){this._center=t}getCenter(){return this._center}setAxis(t){this._axis=t}getAxis(){return this._axis}getCurrentAngle(){return this._currentAngle}getCurrentPosition(){return this._currentPosition}getReferenceNodes(){return this._referenceNodes}getParentMatrix(){return this._parentMatrix}getExtraJoint1(){return this._extraJoint1}setExtraJoint1(t){this._extraJoint1=t}setExtraJoint2(t){this._extraJoint2=t}getExtraJoint2(){return this._extraJoint2}setExtraPivot1(t){this._extraPivot1=t}getExtraPivot1(){return this._extraPivot1}setExtraPivot2(t){this._extraPivot2=t}getExtraPivot2(){return this._extraPivot2}setMappedTargetJoint(t){this._mappedTargetJoint=t}getMappedTargetJoint(){return this._mappedTargetJoint}setHelicalFactor(t){this._helicalFactor=t}getHelicalFactor(){return this._helicalFactor}setIsReference(t){this._reference=t}getIsReference(){return this._reference}getAnimations(){return this._animations}getAnimationByIndex(t){return this._animations[t]}getMinAngle(){return this._minangle}getMaxAngle(){return this._maxAngle}setFixedAxis(t){this._fixedAxis=t}setFixedAxisTarget(t){this._fixedAxisTarget=t}getFixedAxis(){return this._fixedAxis}getBelt(){return this.belt}setPrismaticPlanePlane(t){this._prismaticPlanePlane=t}getPrismaticPlanePlane(){return this._prismaticPlanePlane}setPrismaticPlaneTip(t){this._prismaticPlaneTip=t}getPrismaticPlaneTip(){return this._prismaticPlaneTip}set(t){this._type==o.revolute?this._rotate(t):this._type==o.prismatic&&this._translate(t)}toJson(){let t=[];for(let e=0;e<this._children.length;e++)t.push(this._children[e].toJson());let e=[];if(this._type==o.mapped&&this._mappedType==o.belt)for(let t=0;t<this._referenceNodes.length;t++)this._referenceNodes[t].nodeid!=this.belt.getBaseNode()&&e.push({nodeid:this._referenceNodes[t].nodeid,matrix:this._referenceNodes[t].matrix.toJson()});else for(let t=0;t<this._referenceNodes.length;t++)e.push({nodeid:this._referenceNodes[t].nodeid,matrix:this._referenceNodes[t].matrix.toJson()});let i={nodeid:this._nodeid,id:this._id,mappedType:this._mappedType,reference:this._reference,type:this._type,center:this._center.toJson(),axis:this._axis.toJson(),minangle:this._minangle,maxangle:this._maxangle,children:t,referenceNodes:e,parentMatrix:this._parentMatrix.toJson()};this._mappedType==o.belt&&(i.parentMatrix=(new Communicator.Matrix).toJson()),this._type==o.prismaticTriangle||this._type==o.prismaticAggregate||this._type==o.mate?(i.extraJoint1=this._extraJoint1._id,i.extraJoint2=this._extraJoint2._id,this._type==o.mate&&(i.extraPivot1=this._extraPivot1.toJson(),i.extraPivot2=this._extraPivot2.toJson())):this._type==o.revoluteSlide?(i.extraJoint1=this._extraJoint1._id,i.extraPivot1=this._extraPivot1.toJson()):this._type==o.pistonController?i._extraJoint1=this._extraJoint1._id:this._type==o.helical?i.helicalFactor=this._helicalFactor:this._type==o.mapped?(i.helicalFactor=this._helicalFactor,i.mappedTargetJoint=this._mappedTargetJoint._id,this._mappedType==o.belt&&(i.belt=this.belt.toJson()),this._mappedType==o.prismaticPlane&&(i._prismaticPlanePlane={d:this._prismaticPlanePlane.d,normal:this._prismaticPlanePlane.normal.toJson()},i._prismaticPlaneTip=this._prismaticPlaneTip.toJson())):this._type==o.revolute&&this._fixedAxis&&(i.fixedAxis=this._fixedAxis.toJson(),i.fixedAxisTarget=this._fixedAxisTarget.toJson()),i.animations=[];for(let t=0;t<this._animations.length;t++)i.animations.push(this._animations[t]);return i}async fromJson(t,e){if(this._minangle=t.minangle,this._maxangle=t._maxangle,this._reference=t.reference,this._center=Communicator.Point3.fromJson(t.center),null!=t.id&&(this._id=t.id,this._id>=this._hierachy._highestId&&(this._hierachy._highestId=this._id+1)),null==e){let e=Communicator.Point3.fromJson(t.axis);this._axis=Communicator.Point3.subtract(e,this._center).normalize(),isNaN(this._axis.x)&&(this._axis=new Communicator.Point3(1,0,0))}else this._axis=Communicator.Point3.fromJson(t.axis);this._type=t.type,this._mappedType=t.mappedType,this._parentMatrix=Communicator.Matrix.fromJson(t.parentMatrix),this._hierachy.getJointHash()[this._id]=this,this._parent?this._nodeid=ut.viewer.model.createNode(this._parent._nodeid,"joint"):this._nodeid=ut.viewer.model.createNode(ut.viewer.model.getRootNode(),"rootJoint");for(let e=0;e<t.referenceNodes.length;e++)this._referenceNodes.push({nodeid:t.referenceNodes[e].nodeid,matrix:Communicator.Matrix.fromJson(t.referenceNodes[e].matrix)}),this._hierachy._jointNodeidHash[t.referenceNodes[e].nodeid]=this;if(this._type==o.prismaticTriangle||this._type==o.prismaticAggregate||this._type==o.mate)this._extraJoint1=t.extraJoint1,this._extraJoint2=t.extraJoint2,this._type==o.mate&&(this._extraPivot1=Communicator.Point3.fromJson(t.extraPivot1),this._extraPivot2=Communicator.Point3.fromJson(t.extraPivot2));else if(this._type==o.revoluteSlide)this._extraJoint1=t.extraJoint1,this._extraPivot1=Communicator.Point3.fromJson(t.extraPivot1);else if(this._type==o.pistonController)this._extraJoint1=t.extraJoint1;else if(this._type==o.helical)this._helicalFactor=t.helicalFactor;else if(this._type==o.mapped){if(this._helicalFactor=t.helicalFactor,this._mappedTargetJoint=t.mappedTargetJoint,this._mappedType==o.belt){this.belt=new r,this.belt.fromJson(t.belt,this);for(let t=0;t<this._referenceNodes.length;t++)ut.viewer.model.setNodesVisibility([this._referenceNodes[t].nodeid],!1);await this.belt.initialize(),this._referenceNodes.push({nodeid:this.belt.getBaseNode(),matrix:new Communicator.Matrix})}if(this._mappedType==o.prismaticPlane){let e=Communicator.Point3.fromJson(t._prismaticPlanePlane.normal);this._prismaticPlanePlane=new Communicator.Plane,this._prismaticPlanePlane.d=t._prismaticPlanePlane.d,this._prismaticPlanePlane.normal=e,this._prismaticPlaneTip=Communicator.Point3.fromJson(t._prismaticPlaneTip)}}else if(this._type==o.revolute&&t.fixedAxis){if(null==e){let e=Communicator.Point3.fromJson(t.fixedAxis);this._fixedAxis=Communicator.Point3.subtract(e,this._center).normalize()}else this._fixedAxis=Communicator.Point3.fromJson(t.fixedAxis);this._fixedAxisTarget=Communicator.Point3.fromJson(t.fixedAxisTarget)}for(let i=0;i<t.children.length;i++){let n=new a(this,this._hierachy);n.fromJson(t.children[i],e),this._children.push(n)}if(t.animations)for(let e=0;e<t.animations.length;e++)this._animations.push(t.animations[e])}addAnimation(t){this._animations.push(t)}removeAnimation(t){for(let e=0;e<this._animations.length;e++)if(this._animations[e]==t)return void this._animations.splice(e,1)}removeAnimationRecursive(t){for(let e=0;e<this._children.length;e++)this._children[e].removeAnimationRecursive(t);this.removeAnimation(t)}animToJson(t){for(let e=0;e<this._children.length;e++)this._children[e].animToJson(t);for(let e=0;e<this._animations.length;e++)t[this._animations[e]]=!0}updateReferenceNodes(t){for(let t=0;t<this._referenceNodes.length;t++)delete this._hierachy._jointNodeidHash[this._referenceNodes[t].nodeid];this._referenceNodes=[];for(let e=0;e<t.length;e++)this._referenceNodes.push({nodeid:t[e],matrix:ut.viewer.model.getNodeNetMatrix(t[e]).copy()}),this._hierachy._jointNodeidHash[this._referenceNodes[e].nodeid]=this}removeReferenceNodes(t){for(let e=0;e<this._referenceNodes.length;e++)for(let i=0;i<t.length;i++)if(this._referenceNodes[e].nodeid==t[i]){delete this._hierachy._jointNodeidHash[this._referenceNodes[e].nodeid],this._referenceNodes.splice(e,1),e--;break}}transformPointToJointSpace(t){let e=this._hierachy.getReferenceNodeNetMatrix(this);return Communicator.Matrix.inverse(e).transform(t)}transformlocalPointToWorldSpace(t){return this._hierachy.getReferenceNodeNetMatrix(this).transform(t)}_rotate(t,e,i){i?this._currentAngle+=t:this._currentAngle=t;let n=new Communicator.Matrix,r=new Communicator.Matrix,o=this._axis;r=new Communicator.Matrix,r.setTranslationComponent(-this._center.x,-this._center.y,-this._center.z);let a=new Communicator.Matrix;a.setTranslationComponent(this._center.x,this._center.y,this._center.z),Communicator.Util.computeOffaxisRotation(o,t,n);let s=Communicator.Matrix.multiply(r,n),l=Communicator.Matrix.multiply(s,a);if(null!=i){let t=ut.viewer.model.getNodeMatrix(this._nodeid),e=Communicator.Matrix.multiply(t,l);ut.viewer.model.setNodeMatrix(this._nodeid,e)}else ut.viewer.model.setNodeMatrix(this._nodeid,l)}_translate(t){this._currentPosition=t,new Communicator.Matrix;let e=new Communicator.Matrix,i=this._axis;e=new Communicator.Matrix,e.setTranslationComponent(-this._center.x,-this._center.y,-this._center.z);let n=new Communicator.Matrix;n.setTranslationComponent(this._center.x,this._center.y,this._center.z);let r=new Communicator.Matrix;r.setTranslationComponent(i.x*t,i.y*t,i.z*t);let o=Communicator.Matrix.multiply(e,r),a=Communicator.Matrix.multiply(o,n);ut.viewer.model.setNodeMatrix(this._nodeid,a)}adjustExtraJointToPistonController(){let t=joint._axis,e=Communicator.Plane.createFromPointAndNormal(joint._center,t),i=n.closestPointOnPlane(e,joint._extraJoint1._center);joint._extraJoint1._axis=joint._extraJoint1._axis.copy(),joint._extraJoint1._center=i}async calculateReferenceMatrixFromHandleMatrix(t){let e;if(this._reference){let i,n=Communicator.Matrix.multiply(t,this._parentMatrix),r=Communicator.Matrix.inverse(this._referenceNodes[0].matrix),o=Communicator.Matrix.multiply(r,n);i=this._parent._parent?this._hierachy.getReferenceNodeNetMatrix(this._parent):new Communicator.Matrix,r=Communicator.Matrix.inverse(i),e=Communicator.Matrix.multiply(o,r)}else{let i=Communicator.Matrix.multiply(t,this._parentMatrix),n=Communicator.Matrix.inverse(this._referenceNodes[0].matrix);e=Communicator.Matrix.multiply(n,i)}if(this._type==o.revolute){let t=ut.viewer.model.getNodeMatrix(this._nodeid),i=this._axis,r=Communicator.Point3.cross(new Communicator.Point3(1,0,0),i);r.length()<1e-5&&(r=Communicator.Point3.cross(new Communicator.Point3(0,1,0),i));let o=Communicator.Point3.add(r,this._center),a=t.transform(joint._center),s=t.transform(o),l=(e.transform(this._center),e.transform(o)),h=Communicator.Point3.subtract(s,a).normalize(),c=Communicator.Point3.subtract(l,a).normalize(),m=n.signedAngle(h,c,i);await this._rotate(m,!0,!0)}else{let t=ut.viewer.model.getNodeNetMatrix(this._parent._nodeid);await ut.viewer.model.setNodeMatrix(this._nodeid,e);let i=ut.viewer.model.getNodeNetMatrix(this._nodeid),n=t.transform(this._center),r=i.transform(this._center),o=Communicator.Point3.subtract(r,n).length();await this._translate(o),n=ut.viewer.model.getNodeNetMatrix(this._nodeid).transform(this._center),r=Communicator.Matrix.multiply(t,e).transform(this._center),Communicator.Point3.subtract(r,n).length()>1e-4&&await this._translate(-o)}this._touched=!0}setParametersFromHandle(){let t=ut.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);if(t.getPosition()){let e=t.getPosition(),i=ut.handlePlacementOperator.lastAxis;if(!i)return;let n=this._hierachy.getReferenceNodeNetMatrix(this),r=Communicator.Matrix.inverse(n),o=r.transform(e),a=new Communicator.Point3(e.x+i.x,e.y+i.y,e.z+i.z),s=r.transform(a);this.setCenter(o),this.setAxis(Communicator.Point3.subtract(s,o).normalize())}}setFixedAxisFromHandle(t){let e=ut.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);if(e.getPosition()){if(!ut.handlePlacementOperator.lastAxis2)return;let i=Communicator.Point3.add(e.getPosition(),ut.handlePlacementOperator.lastAxis2),n=ut.viewer.model.getNodeMatrix(t);n.transform(e.getPosition()),i=n.transform(i),this._fixedAxis=Communicator.Point3.subtract(i,this.center).normalize(),this._fixedAxisTarget=new Communicator.Point3(0,-1,0)}}selectReferenceNodes(){ut.viewer.selectionManager.clear();let t=[];for(let e=0;e<this._referenceNodes.length;e++)t.push(Communicator.Selection.SelectionItem.create(this._referenceNodes[e].nodeid));ut.viewer.selectionManager.add(t)}showHandles(t,e,i,n){let r=this._hierachy.getReferenceNodeNetMatrix(this),a=r.transform(this._center),s=r.transform(Communicator.Point3.add(this._center,this._axis)),l=Communicator.Point3.subtract(s,a);n&&(a=n);let h=[];ut.viewer.selectionManager.clear();let c=[];for(let t=0;t<this._referenceNodes.length;t++)c.push(Communicator.Selection.SelectionItem.create(this._referenceNodes[t].nodeid)),h.push(this._referenceNodes[t].nodeid);if(ut.viewer.selectionManager.add(c),null!=i&&(h=[],h.push(i)),t._addAxisTranslationHandle(a,l,h),t._addAxisTranslationHandle(a,l.copy().scale(-1),h),this._type!=o.prismatic&&this._type!=o.prismaticTriangle&&t._addAxisRotationHandle(a,l,h),e||this._fixedAxis){let e;this._fixedAxis?e=this._fixedAxisTarget.copy():(e=Communicator.Point3.cross(new Communicator.Point3(1,0,0),l),e.length()<1e-5&&(e=Communicator.Point3.cross(new Communicator.Point3(0,1,0),l))),t._addAxisTranslationHandle(a,e,h),ut.handlePlacementOperator.lastAxis2=e.copy()}ut.handlePlacementOperator.lastAxis=l.copy()}async calculateGradient(){let t,e=this._currentAngle,i=this._currentPosition,n=this._hierachy.distanceFromTarget();return this._type==o.revolute?(await this._rotate(this._currentAngle+this._hierachy._ikSamplingDistance,!0),t=(this._hierachy.distanceFromTarget()-n)/this._hierachy._ikSamplingDistance):(await this._translate(this._currentPosition+this._hierachy._ikSamplingDistanceTranslation),t=(this._hierachy.distanceFromTarget()-n)/this._hierachy._ikSamplingDistanceTranslation),this._type==o.revolute?await this._rotate(e):await this._translate(i),this._touched=!0,t}async update(t){this._type==o.revolute?await this._rotate(this._currentAngle-this._hierachy._ikLearningRate*t):await this._translate(this._currentPosition-this._hierachy._ikLearningRate*t)}reset(){this._type==o.revolute?this._rotate(0):this._translate(0)}delete(){if(this._parent){delete this._hierachy.getJointHash()[this._id];for(let t=0;t<this._children.length;t++)this._children[t]._parent=this._parent,this._parent._children.push(this._children[t]);for(let t=0;t<this._parent._children.length;t++)if(this._parent._children[t]==this){this._parent._children.splice(t,1);break}}}moveup(){if(this._parent){for(let t=0;t<this._parent._children.length;t++)if(this._parent._children[t]==this){this._parent._children.splice(t,1);break}this._parent._parent._children.push(this)}}async _updateJointsFromReferenceRecursive(t){if(t){if(t._type==o.revoluteSlide){let e=t._extraJoint1.transformlocalPointToWorldSpace(t._extraPivot1),i=t._parent.transformlocalPointToWorldSpace(t._center),n=t._parent.transformlocalPointToWorldSpace(t._extraPivot1),r=Communicator.Point3.subtract(n,i).normalize(),o=Communicator.Point3.subtract(e,i).normalize(),a=Communicator.Util.computeAngleBetweenVector(r,o);await t._rotate(a);let s=t.transformlocalPointToWorldSpace(t._extraPivot1),l=new Communicator.Point3(i.x+1e4*o.x,i.y+1e4*o.y,i.z+1e4*o.z),h=new Communicator.Point3(0,0,0);Communicator.Util.computePointToLineDistance(s,i,l,h)>1e-4&&await t._rotate(-a)}if(t._type==o.mate){let e=Communicator.Point3.subtract(t._extraPivot1,t._extraPivot2).length(),i=t._extraJoint1.transformlocalPointToWorldSpace(t._extraPivot1),r=t._extraJoint2.transformlocalPointToWorldSpace(t._extraPivot2),o=Communicator.Point3.subtract(i,r).length();if(Math.abs(e-o)>.001){let i,r;t._extraJoint2._touched?(i={j:t._extraJoint1,pivot:t._extraPivot1},r={j:t._extraJoint2,pivot:t._extraPivot2}):(r={j:t._extraJoint1,pivot:t._extraPivot1},i={j:t._extraJoint2,pivot:t._extraPivot2}),t._extraJoint1._touched=!1,t._extraJoint2._touched=!1;let o=r.j.transformlocalPointToWorldSpace(r.pivot),a=i.j.transformlocalPointToWorldSpace(i.pivot),s=i.j.transformlocalPointToWorldSpace(i.j._center),l=r.j.transformlocalPointToWorldSpace(t._center),h=r.j.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),c=Communicator.Point3.subtract(h,l).normalize(),m=t._axis,u=n.ComputeVectorToVectorRotationMatrix(c,new Communicator.Point3(0,0,1)),d=Communicator.Matrix.inverse(u),p=u.transform(o),_=e,g=u.transform(s),f=Communicator.Point3.subtract(i.j._center,i.pivot).length(),x=n.circleIntersection(p.x,p.y,_,g.x,g.y,f);x.p1.z=p.z,x.p2.z=p.z;let w=d.transform(x.p1),v=d.transform(x.p2),y=Communicator.Point3.subtract(w,a).length(),P=Communicator.Point3.subtract(v,a).length();y>P&&(w=v);let C=r.j.transformlocalPointToWorldSpace(i.pivot),M=Communicator.Point3.subtract(C,o).normalize(),T=Communicator.Point3.subtract(w,o).normalize(),N=Communicator.Util.computeAngleBetweenVector(M,T),J=n.computeOffaxisRotationMatrix(r.pivot,m,N),A=Communicator.Matrix.inverse(ut.viewer.model.getNodeNetMatrix(ut.viewer.model.getNodeParent(t._nodeid))),b=Communicator.Matrix.multiply(J,ut.viewer.model.getNodeNetMatrix(r.j._nodeid)),I=Communicator.Matrix.multiply(b,A);await ut.viewer.model.setNodeMatrix(t._nodeid,I);let k=t.transformlocalPointToWorldSpace(i.pivot);if(Communicator.Point3.subtract(k,w).length()>1e-4){J=n.computeOffaxisRotationMatrix(r.pivot,m,-N),b=Communicator.Matrix.multiply(J,ut.viewer.model.getNodeNetMatrix(r.j._nodeid));let e=Communicator.Matrix.multiply(b,A);await ut.viewer.model.setNodeMatrix(t._nodeid,e)}C=i.j._parent.transformlocalPointToWorldSpace(i.pivot),M=Communicator.Point3.subtract(C,s).normalize(),T=Communicator.Point3.subtract(w,s).normalize(),N=Communicator.Util.computeAngleBetweenVector(M,T),await i.j._rotate(N);let S=this._hierachy.getReferenceNodeNetMatrix(i.j);k=S.transform(i.pivot),await i.j._rotate(-N),S=this._hierachy.getReferenceNodeNetMatrix(i.j);let H=S.transform(i.pivot);y=Communicator.Point3.subtract(k,w).length(),P=Communicator.Point3.subtract(H,w).length(),y<P&&await i.j._rotate(N),await this.getHierachy().updateJoints()}}else if(t._type==o.pistonController){let e=t._parent.transformlocalPointToWorldSpace(t._center),i=t._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),r=t._extraJoint1._parent.transformlocalPointToWorldSpace(t._extraJoint1._center),o=t._extraJoint1._parent.transformlocalPointToWorldSpace(Communicator.Point3.add(t._extraJoint1._center,t._extraJoint1._axis)),a=Communicator.Point3.subtract(o,r).normalize(),s=n.nearestPointOnLine(r,a,e),l=Communicator.Point3.subtract(s,e).length(),h=Communicator.Point3.subtract(t._extraJoint1._center,t._center).length(),c=Math.sqrt(h*h-l*l),m=Math.asin(c/h)*(180/Math.PI),u=new Communicator.Matrix,d=new Communicator.Matrix,p=Communicator.Point3.subtract(i,e).normalize();d=new Communicator.Matrix,d.setTranslationComponent(-e.x,-e.y,-e.z);let _=new Communicator.Matrix;_.setTranslationComponent(e.x,e.y,e.z),Communicator.Util.computeOffaxisRotation(p,-m,u);let g=Communicator.Matrix.multiply(d,u),f=Communicator.Matrix.multiply(g,_),x=Communicator.Point3.subtract(s,e).normalize();x.scale(c);let w=Communicator.Point3.add(e,x),v=f.transform(w);u=new Communicator.Matrix,Communicator.Util.computeOffaxisRotation(p,m,u),g=Communicator.Matrix.multiply(d,u),f=Communicator.Matrix.multiply(g,_),x=Communicator.Point3.subtract(s,e).normalize(),x.scale(c),w=Communicator.Point3.add(e,x);let y=f.transform(w),P=t._extraJoint1._parent.transformlocalPointToWorldSpace(t._extraJoint1._center),C=Communicator.Point3.subtract(v,P).length();Communicator.Point3.subtract(y,P).length()<C&&(v=y);let M=t._parent.transformlocalPointToWorldSpace(t._extraJoint1._center),T=Communicator.Point3.subtract(M,e).normalize(),N=Communicator.Point3.subtract(v,e).normalize(),J=Communicator.Util.computeAngleBetweenVector(T,N);await t._rotate(-J),M=t.transformlocalPointToWorldSpace(t._extraJoint1._center);let A=Communicator.Point3.subtract(M,v).length();await t._rotate(J),M=t.transformlocalPointToWorldSpace(t._extraJoint1._center),Communicator.Point3.subtract(M,v).length()>A&&await t._rotate(-J);let b=Communicator.Point3.subtract(t._extraJoint1._center,t.transformlocalPointToWorldSpace(t._extraJoint1._center)).length();await t._extraJoint1._translate(-b);let I=Communicator.Point3.subtract(t._extraJoint1.transformlocalPointToWorldSpace(t._extraJoint1._center),t.transformlocalPointToWorldSpace(t._extraJoint1._center)).length();await t._extraJoint1._translate(b),Communicator.Point3.subtract(t._extraJoint1.transformlocalPointToWorldSpace(t._extraJoint1._center),t.transformlocalPointToWorldSpace(t._extraJoint1._center)).length()>I&&await t._extraJoint1._translate(-b)}else if(t._type==o.prismaticAggregate){let e=ut.viewer.model.getNodeMatrix(t._extraJoint1._nodeid),i=ut.viewer.model.getNodeMatrix(t._extraJoint2._nodeid),n=Communicator.Matrix.multiply(e,i);await ut.viewer.model.setNodeMatrix(t._nodeid,n)}else if(t._type==o.prismaticTriangle){let e=t._extraJoint1.transformlocalPointToWorldSpace(t._center),i=t._extraJoint2.transformlocalPointToWorldSpace(t._extraJoint2._center),n=t._extraJoint2._parent.transformlocalPointToWorldSpace(t._center),r=Communicator.Point3.subtract(i,e),o=Communicator.Point3.subtract(i,n),a=r.length(),s=o.length();r.normalize(),o.normalize();let l=Communicator.Util.computeAngleBetweenVector(r,o);t._extraJoint2.transformlocalPointToWorldSpace(t._center),await t._extraJoint2._rotate(-l,!0);let h=t._extraJoint2.transformlocalPointToWorldSpace(t._center),c=Communicator.Point3.subtract(h,e).length();await t._extraJoint2._rotate(l,!0),h=t._extraJoint2.transformlocalPointToWorldSpace(t._center),Communicator.Point3.subtract(h,e).length()>c&&await t._extraJoint2._rotate(-l,!0),await this._updateReferenceNodeMatrices(t._extraJoint2),await t._translate(a-s)}else if(t._type==o.helical){let e=t._parent.transformlocalPointToWorldSpace(t._center),i=t.transformlocalPointToWorldSpace(t._center),n=Communicator.Point3.subtract(i,e).length();t._translate(n);let r=t.transformlocalPointToWorldSpace(t._center);t._translate(-n);let o=t.transformlocalPointToWorldSpace(t._center);Communicator.Point3.subtract(r,i).length()<Communicator.Point3.subtract(o,i).length()&&(t._translate(n),n=-n),t._rotate(n*t._helicalFactor,!0,!0)}else if(t._type==o.mapped)if(t._mappedType==o.prismaticPlane){let e=ut.viewer.model.getNodeNetMatrix(t._mappedTargetJoint._nodeid).transform(t._prismaticPlaneTip),i=t._prismaticPlanePlane.distanceToPoint(e);i<0?await t._translate(i*t._helicalFactor):await t._translate(0)}else if(t._mappedTargetJoint._type==o.prismatic||t._mappedTargetJoint._type==o.mapped&&t._mappedTargetJoint._mappedType==o.prismatic){let e=t._mappedTargetJoint._currentPosition,i=ut.viewer.model.getNodeMatrix(t._mappedTargetJoint._nodeid),n=t._mappedTargetJoint._parent.transformlocalPointToWorldSpace(t._mappedTargetJoint._center),r=t._mappedTargetJoint.transformlocalPointToWorldSpace(t._mappedTargetJoint._center),a=Communicator.Point3.subtract(r,n).length();t._mappedTargetJoint._translate(a);let s=t._mappedTargetJoint.transformlocalPointToWorldSpace(t._mappedTargetJoint._center);t._mappedTargetJoint._translate(-a);let l=t._mappedTargetJoint.transformlocalPointToWorldSpace(t._mappedTargetJoint._center);Communicator.Point3.subtract(s,r).length()<Communicator.Point3.subtract(l,r).length()&&(a=-a),ut.viewer.model.setNodeMatrix(t._mappedTargetJoint._nodeid,i),t._mappedType==o.revolute?(await t._rotate(a*t._helicalFactor,!0),t._currentAngle=a*t._helicalFactor):t._mappedType==o.prismatic?await t._translate(a*t._helicalFactor,!0):t._mappedType==o.belt&&await t.belt.move(a*t._helicalFactor),t._mappedTargetJoint._currentPosition=e}else t._mappedTargetJoint._type!=o.revolute&&t._mappedTargetJoint._type!=o.mapped||(t._mappedType==o.revolute?(await t._rotate(t._mappedTargetJoint._currentAngle*t._helicalFactor,!0),t._currentAngle=t._mappedTargetJoint._currentAngle*t._helicalFactor):t._mappedType==o.prismatic?await t._translate(t._mappedTargetJoint._currentAngle*t._helicalFactor,!0):t._mappedType==o.belt&&await t.belt.move(t._mappedTargetJoint._currentAngle*t._helicalFactor));else if(t._type==o.revolute&&t._fixedAxis){let e=t.transformlocalPointToWorldSpace(t._center),i=t.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._fixedAxis)),r=Communicator.Point3.subtract(i,e).normalize(),o=t._fixedAxisTarget,a=t.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._axis)),s=Communicator.Point3.subtract(a,e).normalize(),l=Communicator.Plane.createFromPointAndNormal(e,s),h=(l.distanceToPoint(new Communicator.Point3.add(e,o)),n.closestPointOnPlane(l,new Communicator.Point3.add(e,o)));o=new Communicator.Point3.subtract(h,e).normalize();let c=Communicator.Util.computeAngleBetweenVector(r,o);await t._rotate(c,!0,!0),e=t.transformlocalPointToWorldSpace(t._center),i=t.transformlocalPointToWorldSpace(Communicator.Point3.add(t._center,t._fixedAxis));let m=Communicator.Point3.subtract(i,e).normalize();Communicator.Point3.subtract(m,o).length()>.001&&await t._rotate(2*-c,!0,!0)}if(await this._updateReferenceNodeMatrices(t),t._children.length>0)for(let e=0;e<t._children.length;e++)await this._updateJointsFromReferenceRecursive(t._children[e])}}async _updateReferenceNodeMatrices(t){if(t._reference)if(t._parent&&0==t._parent._reference)for(let e=0;e<t._referenceNodes.length;e++){let i=Communicator.Matrix.multiply(t._referenceNodes[e].matrix,ut.viewer.model.getNodeMatrix(t._nodeid)),n=Communicator.Matrix.multiply(i,ut.viewer.model.getNodeMatrix(t._parent._nodeid)),r=Communicator.Matrix.inverse(t._parent._parentMatrix),o=Communicator.Matrix.multiply(n,r);ut.viewer.model.setNodeMatrix(t._referenceNodes[e].nodeid,o)}else for(let e=0;e<t._referenceNodes.length;e++){let i=Communicator.Matrix.multiply(t._referenceNodes[e].matrix,this._hierachy.getReferenceNodeNetMatrix(t)),n=Communicator.Matrix.inverse(t._parentMatrix),r=Communicator.Matrix.multiply(i,n);ut.viewer.model.setNodeMatrix(t._referenceNodes[e].nodeid,r)}else for(let e=0;e<t._referenceNodes.length;e++){let i=Communicator.Matrix.multiply(t._referenceNodes[e].matrix,ut.viewer.model.getNodeMatrix(t._nodeid)),n=Communicator.Matrix.inverse(t._parentMatrix),r=Communicator.Matrix.multiply(i,n);ut.viewer.model.setNodeMatrix(t._referenceNodes[e].nodeid,r)}}}var s={update:null,begin:null,loopBegin:null,changeBegin:null,change:null,changeComplete:null,loopComplete:null,complete:null,loop:1,direction:"normal",autoplay:!0,timelineOffset:0},l={duration:1e3,delay:0,endDelay:0,easing:"easeOutElastic(1, .5)",round:0},h=["translateX","translateY","translateZ","rotate","rotateX","rotateY","rotateZ","scale","scaleX","scaleY","scaleZ","skew","skewX","skewY","perspective","matrix","matrix3d"],c={CSS:{},springs:{}};function m(t,e,i){return Math.min(Math.max(t,e),i)}function u(t,e){return t.indexOf(e)>-1}function d(t,e){return t.apply(null,e)}var p={arr:function(t){return Array.isArray(t)},obj:function(t){return u(Object.prototype.toString.call(t),"Object")},pth:function(t){return p.obj(t)&&t.hasOwnProperty("totalLength")},svg:function(t){return t instanceof SVGElement},inp:function(t){return t instanceof HTMLInputElement},dom:function(t){return t.nodeType||p.svg(t)},str:function(t){return"string"==typeof t},fnc:function(t){return"function"==typeof t},und:function(t){return void 0===t},nil:function(t){return p.und(t)||null===t},hex:function(t){return/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(t)},rgb:function(t){return/^rgb/.test(t)},hsl:function(t){return/^hsl/.test(t)},col:function(t){return p.hex(t)||p.rgb(t)||p.hsl(t)},key:function(t){return!s.hasOwnProperty(t)&&!l.hasOwnProperty(t)&&"targets"!==t&&"keyframes"!==t}};function _(t){var e=/\(([^)]+)\)/.exec(t);return e?e[1].split(",").map((function(t){return parseFloat(t)})):[]}function g(t,e){var i=_(t),n=m(p.und(i[0])?1:i[0],.1,100),r=m(p.und(i[1])?100:i[1],.1,100),o=m(p.und(i[2])?10:i[2],.1,100),a=m(p.und(i[3])?0:i[3],.1,100),s=Math.sqrt(r/n),l=o/(2*Math.sqrt(r*n)),h=l<1?s*Math.sqrt(1-l*l):0,u=l<1?(l*s-a)/h:-a+s;function d(t){var i=e?e*t/1e3:t;return i=l<1?Math.exp(-i*l*s)*(1*Math.cos(h*i)+u*Math.sin(h*i)):(1+u*i)*Math.exp(-i*s),0===t||1===t?t:1-i}return e?d:function(){var e=c.springs[t];if(e)return e;for(var i=1/6,n=0,r=0;;)if(1===d(n+=i)){if(++r>=16)break}else r=0;var o=n*i*1e3;return c.springs[t]=o,o}}function f(t){return void 0===t&&(t=10),function(e){return Math.ceil(m(e,1e-6,1)*t)*(1/t)}}var x,w,v=function(){var t=.1;function e(t,e){return 1-3*e+3*t}function i(t,e){return 3*e-6*t}function n(t){return 3*t}function r(t,r,o){return((e(r,o)*t+i(r,o))*t+n(r))*t}function o(t,r,o){return 3*e(r,o)*t*t+2*i(r,o)*t+n(r)}return function(e,i,n,a){if(0<=e&&e<=1&&0<=n&&n<=1){var s=new Float32Array(11);if(e!==i||n!==a)for(var l=0;l<11;++l)s[l]=r(l*t,e,n);return function(l){return e===i&&n===a||0===l||1===l?l:r(function(i){for(var a=0,l=1;10!==l&&s[l]<=i;++l)a+=t;--l;var h=a+(i-s[l])/(s[l+1]-s[l])*t,c=o(h,e,n);return c>=.001?function(t,e,i,n){for(var a=0;a<4;++a){var s=o(e,i,n);if(0===s)return e;e-=(r(e,i,n)-t)/s}return e}(i,h,e,n):0===c?h:function(t,e,i,n,o){var a,s,l=0;do{(a=r(s=e+(i-e)/2,n,o)-t)>0?i=s:e=s}while(Math.abs(a)>1e-7&&++l<10);return s}(i,a,a+t,e,n)}(l),i,a)}}}}(),y=(x={linear:function(){return function(t){return t}}},w={Sine:function(){return function(t){return 1-Math.cos(t*Math.PI/2)}},Circ:function(){return function(t){return 1-Math.sqrt(1-t*t)}},Back:function(){return function(t){return t*t*(3*t-2)}},Bounce:function(){return function(t){for(var e,i=4;t<((e=Math.pow(2,--i))-1)/11;);return 1/Math.pow(4,3-i)-7.5625*Math.pow((3*e-2)/22-t,2)}},Elastic:function(t,e){void 0===t&&(t=1),void 0===e&&(e=.5);var i=m(t,1,10),n=m(e,.1,2);return function(t){return 0===t||1===t?t:-i*Math.pow(2,10*(t-1))*Math.sin((t-1-n/(2*Math.PI)*Math.asin(1/i))*(2*Math.PI)/n)}}},["Quad","Cubic","Quart","Quint","Expo"].forEach((function(t,e){w[t]=function(){return function(t){return Math.pow(t,e+2)}}})),Object.keys(w).forEach((function(t){var e=w[t];x["easeIn"+t]=e,x["easeOut"+t]=function(t,i){return function(n){return 1-e(t,i)(1-n)}},x["easeInOut"+t]=function(t,i){return function(n){return n<.5?e(t,i)(2*n)/2:1-e(t,i)(-2*n+2)/2}},x["easeOutIn"+t]=function(t,i){return function(n){return n<.5?(1-e(t,i)(1-2*n))/2:(e(t,i)(2*n-1)+1)/2}}})),x);function P(t,e){if(p.fnc(t))return t;var i=t.split("(")[0],n=y[i],r=_(t);switch(i){case"spring":return g(t,e);case"cubicBezier":return d(v,r);case"steps":return d(f,r);default:return d(n,r)}}function C(t){try{return document.querySelectorAll(t)}catch(t){return}}function M(t,e){for(var i=t.length,n=arguments.length>=2?arguments[1]:void 0,r=[],o=0;o<i;o++)if(o in t){var a=t[o];e.call(n,a,o,t)&&r.push(a)}return r}function T(t){return t.reduce((function(t,e){return t.concat(p.arr(e)?T(e):e)}),[])}function N(t){return p.arr(t)?t:(p.str(t)&&(t=C(t)||t),t instanceof NodeList||t instanceof HTMLCollection?[].slice.call(t):[t])}function J(t,e){return t.some((function(t){return t===e}))}function A(t){var e={};for(var i in t)e[i]=t[i];return e}function b(t,e){var i=A(t);for(var n in t)i[n]=e.hasOwnProperty(n)?e[n]:t[n];return i}function I(t,e){var i=A(t);for(var n in e)i[n]=p.und(t[n])?e[n]:t[n];return i}function k(t){var e=/[+-]?\d*\.?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?(%|px|pt|em|rem|in|cm|mm|ex|ch|pc|vw|vh|vmin|vmax|deg|rad|turn)?$/.exec(t);if(e)return e[1]}function S(t,e){return p.fnc(t)?t(e.target,e.id,e.total):t}function H(t,e){return t.getAttribute(e)}function z(t,e,i){if(J([i,"deg","rad","turn"],k(e)))return e;var n=c.CSS[e+i];if(!p.und(n))return n;var r=document.createElement(t.tagName),o=t.parentNode&&t.parentNode!==document?t.parentNode:document.body;o.appendChild(r),r.style.position="absolute",r.style.width=100+i;var a=100/r.offsetWidth;o.removeChild(r);var s=a*parseFloat(e);return c.CSS[e+i]=s,s}function j(t,e,i){if(e in t.style){var n=e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),r=t.style[e]||getComputedStyle(t).getPropertyValue(n)||"0";return i?z(t,r,i):r}}function R(t,e){return p.dom(t)&&!p.inp(t)&&(!p.nil(H(t,e))||p.svg(t)&&t[e])?"attribute":p.dom(t)&&J(h,e)?"transform":p.dom(t)&&"transform"!==e&&j(t,e)?"css":null!=t[e]?"object":void 0}function O(t){if(p.dom(t)){for(var e,i=t.style.transform||"",n=/(\w+)\(([^)]*)\)/g,r=new Map;e=n.exec(i);)r.set(e[1],e[2]);return r}}function F(t,e,i,n){switch(R(t,e)){case"transform":return function(t,e,i,n){var r=u(e,"scale")?1:0+function(t){return u(t,"translate")||"perspective"===t?"px":u(t,"rotate")||u(t,"skew")?"deg":void 0}(e),o=O(t).get(e)||r;return i&&(i.transforms.list.set(e,o),i.transforms.last=e),n?z(t,o,n):o}(t,e,n,i);case"css":return j(t,e,i);case"attribute":return H(t,e);default:return t[e]||0}}function D(t,e){var i=/^(\*=|\+=|-=)/.exec(t);if(!i)return t;var n=k(t)||0,r=parseFloat(e),o=parseFloat(t.replace(i[0],""));switch(i[0][0]){case"+":return r+o+n;case"-":return r-o+n;case"*":return r*o+n}}function W(t,e){if(p.col(t))return function(t){return p.rgb(t)?(i=/rgb\((\d+,\s*[\d]+,\s*[\d]+)\)/g.exec(e=t))?"rgba("+i[1]+",1)":e:p.hex(t)?function(t){var e=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(t,e,i,n){return e+e+i+i+n+n})),i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return"rgba("+parseInt(i[1],16)+","+parseInt(i[2],16)+","+parseInt(i[3],16)+",1)"}(t):p.hsl(t)?function(t){var e,i,n,r=/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.exec(t)||/hsla\((\d+),\s*([\d.]+)%,\s*([\d.]+)%,\s*([\d.]+)\)/g.exec(t),o=parseInt(r[1],10)/360,a=parseInt(r[2],10)/100,s=parseInt(r[3],10)/100,l=r[4]||1;function h(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}if(0==a)e=i=n=s;else{var c=s<.5?s*(1+a):s+a-s*a,m=2*s-c;e=h(m,c,o+1/3),i=h(m,c,o),n=h(m,c,o-1/3)}return"rgba("+255*e+","+255*i+","+255*n+","+l+")"}(t):void 0;var e,i}(t);if(/\s/g.test(t))return t;var i=k(t),n=i?t.substr(0,t.length-i.length):t;return e?n+e:n}function L(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function B(t){for(var e,i=t.points,n=0,r=0;r<i.numberOfItems;r++){var o=i.getItem(r);r>0&&(n+=L(e,o)),e=o}return n}function E(t){if(t.getTotalLength)return t.getTotalLength();switch(t.tagName.toLowerCase()){case"circle":return function(t){return 2*Math.PI*H(t,"r")}(t);case"rect":return function(t){return 2*H(t,"width")+2*H(t,"height")}(t);case"line":return function(t){return L({x:H(t,"x1"),y:H(t,"y1")},{x:H(t,"x2"),y:H(t,"y2")})}(t);case"polyline":return B(t);case"polygon":return function(t){var e=t.points;return B(t)+L(e.getItem(e.numberOfItems-1),e.getItem(0))}(t)}}function q(t,e){var i=e||{},n=i.el||function(t){for(var e=t.parentNode;p.svg(e)&&p.svg(e.parentNode);)e=e.parentNode;return e}(t),r=n.getBoundingClientRect(),o=H(n,"viewBox"),a=r.width,s=r.height,l=i.viewBox||(o?o.split(" "):[0,0,a,s]);return{el:n,viewBox:l,x:l[0]/1,y:l[1]/1,w:a,h:s,vW:l[2],vH:l[3]}}function G(t,e,i){function n(i){void 0===i&&(i=0);var n=e+i>=1?e+i:0;return t.el.getPointAtLength(n)}var r=q(t.el,t.svg),o=n(),a=n(-1),s=n(1),l=i?1:r.w/r.vW,h=i?1:r.h/r.vH;switch(t.property){case"x":return(o.x-r.x)*l;case"y":return(o.y-r.y)*h;case"angle":return 180*Math.atan2(s.y-a.y,s.x-a.x)/Math.PI}}function V(t,e){var i=/[+-]?\d*\.?\d+(?:\.\d+)?(?:[eE][+-]?\d+)?/g,n=W(p.pth(t)?t.totalLength:t,e)+"";return{original:n,numbers:n.match(i)?n.match(i).map(Number):[0],strings:p.str(t)||e?n.split(i):[]}}function K(t){return M(t?T(p.arr(t)?t.map(N):N(t)):[],(function(t,e,i){return i.indexOf(t)===e}))}function U(t){var e=K(t);return e.map((function(t,i){return{target:t,id:i,total:e.length,transforms:{list:O(t)}}}))}function $(t,e){var i=A(e);if(/^spring/.test(i.easing)&&(i.duration=g(i.easing)),p.arr(t)){var n=t.length;2!==n||p.obj(t[0])?p.fnc(e.duration)||(i.duration=e.duration/n):t={value:t}}var r=p.arr(t)?t:[t];return r.map((function(t,i){var n=p.obj(t)&&!p.pth(t)?t:{value:t};return p.und(n.delay)&&(n.delay=i?0:e.delay),p.und(n.endDelay)&&(n.endDelay=i===r.length-1?e.endDelay:0),n})).map((function(t){return I(t,i)}))}var Q={css:function(t,e,i){return t.style[e]=i},attribute:function(t,e,i){return t.setAttribute(e,i)},object:function(t,e,i){return t[e]=i},transform:function(t,e,i,n,r){if(n.list.set(e,i),e===n.last||r){var o="";n.list.forEach((function(t,e){o+=e+"("+t+") "})),t.style.transform=o}}};function X(t,e){U(t).forEach((function(t){for(var i in e){var n=S(e[i],t),r=t.target,o=k(n),a=F(r,i,o,t),s=D(W(n,o||k(a)),a),l=R(r,i);Q[l](r,i,s,t.transforms,!0)}}))}function Y(t,e){return M(T(t.map((function(t){return e.map((function(e){return function(t,e){var i=R(t.target,e.name);if(i){var n=function(t,e){var i;return t.tweens.map((function(n){var r=function(t,e){var i={};for(var n in t){var r=S(t[n],e);p.arr(r)&&1===(r=r.map((function(t){return S(t,e)}))).length&&(r=r[0]),i[n]=r}return i.duration=parseFloat(i.duration),i.delay=parseFloat(i.delay),i}(n,e),o=r.value,a=p.arr(o)?o[1]:o,s=k(a),l=F(e.target,t.name,s,e),h=i?i.to.original:l,c=p.arr(o)?o[0]:h,m=k(c)||k(l),u=s||m;return p.und(a)&&(a=h),r.from=V(c,u),r.to=V(D(a,c),u),r.start=i?i.end:0,r.end=r.start+r.delay+r.duration+r.endDelay,r.easing=P(r.easing,r.duration),r.isPath=p.pth(o),r.isPathTargetInsideSVG=r.isPath&&p.svg(e.target),r.isColor=p.col(r.from.original),r.isColor&&(r.round=1),i=r,r}))}(e,t),r=n[n.length-1];return{type:i,property:e.name,animatable:t,tweens:n,duration:r.end,delay:n[0].delay,endDelay:r.endDelay}}}(t,e)}))}))),(function(t){return!p.und(t)}))}function Z(t,e){var i=t.length,n=function(t){return t.timelineOffset?t.timelineOffset:0},r={};return r.duration=i?Math.max.apply(Math,t.map((function(t){return n(t)+t.duration}))):e.duration,r.delay=i?Math.min.apply(Math,t.map((function(t){return n(t)+t.delay}))):e.delay,r.endDelay=i?r.duration-Math.max.apply(Math,t.map((function(t){return n(t)+t.duration-t.endDelay}))):e.endDelay,r}var tt=0,et=[],it=function(){var t;function e(i){for(var n=et.length,r=0;r<n;){var o=et[r];o.paused?(et.splice(r,1),n--):(o.tick(i),r++)}t=r>0?requestAnimationFrame(e):void 0}return"undefined"!=typeof document&&document.addEventListener("visibilitychange",(function(){rt.suspendWhenDocumentHidden&&(nt()?t=cancelAnimationFrame(t):(et.forEach((function(t){return t._onDocumentVisibility()})),it()))})),function(){t||nt()&&rt.suspendWhenDocumentHidden||!(et.length>0)||(t=requestAnimationFrame(e))}}();function nt(){return!!document&&document.hidden}function rt(t){void 0===t&&(t={});var e,i=0,n=0,r=0,o=0,a=null;function h(t){var e=window.Promise&&new Promise((function(t){return a=t}));return t.finished=e,e}var c=function(t){var e=b(s,t),i=b(l,t),n=function(t,e){var i=[],n=e.keyframes;for(var r in n&&(e=I(function(t){for(var e=M(T(t.map((function(t){return Object.keys(t)}))),(function(t){return p.key(t)})).reduce((function(t,e){return t.indexOf(e)<0&&t.push(e),t}),[]),i={},n=function(n){var r=e[n];i[r]=t.map((function(t){var e={};for(var i in t)p.key(i)?i==r&&(e.value=t[i]):e[i]=t[i];return e}))},r=0;r<e.length;r++)n(r);return i}(n),e)),e)p.key(r)&&i.push({name:r,tweens:$(e[r],t)});return i}(i,t),r=U(t.targets),o=Y(r,n),a=Z(o,i),h=tt;return tt++,I(e,{id:h,children:[],animatables:r,animations:o,duration:a.duration,delay:a.delay,endDelay:a.endDelay})}(t);function u(){var t=c.direction;"alternate"!==t&&(c.direction="normal"!==t?"normal":"reverse"),c.reversed=!c.reversed,e.forEach((function(t){return t.reversed=c.reversed}))}function d(t){return c.reversed?c.duration-t:t}function _(){i=0,n=d(c.currentTime)*(1/rt.speed)}function g(t,e){e&&e.seek(t-e.timelineOffset)}function f(t){for(var e=0,i=c.animations,n=i.length;e<n;){var r=i[e],o=r.animatable,a=r.tweens,s=a.length-1,l=a[s];s&&(l=M(a,(function(e){return t<e.end}))[0]||l);for(var h=m(t-l.start-l.delay,0,l.duration)/l.duration,u=isNaN(h)?1:l.easing(h),d=l.to.strings,p=l.round,_=[],g=l.to.numbers.length,f=void 0,x=0;x<g;x++){var w=void 0,v=l.to.numbers[x],y=l.from.numbers[x]||0;w=l.isPath?G(l.value,u*v,l.isPathTargetInsideSVG):y+u*(v-y),p&&(l.isColor&&x>2||(w=Math.round(w*p)/p)),_.push(w)}var P=d.length;if(P){f=d[0];for(var C=0;C<P;C++){d[C];var T=d[C+1],N=_[C];isNaN(N)||(f+=T?N+T:N+" ")}}else f=_[0];Q[r.type](o.target,r.property,f,o.transforms),r.currentValue=f,e++}}function x(t){c[t]&&!c.passThrough&&c[t](c)}function w(t){var s=c.duration,l=c.delay,p=s-c.endDelay,_=d(t);c.progress=m(_/s*100,0,100),c.reversePlayback=_<c.currentTime,e&&function(t){if(c.reversePlayback)for(var i=o;i--;)g(t,e[i]);else for(var n=0;n<o;n++)g(t,e[n])}(_),!c.began&&c.currentTime>0&&(c.began=!0,x("begin")),!c.loopBegan&&c.currentTime>0&&(c.loopBegan=!0,x("loopBegin")),_<=l&&0!==c.currentTime&&f(0),(_>=p&&c.currentTime!==s||!s)&&f(s),_>l&&_<p?(c.changeBegan||(c.changeBegan=!0,c.changeCompleted=!1,x("changeBegin")),x("change"),f(_)):c.changeBegan&&(c.changeCompleted=!0,c.changeBegan=!1,x("changeComplete")),c.currentTime=m(_,0,s),c.began&&x("update"),t>=s&&(n=0,c.remaining&&!0!==c.remaining&&c.remaining--,c.remaining?(i=r,x("loopComplete"),c.loopBegan=!1,"alternate"===c.direction&&u()):(c.paused=!0,c.completed||(c.completed=!0,x("loopComplete"),x("complete"),!c.passThrough&&"Promise"in window&&(a(),h(c)))))}return h(c),c.reset=function(){var t=c.direction;c.passThrough=!1,c.currentTime=0,c.progress=0,c.paused=!0,c.began=!1,c.loopBegan=!1,c.changeBegan=!1,c.completed=!1,c.changeCompleted=!1,c.reversePlayback=!1,c.reversed="reverse"===t,c.remaining=c.loop,e=c.children;for(var i=o=e.length;i--;)c.children[i].reset();(c.reversed&&!0!==c.loop||"alternate"===t&&1===c.loop)&&c.remaining++,f(c.reversed?c.duration:0)},c._onDocumentVisibility=_,c.set=function(t,e){return X(t,e),c},c.tick=function(t){r=t,i||(i=r),w((r+(n-i))*rt.speed)},c.seek=function(t){w(d(t))},c.pause=function(){c.paused=!0,_()},c.play=function(){c.paused&&(c.completed&&c.reset(),c.paused=!1,et.push(c),_(),it())},c.reverse=function(){u(),c.completed=!c.reversed,_()},c.restart=function(){c.reset(),c.play()},c.remove=function(t){at(K(t),c)},c.reset(),c.autoplay&&c.play(),c}function ot(t,e){for(var i=e.length;i--;)J(t,e[i].animatable.target)&&e.splice(i,1)}function at(t,e){var i=e.animations,n=e.children;ot(t,i);for(var r=n.length;r--;){var o=n[r],a=o.animations;ot(t,a),a.length||o.children.length||n.splice(r,1)}i.length||n.length||e.pause()}rt.version="3.2.1",rt.speed=1,rt.suspendWhenDocumentHidden=!0,rt.running=et,rt.remove=function(t){for(var e=K(t),i=et.length;i--;)at(e,et[i])},rt.get=F,rt.set=X,rt.convertPx=z,rt.path=function(t,e){var i=p.str(t)?C(t)[0]:t,n=e||100;return function(t){return{property:t,el:i,svg:q(i),totalLength:E(i)*(n/100)}}},rt.setDashoffset=function(t){var e=E(t);return t.setAttribute("stroke-dasharray",e),e},rt.stagger=function(t,e){void 0===e&&(e={});var i=e.direction||"normal",n=e.easing?P(e.easing):null,r=e.grid,o=e.axis,a=e.from||0,s="first"===a,l="center"===a,h="last"===a,c=p.arr(t),m=c?parseFloat(t[0]):parseFloat(t),u=c?parseFloat(t[1]):0,d=k(c?t[1]:t)||0,_=e.start||0+(c?m:0),g=[],f=0;return function(t,e,p){if(s&&(a=0),l&&(a=(p-1)/2),h&&(a=p-1),!g.length){for(var x=0;x<p;x++){if(r){var w=l?(r[0]-1)/2:a%r[0],v=l?(r[1]-1)/2:Math.floor(a/r[0]),y=w-x%r[0],P=v-Math.floor(x/r[0]),C=Math.sqrt(y*y+P*P);"x"===o&&(C=-y),"y"===o&&(C=-P),g.push(C)}else g.push(Math.abs(a-x));f=Math.max.apply(Math,g)}n&&(g=g.map((function(t){return n(t/f)*f}))),"reverse"===i&&(g=g.map((function(t){return o?t<0?-1*t:-t:Math.abs(f-t)})))}return _+(c?(u-m)/f:m)*(Math.round(100*g[e])/100)+d}},rt.timeline=function(t){void 0===t&&(t={});var e=rt(t);return e.duration=0,e.add=function(i,n){var r=et.indexOf(e),o=e.children;function a(t){t.passThrough=!0}r>-1&&et.splice(r,1);for(var s=0;s<o.length;s++)a(o[s]);var h=I(i,b(l,t));h.targets=h.targets||t.targets;var c=e.duration;h.autoplay=!1,h.direction=e.direction,h.timelineOffset=p.und(n)?c:D(n,c),a(e),e.seek(h.timelineOffset);var m=rt(h);a(m),o.push(m);var u=Z(o,t);return e.delay=u.delay,e.endDelay=u.endDelay,e.duration=u.duration,e.seek(0),e.reset(),e.autoplay&&e.play(),e},e},rt.easing=P,rt.penner=y,rt.random=function(t,e){return Math.floor(Math.random()*(e-t+1))+t};const st=rt;class lt{constructor(t){this._hierachy=t,this._animations=[],this.name=""}getAnimations(){return this._animations}getAnimationByIndex(t){return this._animations[t]}addAnimation(t,e){this._animations.push({animation:t,joint:e})}setName(t){this.name=t}getName(){return this.name}toJson(){return{animations:this._animations,name:this.name}}fromJson(t){this._animations=t.animations,this.name=t.name}play(){for(let t=0;t<this._animations.length;t++){let e=this._animations[t],i=ut.getAnimationTemplate(e.animation),n=this._hierachy.getJointHash()[e.joint];ut.startAnimation(n,i.anime)}}}class ht{static fromJson(t,e){return new ht(t.name,e,t.animedef)}constructor(t,e,i){this.name=t,this._joint=e,this._done=!1;let n=this;this._joint.getType()==o.revolute?this.value=this._joint.getCurrentAngle():this.value=this._joint.getCurrentPosition(),null!=i.infinite&&i.infinite?(this.type=1,this.startTime=Date.now(),this.lasttime=this.startTime,this.easeInTime=parseInt(i.easeintime)/1e3,this.target=parseInt(i.value),this.previoustarget=0):(this.type=0,null!=i.startcolor&&(this.color=i.startcolor,i.startcolor=void 0,i.color=i.endcolor,i.endcolor=void 0),i.targets=this,i.autoplay=!1,i.complete=function(){n.anime.remove(),n._done=!0},this.anime=st(i))}getName(){return this.name}getJoint(){return this._joint}getDone(){return this._done}setDone(t){this._done=t}update(t){if(null!=this.color){this.anime.tick(t);let e=this._joint.getReferenceNodes();for(let t=0;t<e.length;t++){let i=this.color.substring(5,this.color.length-1).split(",");ut.viewer.model.setNodesFaceColor([e[t].nodeid],new Communicator.Color(parseInt(i[0]),parseInt(i[1]),parseInt(i[2])))}}else{if(1==this.type){let t=Date.now(),e=(t-this.lasttime)/1e3,i=(t-this.startTime)/1e3,n=this.target;i<this.easeInTime&&(n=this.easeInQuad(i,this.previoustarget,this.target-this.previoustarget,this.easeInTime));let r=this.value+e*n;this._joint.set(r),this.lasttime=t,this.value=r}else this.anime.tick(t),this._joint.set(parseFloat(this.value));this._joint._touched=!0}}changeSpeed(t){this.previoustarget=this.target,this.target=t,this.startTime=Date.now(),this.lasttime=Date.now()}easeInQuad(t,e,i,n){return i*(t/=n)*t+e}}class ct{constructor(){this._templateId=null,this._highestId=0,this._nodeid=void 0,this._jointNodeidHash=[],this._jointHash=[],this._ikTip=new Communicator.Point3(0,0,0),this._ikThreshold=1,this._highestId=0,this._ikSpeed=100,this._ikSamplingDistance=.1,this._ikSamplingDistanceTranslation=1,this._ikLearningRate=.1,this._interval=null,this._targetPoint=new Communicator.Point3(0,0,0),this._rootJoint=this.createJoint(null,[],!0),this._rootJoint.setType(o.fixed),this._tipJoint=null,this._targetAnchorPosition=null,this._targetAnchorNode=null,this._dirty=!1}getTemplateId(){return this._templateId}setDirty(t){this._dirty=!0}getDirty(){return this._dirty}async updateJoints(){await this._rootJoint._updateJointsFromReferenceRecursive(this._rootJoint)}setNodeId(t){this._nodeid=t}setIkTip(t){this._ikTip=t}getIkTip(){return this._ikTip}setIkThreshold(t){this._ikThreshold=t}getIkThreshold(){return this._ikThreshold}setIkSpeed(t){this._ikSpeed=t}getIkSpeed(){return this._ikSpeed}setIkSamplingDistance(t){this._ikSamplingDistance=t}getIkSamplingDistance(){return this._ikSamplingDistance}setIkSamplingDistanceTranslation(t){this._ikSamplingDistanceTranslation=t}getIkSamplingDistanceTranslation(){return this._ikSamplingDistanceTranslation}setIkLearningRate(t){this._ikLearningRate=t}getIkLearningRate(){return this._ikLearningRate}getJointHash(){return this._jointHash}getRootJoint(){return this._rootJoint}getJointById(t){return this._jointHash[t]}isIKActive(){return!!this._interval}stopIK(){this._interval&&(clear_interval(this._interval),this._interval=null)}startIKFromHandle(){if(!this._interval){let t=this,e=ut.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);this._interval=set_interval((async function(){if(e.getPosition()||t._targetAnchorPosition){if(t._targetAnchorPosition){let e=ut.viewer.model.getNodeNetMatrix(t._targetAnchorNode);t._targetPoint=e.transform(t._targetAnchorPosition)}else{let e=ut.viewer.model.getNodeMatrix(ut.handleNode);t._targetPoint=e.transform(new Communicator.Point3(0,0,0))}for(let e=0;e<t._ikSpeed;e++)t.distanceFromTarget()>t._ikThreshold&&await t._inverseKinematics()}}),1)}}generateTemplate(){if(this._templateId){let t=KM.KinematicsManager.toJson(this);KM.KinematicsManager.updateTemplate(t)}else{this._templateId=n.generateGUID();let t=this.toJson();KM.KinematicsManager.addTemplate(t)}}insertIKHandle(){let t=ut.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);t.removeHandles(),t.addHandles([ut.handleNode],this._targetPoint),ut.viewer.model.setNodesVisibility([ut.handleNode],!0),t.showHandles()}setIKHandleToTip(t){let e=this.getReferenceNodeNetMatrix(this._tipJoint),i=e.transform(this._ikTip);e=new Communicator.Matrix,e.setTranslationComponent(i.x,i.y,i.z),this._targetPoint=i.copy(),ut.viewer.model.setNodeMatrix(ut.handleNode,e),t&&this.insertIKHandle()}setTipToHandlePosition(){let t=ut.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).getPosition();this._ikTip=this._tipJoint.transformPointToJointSpace(t)}setTargetAnchorToHandlePosition(){let t=ut.viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).getPosition(),e=ut.viewer.selectionManager.getResults()[0].getNodeId(),i=Communicator.Matrix.inverse(ut.viewer.model.getNodeNetMatrix(e));this._targetAnchorPosition=i.transform(t),this._targetAnchorNode=e}removeAnimationFromJoints(t){this._rootJoint.removeAnimationRecursive(t)}toJson(){let t={version:1,_ikTip:this._ikTip.toJson(),_templateId:this._templateId,_ikSamplingDistance:this._ikSamplingDistance,_ikSamplingDistanceTranslation:this._ikSamplingDistanceTranslation,_ikLearningRate:this._ikLearningRate,_ikThreshold:this._ikThreshold,_ikSpeed:this._ikSpeed,_targetAnchorNode:this._targetAnchorNode};this._targetAnchorPosition&&(t._targetAnchorPosition=this._targetAnchorPosition.toJson()),t.joints=this._rootJoint.toJson();let e=[],i=[];this._rootJoint.animToJson(e);for(let t in e){let e=ut.getAnimationTemplate(t);null!=e&&(e._templateId=t,i.push(e))}t.animations=i,t.animationGroups=[];for(let e=0;e<ut._animationGroups.length;e++){let i=ut._animationGroups[e];i.hierachy==this&&t.animationGroups.push(i.toJson())}return t}fromJson(t){this._highestId=0,this._ikTip=Communicator.Point3.fromJson(t._ikTip),this._ikThreshold=t._ikThreshold,this._ikSpeed=t._ikSpeed,this._ikSamplingDistance=t._ikSamplingDistance,this._ikSamplingDistanceTranslation=t._ikSamplingDistanceTranslation,this._ikLearningRate=t._ikLearningRate,this._targetAnchorNode=t._targetAnchorNode,this._templateId=t._templateId,t._targetAnchorPosition&&(this._targetAnchorPosition=Communicator.Point3.fromJson(t._targetAnchorPosition));let e=new a(null,this);for(e.fromJson(t.joints,t.version),this._rootJoint=e;;){if(0==e.getChildren().length){this._tipJoint=e;break}e=e.getChildren()[0]}for(let t in this._jointHash){let e=this._jointHash[t];e.getType()!=o.prismaticTriangle&&e.getType()!=o.prismaticAggregate&&e.getType()!=o.mate||(e.setExtraJoint1(this._jointHash[e.getExtraJoint1()]),e.setExtraJoint2(this._jointHash[e.getExtraJoint2()])),e.getType()==o.revoluteSlide||e.getType()==o.pistonController?e.setExtraJoint1(this._jointHash[e.getExtraJoint1()]):e.getType()==o.mapped&&(e._mappedTargetJoint=this._jointHash[e.getMappedTargetJoint()])}if(null!=t.animations)for(let e=0;e<t.animations.length;e++)ut.addAnimationTemplateFromJson(t.animations[e]._templateId,t.animations[e]);if(null!=t.animationGroups)for(let e=0;e<t.animationGroups.length;e++){let i=new lt(this);i.fromJson(t.animationGroups[e]),ut.addAnimationGroup(i)}return t}distanceFromTarget(){let t=this.getReferenceNodeNetMatrix(this._tipJoint).transform(this._ikTip);return Communicator.Point3.subtract(this._targetPoint,t).length()}resetJoints(){let t=this._rootJoint;for(;t.reset(),0!=t.getChildren().length;)t=t.getChildren()[0];this._interval&&(clear_interval(this._interval),this._interval=null)}createJoint(t,e,i,n){let r=!0;null!=i&&0==i&&(r=!1);let o=new a(t,this);this._jointHash[o.getId()]=o,o.initialize(e,r),null==t?this._rootJoint=o:n?t.getChildren().unshift(o):t.getChildren().push(o),this._tipJoint=this._findTipJoint();for(let t=0;t<e.length;t++)this._jointNodeidHash[e[t]]=o;return o}createJointFromSelection(t,e,i){let n=[],r=ut.viewer.selectionManager.getResults();for(let t=0;t<r.length;t++)n.push(r[t].getNodeId());let o=this.createJoint(t,n,e,i);return o.setParametersFromHandle(),o}async rebuildJointTree(){ut.viewer.model.deleteNode(this._rootJoint.getNodeId()),this._rebuildJointTreeRecursive(this._rootJoint)}applyToModel(t){this._jointNodeidHash=[];let e,i=ut.viewer.model.getNodeChildren(t)[0];e=t==ut.viewer.model.getRootNode()||null==t?new Communicator.Matrix:ut.viewer.model.getNodeMatrix(t),this._applyToModelRecursive(this._rootJoint,ut.viewer.model.getNodeIdOffset(i),e)}getReferenceNodeNetMatrix(t){return ut.viewer.model.getNodeNetMatrix(t.getNodeId())}_applyToModelRecursive(t,e,i){this._jointNodeidHash[t.getNodeId()]=t;let n=i.transform(Communicator.Point3.add(t.getCenter(),t.getAxis()));t.setCenter(i.transform(t.getCenter())),t.setAxis(Communicator.Point3.subtract(n,t.getCenter()).normalize()),t._parentMatrix=Communicator.Matrix.multiply(t.getParentMatrix(),i),t.fixedAxis&&(t.fixedAxis=i.transform(t.fixedAxis));let r=t.getReferenceNodes();for(let n=0;n<r.length;n++)r[n].nodeid=e+r[n].nodeid,r[n].matrix=Communicator.Matrix.multiply(r[n].matrix,i),this._jointNodeidHash[r[n].nodeid]=t;if(t.getChildren().length>0)for(let n=0;n<t.getChildren().length;n++)this._applyToModelRecursive(t.getChildren()[n],e,i)}_findTipJoint(){let t=this._rootJoint;for(;0!=t.getChildren().length;)t=t.getChildren()[0];return t}_rebuildJointTreeRecursive(t){if(t.getParent()?t.setNodeId(ut.viewer.model.createNode(t.getParent().getNodeId(),"joint")):t.setNodeId(ut.viewer.model.createNode(ut.viewer.model.getRootNode(),"_rootJoint")),t.getChildren().length>0)for(let e=0;e<t.getChildren().length;e++)this._rebuildJointTreeRecursive(t.getChildren()[e])}async _inverseKinematics(){let t=this._rootJoint;for(;;){if(t.getType()!=o.fixed&&null==t.fixedAxis&&t.getType()!=o.pistonController&&t.getType()!=o.prismaticAggregate){let e=await t.calculateGradient();await t.update(e)}if(t.getType()==o.prismaticAggregate){let e=await t.getExtraJoint1().calculateGradient();await t.getExtraJoint1().update(e),e=await t.getExtraJoint2().calculateGradient(),await t.getExtraJoint2().update(e)}if(0==t.getChildren().length||t.getType()==o.fixed&&t!=this._rootJoint)break;t=t.getChildren()[0]}await this._rootJoint.updateJointsFromReference()}}class mt{constructor(t){this._viewer=t,this._activeHighlight=null,this._currentSelItem=null,this.lastAxis=null,this.lastAxis2=null}insertHandles(t){let e=this._currentSelItem,i=e.getNodeId(),n=e.getFaceEntity(),r=e.getLineEntity();if(null!==r||null!=n){let o,a=this._viewer.selectionManager.getResults();if(a.length>0){o=[];for(let t=0;t<a.length;t++)o.push(a[t].getNodeId())}else o=[i];if(null!=r){let t=r.getPoints();if(2===t.length){let e=Communicator.Point3.subtract(t[1],t[0]);this.lastAxis=e.copy();let i=e.length(),n=t[0].copy().add(e.normalize().scale(i/2));this._addAxisTranslationHandle(n,e,o),this._addAxisTranslationHandle(n,e.copy().scale(-1),o),this._addAxisRotationHandle(n,e,o)}else this._getArcCenter(e).then((t=>{let e=this._viewer.model.getNodeNetMatrix(this._viewer.model.getNodeParent(i)),n=e.transform(new Communicator.Point3(0,0,0)),r=e.transform(t.normal),a=Communicator.Point3.cross(new Communicator.Point3(1,0,0),t.normal);a.length()<1e-5&&(a=Communicator.Point3.cross(new Communicator.Point3(0,1,0),t.normal));let s=e.transform(a),l=Communicator.Point3.subtract(r,n),h=Communicator.Point3.subtract(s,n);this.lastAxis=l.copy(),this.lastAxis2=h.copy();let c=t.center;this._addAxisTranslationHandle(c,l,o),this._addAxisTranslationHandle(c,l.copy().scale(-1),o),this._addAxisRotationHandle(c,l,o),this._addAxisTranslationHandle(c,h,o)}))}else{let e=n.getNormal(),i=(e.length(),n.getPosition().copy());if(i=n.getBounding().center().copy(),t)this._addMainHandle(o,i);else{let t=Communicator.Point3.cross(new Communicator.Point3(1,0,0),e);t.length()<1e-5&&(t=Communicator.Point3.cross(new Communicator.Point3(0,1,0),e)),this.lastAxis=e.copy(),this.lastAxis2=t.copy(),this._addAxisTranslationHandle(i,e,o),this._addAxisTranslationHandle(i,e.copy().scale(-1),o),this._addAxisRotationHandle(i,e,o),this._addAxisTranslationHandle(i,t,o)}}}}onMouseDown(t){if(t.shiftDown())return this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle).removeHandles(),t.controlDown()?(this._addAxisTranslationHandle(this._currentSelItem.getPosition(),new Communicator.Point3(0,0,1),[]),void t.setHandled(!0)):(this.insertHandles(t.altDown()),void t.setHandled(!0))}onMouseMove(t){if(t.shiftDown()){let e=t.getPosition(),i=this._viewer.view,n=new Communicator.PickConfig(Communicator.SelectionMask.Line);i.pickFromPoint(e,n).then((t=>{this._currentSelItem=t;let e=t.getNodeId();if(null!==e){if(this._viewer.model.getNodeType(e)!==Communicator.NodeType.BodyInstance)return;null!==this._activeHighlight?t.equals(this._activeHighlight)||(this._setNodeLineHighlighted(this._activeHighlight,!1),this._setNodeLineHighlighted(t,!0)):this._setNodeLineHighlighted(t,!0)}else null!==this._activeHighlight&&this._setNodeLineHighlighted(this._activeHighlight,!1)}))}else null!==this._activeHighlight&&this._setNodeLineHighlighted(this._activeHighlight,!1)}onMouseUp(t){t.shiftDown()&&t.setHandled(!0)}_setNodeLineHighlighted(t,e){if(null!==t){let i=t.getNodeId(),n=t.getLineEntity();if(null!==i&&null!==n){let r=n.getLineId();this._viewer.model._setNodeLineHighlighted(i,r,e),this._activeHighlight=e?t:null}}}_getArcCenter(t){let e=t.getNodeId(),i=t.getLineEntity();if(null!==e&&null!==i){let t=this._viewer.model;return t.getEdgeProperty(e,i.getLineId()).then((n=>{if(n instanceof Communicator.SubentityProperties.CircleElement){const i=n.origin;return t.getNodeNetMatrix(e).transform(i,i),{center:i,normal:n.normal}}if(n instanceof Communicator.SubentityProperties.LineElement){const t=i.getPoints();if(2===t.length)return Communicator.Point3.add(t[1],t[0]).scale(.5)}return null}))}return Promise.resolve(null)}_addMainHandle(t,e){let i=this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);i.addHandles(t,e),i.showHandles()}_addAxisRotationHandle(t,e,i,n){n||(n=Communicator.Color.red());let r=this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);r.addAxisRotationHandle(t,e,n),r.setNodeIds(i),r.showHandles()}_addAxisTranslationHandle(t,e,i,n){n||(n=Communicator.Color.red());let r=this._viewer.operatorManager.getOperator(Communicator.OperatorId.Handle);r.addAxisTranslationHandle(t.copy(),e,n),r.setNodeIds(i),r.showHandles()}}class ut{static initialize(t){ut.viewer=t,ut._hierachies=[],ut._hierachyTemplates=[],ut._animationTemplates=[],ut._animations=[],ut._animationGroups=[],ut.handlePlacementOperator=new mt(t);let e=t.operatorManager.registerCustomOperator(ut.handlePlacementOperator);t.operatorManager.push(e),ut.handleNode=t.model.createNode(t.model.getRootNode(),"handlenode")}static getHierachyTemplates(){return ut._hierachyTemplates}static getHierachies(){return ut._hierachies}static getAnimationTemplates(){return ut._animationTemplates}static getAnimationTemplate(t){return ut._animationTemplates[t]}static getAnimationGroups(){return ut._animationGroups}static getHierachyByIndex(t){return ut._hierachies[t]}static getJointFromNodeId(t){for(let e=0;e<ut._hierachies.length;e++){let i=ut._hierachies[e]._jointNodeidHash[t];if(null!=i)return i}return null}static findHierachyByNodeid(t){if(null!=t&&t!=ut.viewer.model.getRootNode())for(;ut.viewer.model.getNodeParent(t)!=ut.viewer.model.getRootNode();)t=ut.viewer.model.getNodeParent(t);for(let e=0;e<ut._hierachies.length;e++)if(ut._hierachies[e].nodeid==t)return e}static applyToModel(t,e){let i=new ct;return i.fromJson(ut._hierachyTemplates[t]),i.applyToModel(e),i.setNodeId(e),ut._hierachies.push(i),i}static createHierachy(t){let e=new ct;return this._hierachies.push(e),e}static getJointFromId(t,e){let i=t.getJointHash()[e];return null!=i?i:null}static addTemplate(t){return ut._hierachyTemplates[t._templateId]=t,t._templateId}static updateTemplate(t){ut._hierachyTemplates[t._templateId]=t}static getTemplate(t){return ut._hierachyTemplates[t]}static updateAnimationTemplate(t,e,i){let n=ut._animationTemplates[t];n.name=e,n.anime=i,ut._animationTemplates[t]=JSON.parse(JSON.stringify(n))}static addAnimationTemplate(t,e,i,r){let o={name:t,anime:e};o=JSON.parse(JSON.stringify(o));let a=n.generateGUID();return ut._animationTemplates[a]=o,a}static addAnimationTemplateFromJson(t,e){let i=JSON.parse(JSON.stringify(e));ut._animationTemplates[t]=i}static startAnimation(t,e){let i=new ht("test",t,JSON.parse(JSON.stringify(e)));ut._animations.push(i),1==ut._animations.length&&window.requestAnimationFrame(ut.doAnimation)}static stopAnimation(t){for(let e=0;e<ut._animations.length;e++)null!=t&&ut._animations[e].getJoint()!=t||ut._animations[e].setDone(!0)}static changeSpeed(t,e){for(let i=0;i<ut._animations.length;i++)ut._animations[i].joint==t&&ut._animations[i].changeSpeed(e)}static doAnimation(t){if(ut._animations.length>0){for(let t=0;t<ut._hierachies.length;t++)ut._hierachies[t].setDirty(!1);for(let e=0;e<ut._animations.length;e++)ut._animations[e].getJoint().getHierachy().setDirty(!0),ut._animations[e].update(t),ut._animations[e].getDone()&&(ut._animations.splice(e,1),e--);for(let t=0;t<ut._hierachies.length;t++)ut._hierachies[t].getDirty()&&ut._hierachies[t].updateJoints();window.requestAnimationFrame(ut.doAnimation)}}static deleteAnimationTemplate(t){delete ut._animationTemplates[t];for(let e=0;e<ut._hierachies.length;e++)ut._hierachies[e].removeAnimationFromJoints(t)}static addAnimationGroup(t){return ut._animationGroups.push(t),ut._animationGroups.length-1}static playAnimationGroup(t){ut._animationGroups[t].play()}}KM=e})();